<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî Morphe</title>

  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f97316">

  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/styles-shared.css">
  <link rel="stylesheet" href="/styles-header.css">
  <style>
    :root {
      --transition-fast: 0.2s ease;
      --transition-normal: 0.3s ease;
    }

    .session-header {
      text-align: center;
      margin-bottom: 1.2rem;
      padding: 1rem 0;
    }
    .session-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }
    .session-progress {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    .exercise-card {
      background: var(--bg-surface);
      border-radius: 18px;
      padding: 18px;
      margin-bottom: 18px;
      box-shadow: 0 3px 10px var(--shadow);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .exercise-number {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--accent);
      color: white;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.75rem;
    }

    .exercise-name {
      font-size: 1.25rem;
      font-weight: 700;
      margin: 0 0 10px 0;
      color: var(--text-primary);
    }

    .exercise-meta {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .meta-item {
      background: var(--bg-surface-alt);
      padding: 4px 10px;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    .meta-item.tempo { color: var(--accent); }

    .form-tips, .scientific-basis {
      background: var(--bg-surface-alt);
      padding: 8px;
      border-radius: 8px;
      margin: 8px 0;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    .form-tips small, .scientific-basis small {
      font-weight: 600;
      display: block;
      margin-bottom: 3px;
      color: var(--text-primary);
    }
    .form-tips ul {
      margin: 3px 0 0 14px;
      padding: 0;
      list-style: disc;
    }

    .comparison {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px;
      background: var(--bg-surface-alt);
      border-radius: 8px;
      margin: 10px 0;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    .comparison.up { color: var(--success); }
    .comparison.down { color: var(--warning); }

    .form-row {
      display: flex;
      gap: 12px;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    .form-group {
      flex: 1 1 140px;
      margin-bottom: 0;
    }
    label {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
      color: var(--text-primary);
    }
    .weight-input, .rir-select, .notes-input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg-input);
      font-size: 1rem;
      font-weight: 600;
    }
    .weight-input {
      font-size: 1.2rem;
      text-align: center;
    }
    .notes-input {
      min-height: 44px;
      padding: 8px;
      font-size: 0.95rem;
      font-weight: normal;
    }

    .rest-btn {
      width: 100%;
      padding: 12px;
      font-size: 1.05rem;
      font-weight: 600;
      border-radius: 12px;
      margin: 12px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .advice-box {
      background: var(--bg-surface-alt);
      border-left: 3px solid var(--accent);
      padding: 12px;
      border-radius: 0 8px 8px 0;
      margin-top: 12px;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    .advice-box strong { color: var(--text-primary); }

    /* === –¢–ê–ô–ú–ï–† –û–¢–î–´–•–ê === */
    .rest-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .rest-overlay.active {
      opacity: 1;
      pointer-events: all;
    }
    .timer-ring {
      width: 200px;
      height: 200px;
      position: relative;
      margin-bottom: 20px;
    }
    .timer-ring svg {
      transform: rotate(-90deg);
    }
    .timer-text {
      font-size: 3rem;
      font-weight: 800;
      color: white;
      text-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .timer-label {
      color: rgba(255,255,255,0.85);
      font-size: 1.2rem;
      margin-top: 10px;
    }
    .skip-rest-btn {
      background: rgba(255,255,255,0.15);
      color: white;
      border: none;
      padding: 8px 24px;
      border-radius: 50px;
      font-size: 1rem;
      margin-top: 16px;
      backdrop-filter: blur(6px);
    }
    .skip-rest-btn:hover {
      background: rgba(255,255,255,0.25);
    }

    /* === –ì–û–¢–û–í–ù–û–°–¢–¨ –ò –ö–ù–û–ü–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø === */
    .readiness-section {
      background: var(--bg-surface);
      border-radius: 18px;
      padding: 18px;
      margin: 1.2rem 0;
      box-shadow: 0 3px 10px var(--shadow);
    }
    .readiness-title {
      font-size: 1.2rem;
      margin: 0 0 14px 0;
      color: var(--text-primary);
    }

    .save-btn {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 14px;
      font-size: 1.1rem;
      font-weight: 700;
      border-radius: 0;
      z-index: 900;
      box-shadow: 0 -3px 16px rgba(0,0,0,0.12);
    }
    @media (min-width: 769px) {
      .save-btn {
        position: static;
        border-radius: 14px;
        margin: 1.2rem 0 2.5rem;
      }
    }

    @media (max-width: 768px) {
      .container { padding: 12px; }
      .exercise-card { padding: 14px; }
      .form-row { flex-direction: column; gap: 10px; }
      .form-group { flex: 1 1 100%; }
      .timer-text { font-size: 2.8rem; }
    }
  </style>
</head>
<body>

  <div id="header-placeholder"></div>

  <main id="main-content" tabindex="-1">
    <div class="container">
      <div class="session-header">
        <h1 class="session-title" id="sessionTitle">üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h1>
        <div class="session-progress" id="sessionProgress">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>

      <div id="exercisesContainer"></div>

      <section class="readiness-section" id="readinessSection" style="display: none;">
        <h2 class="readiness-title">üìä –ö–∞–∫ –ø—Ä–æ—à–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞?</h2>
        <div class="form-group">
          <label for="rpeInput">–ù–∞—Å–∫–æ–ª—å–∫–æ –±—ã–ª–æ —Ç—è–∂–µ–ª–æ? (RPE)</label>
          <select id="rpeInput" class="form-control">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
            <option value="5">5 ‚Äî –ª–µ–≥–∫–æ</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10 ‚Äî –º–∞–∫—Å–∏–º—É–º</option>
          </select>
        </div>
        <div class="form-group">
          <label for="domsInput">–ë–æ–ª—å –≤ –º—ã—à—Ü–∞—Ö?</label>
          <select id="domsInput" class="form-control">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
            <option value="1">1 ‚Äî –Ω–µ—Ç –±–æ–ª–∏</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 ‚Äî —Å–∏–ª—å–Ω–∞—è –±–æ–ª—å</option>
          </select>
        </div>
      </section>

      <button id="saveSession" class="btn-primary save-btn" style="display: none;">
        ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
      </button>
    </div>
  </main>

  <!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ç–∞–π–º–µ—Ä -->
  <div class="rest-overlay" id="restOverlay" role="timer" aria-live="polite">
    <div class="timer-ring" id="timerRing">
      <svg width="200" height="200">
        <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8"></circle>
        <circle cx="100" cy="100" r="90" fill="none" stroke="var(--accent)" stroke-width="8"
                stroke-dasharray="565" stroke-dashoffset="565" id="timerCircle"></circle>
      </svg>
    </div>
    <div class="timer-text" id="timerText">90</div>
    <div class="timer-label">–û—Ç–¥—ã—Ö</div>
    <button class="skip-rest-btn" id="skipRestBtn" type="button">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
  </div>

  <div id="footer-placeholder"></div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

  <script type="module">
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { WorkoutTracker } from '/modules/workoutTracker.js';
    import { DataService } from '/services/dataService.js';
    import { StorageManager } from '/utils/storage.js';

    let timerInterval = null;

    document.addEventListener('DOMContentLoaded', async () => {
      await HeaderController.loadHeader();
      new ThemeManager();

      const exercisesContainer = document.getElementById('exercisesContainer');
      const sessionProgress = document.getElementById('sessionProgress');
      const sessionTitle = document.getElementById('sessionTitle');
      const readinessSection = document.getElementById('readinessSection');
      const saveBtn = document.getElementById('saveSession');

      document.getElementById('skipRestBtn').addEventListener('click', () => {
        stopRestTimer();
      });

      try {
        const urlParams = new URLSearchParams(window.location.search);
        const programId = urlParams.get('id');
        const programName = urlParams.get('name');

        if (!programId || !programName) {
          sessionProgress.textContent = "‚ùå –ù–µ —É–∫–∞–∑–∞–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞";
          sessionProgress.className = 'error-text';
          return;
        }

        const { WorkoutPlanner } = await import('/core/workoutPlanner.js');
        const planner = new WorkoutPlanner();
        await planner.init();

        let program = planner.getCurrent();
        if (!program || !program.schedule?.length) {
          program = await planner.generate();
        }

        if (!program.schedule?.length) throw new Error("–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø—É—Å—Ç–∞");

        const todayIndex = new Date().getDay() % program.schedule.length;
        const session = program.schedule[todayIndex]?.session || program.schedule[0]?.session;
        if (!session?.exercises?.length) throw new Error("–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π");

        sessionTitle.textContent = session.name || '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';
        sessionProgress.textContent = `–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 1 –∏–∑ ${session.exercises.length}`;

        const exercisesData = await DataService.getExercises();
        const exerciseMap = Object.fromEntries(exercisesData.map(e => [e.id, e]));

        function getLastSessionForExercise(exId) {
          const keys = Object.keys(localStorage)
            .filter(k => k.startsWith('morphe-workout-'))
            .sort((a, b) => b.localeCompare(a));

          for (const key of keys) {
            const s = StorageManager.getItem(key);
            if (!s?.exercises) continue;
            const ex = s.exercises.find(e => e.id === exId);
            if (ex) return ex;
          }
          return null;
        }

        exercisesContainer.innerHTML = '';

        session.exercises.forEach((ex, index) => {
          const exercise = exerciseMap[ex.id] || { name: ex.name || '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ' };
          const last = getLastSessionForExercise(ex.id);

          // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ—à–ª—ã–º
          let comparisonHtml = '';
          if (last) {
            const weightDiff = parseFloat(ex.weight) - parseFloat(last.weight);
            const repsDiff = parseInt(ex.reps) - parseInt(last.reps);
            let trend = '', text = '';

            if (weightDiff > 0) {
              trend = 'up';
              text = `‚Üë ${weightDiff} –∫–≥`;
            } else if (weightDiff < 0) {
              trend = 'down';
              text = `‚Üì ${Math.abs(weightDiff)} –∫–≥`;
            } else if (repsDiff > 0) {
              trend = 'up';
              text = `‚Üë ${repsDiff} –ø–æ–≤—Ç.`;
            } else {
              text = '–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π';
            }

            comparisonHtml = `
              <div class="comparison ${trend}">
                üìå –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: ${last.weight || '?'} –∫–≥ √ó ${last.reps || '?'}
                ${text ? `<span style="margin-left:6px;">${text}</span>` : ''}
              </div>
            `;
          }

          // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
          const metaItems = [];
          metaItems.push(`<span class="meta-item">${ex.sets}√ó${ex.reps}</span>`);
          if (ex.tempo) metaItems.push(`<span class="meta-item tempo">‚è± ${ex.tempo}</span>`);
          if (ex.technique) metaItems.push(`<span class="meta-item">${ex.technique}</span>`);

          // –°–æ–≤–µ—Ç—ã –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ
          let formTipsHtml = '';
          if (exercise.formTips && exercise.formTips.length > 0) {
            formTipsHtml = `
              <div class="form-tips">
                <small>üìå –°–æ–≤–µ—Ç—ã –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ:</small>
                <ul>${exercise.formTips.map(tip => `<li>${tip}</li>`).join('')}</ul>
              </div>
            `;
          }

          // –ù–∞—É—á–Ω–∞—è –æ—Å–Ω–æ–≤–∞
          let scientificBasisHtml = '';
          if (exercise.scientificBasis?.progressionRule) {
            scientificBasisHtml = `
              <div class="scientific-basis">
                <small>üí° –ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è:</small>
                <p>${exercise.scientificBasis.progressionRule}</p>
              </div>
            `;
          }

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–ª–µ "–í–µ—Å"
          const showWeightInput = !['cardio', 'core', 'mobility', 'light'].includes(exercise.type);

          // –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞
          let formHtml = '';
          if (showWeightInput) {
            formHtml = `
              <div class="form-row">
                <div class="form-group">
                  <label>–í–µ—Å (–∫–≥)</label>
                  <input type="number" step="0.5" class="weight-input" data-id="${ex.id}" placeholder="0">
                </div>
                <div class="form-group">
                  <label>RIR</label>
                  <select class="rir-select" data-id="${ex.id}">
                    <option value="">?</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>–ó–∞–º–µ—Ç–∫–∏</label>
                <textarea class="notes-input" data-id="${ex.id}" placeholder="–ö–∞–∫ –ø—Ä–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏–∫–∞?"></textarea>
              </div>
            `;
          } else {
            formHtml = `
              <div class="form-group">
                <label>–ó–∞–º–µ—Ç–∫–∏ (–ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è, –≤—Ä–µ–º—è, –æ—â—É—â–µ–Ω–∏—è)</label>
                <textarea class="notes-input" data-id="${ex.id}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 45 —Å–µ–∫, –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"></textarea>
              </div>
            `;
          }

          const card = document.createElement('div');
          card.className = 'exercise-card';
          card.innerHTML = `
            <div class="exercise-number">${index + 1}</div>
            <h2 class="exercise-name">${exercise.name}</h2>
            <div class="exercise-meta">${metaItems.join('')}</div>
            ${formTipsHtml}
            ${scientificBasisHtml}
            ${comparisonHtml}
            ${formHtml}
            <button type="button" class="btn-primary rest-btn" data-rest="${ex.rest || 90}">
              ‚è± –û—Ç–¥—ã—Ö (${ex.rest || 90} —Å–µ–∫)
            </button>
            <div class="advice-placeholder" data-id="${ex.id}"></div>
          `;
          exercisesContainer.appendChild(card);
        });

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–≤–µ—Ç—ã –æ—Ç —Å–∏—Å—Ç–µ–º—ã
        try {
          const { StrengthProgress } = await import('/core/strengthProgress.js');
          const progressEngine = new StrengthProgress();

          session.exercises.forEach((ex, idx) => {
            const last = getLastSessionForExercise(ex.id);
            if (!last) return;

            const rm = progressEngine.calculateOneRepMax(last.weight, last.reps, last.rir);
            const ready = progressEngine.checkDoubleProgression(ex.id, last);

            const adviceLines = [];
            if (rm) adviceLines.push(`üìä 1–ü–ú: ~${Math.round(rm)} –∫–≥`);
            if (ready.ready) adviceLines.push(`‚úÖ –ì–æ—Ç–æ–≤—ã —É–≤–µ–ª–∏—á–∏—Ç—å –≤–µ—Å!`);

            if (adviceLines.length) {
              const placeholder = document.querySelector(`.advice-placeholder[data-id="${ex.id}"]`);
              if (placeholder) {
                placeholder.innerHTML = `<div class="advice-box">${adviceLines.join('<br>')}</div>`;
              }
            }
          });
        } catch (err) {
          console.warn('–°–æ–≤–µ—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã:', err.message);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ –æ—Ç–¥—ã—Ö–∞
        document.querySelectorAll('.rest-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const restSec = parseInt(e.target.dataset.rest) || 90;
            startRestTimer(restSec);
          });
        });

        // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        saveBtn.style.display = 'block';
        saveBtn.addEventListener('click', () => {
          const rpe = document.getElementById('rpeInput').value || null;
          const doms = document.getElementById('domsInput').value || null;

          const exercises = [];
          document.querySelectorAll('.weight-input').forEach(input => {
            const id = input.dataset.id;
            const weight = input.value;
            if (!weight) return;

            const rir = document.querySelector(`.rir-select[data-id="${id}"]`).value;
            const notes = document.querySelector(`.notes-input[data-id="${id}"]`).value;

            exercises.push({
              id,
              weight: parseFloat(weight),
              rir: rir || null,
              notes: notes || null
            });
          });

          // –î–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –±–µ–∑ –≤–µ—Å–∞ ‚Äî –±–µ—Ä—ë–º –∑–∞–º–µ—Ç–∫–∏
          document.querySelectorAll('.notes-input').forEach(textarea => {
            const id = textarea.dataset.id;
            const notes = textarea.value;
            if (notes && !exercises.some(e => e.id === id)) {
              exercises.push({ id, weight: null, rir: null, notes });
            }
          });

          if (exercises.length === 0) {
            alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Ö–æ—Ç—è –±—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è');
            return;
          }

          const tracker = new WorkoutTracker();
          tracker.logSession({
            programId,
            programName: session.name || programName,
            date: new Date().toISOString(),
            rpe,
            doms,
            exercises
          });

          alert('‚úÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
          window.location.href = '/index.html';
        });

        readinessSection.style.display = 'block';

      } catch (err) {
        console.error(err);
        document.getElementById('sessionProgress').textContent = `‚ùå ${err.message}`;
        document.getElementById('sessionProgress').className = 'error-text';
      }
    });

    function startRestTimer(duration) {
      const overlay = document.getElementById('restOverlay');
      const timerText = document.getElementById('timerText');
      const circle = document.getElementById('timerCircle');
      const total = 2 * Math.PI * 90;

      let time = duration;
      timerText.textContent = time;
      circle.style.strokeDasharray = total;
      circle.style.strokeDashoffset = total;

      overlay.classList.add('active');

      if (timerInterval) clearInterval(timerInterval);

      timerInterval = setInterval(() => {
        time--;
        timerText.textContent = time;
        const offset = total * (time / duration);
        circle.style.strokeDashoffset = offset;

        if (time <= 0) {
          stopRestTimer();
          if ('vibrate' in navigator) navigator.vibrate([200, 100, 200]);
          alert('–í—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞ –æ–∫–æ–Ω—á–µ–Ω–æ! üí™');
        }
      }, 1000);
    }

    function stopRestTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      document.getElementById('restOverlay').classList.remove('active');
    }

    document.addEventListener('DOMContentLoaded', () => {
      import('/core/HeaderController.js')
        .then(m => m.HeaderController.loadFooter())
        .catch(console.error);
    });
  </script>
</body>
</html>