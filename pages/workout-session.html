<!-- /pages/workout-session.html -->
<!-- v3.0.0 ‚Äî –†–µ–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –∏–∑ WorkoutPlanner -->

<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî Morphe</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">

  <!-- –°—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/styles-shared.css">

  <style>
    /* –¢–∞–π–º–µ—Ä */
    .timer-display {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      padding: 20px;
      background: var(--bg-surface-alt);
      border-radius: 16px;
      margin: 24px 0;
      border: 2px dashed var(--accent);
    }

    /* –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ */
    .exercise-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .exercise-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 16px;
    }

    .exercise-header h3 {
      margin: 0;
      font-size: 1.2rem;
    }

    .form-row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .exercise-advice {
      margin-top: 16px;
      padding: 16px;
      background-color: var(--bg-surface-alt);
      border-radius: 12px;
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.5;
      border-left: 4px solid var(--accent);
    }

    /* –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ—à–ª–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π */
    .comparison {
      margin-top: 16px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #666;
    }

    /* –¢–µ—Ö–Ω–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è */
    .technique-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      background: var(--accent);
      color: white;
      margin-left: 8px;
    }
  </style>
</head>
<body>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ —à–∞–ø–∫–∏ -->
  <div id="header-placeholder"></div>

  <main id="main-content">
    <div class="container">
      <h1>üí™ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h1>
      <p id="sessionStatus">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–Ω–∞...</p>

      <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≥—Ä–∞–º–º–µ -->
      <section class="card" id="programInfo" style="display: none;">
        <h2 id="programName">‚Äî</h2>
        <p><strong>–¶–µ–ª—å:</strong> <span id="programGoal">‚Äî</span></p>
        <p><strong>–£—Ä–æ–≤–µ–Ω—å:</strong> <span id="programLevel">‚Äî</span></p>
        <p><strong>–§–æ–∫—É—Å:</strong> <span id="programFocus">‚Äî</span></p>
      </section>

      <!-- –û—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ -->
      <section class="card" id="readinessSection" style="display: none;">
        <h2>üìä –í–∞—à–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å</h2>
        <div class="form-group">
          <label for="rpeInput">–û–±—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (RPE):</label>
          <select id="rpeInput" class="form-control">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
            <option value="5">5 ‚Äî –ª–µ–≥–∫–æ</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10 ‚Äî –º–∞–∫—Å–∏–º—É–º</option>
          </select>
        </div>
        <div class="form-group">
          <label for="domsInput">–ë–æ–ª—å –≤ –º—ã—à—Ü–∞—Ö (DOMS):</label>
          <select id="domsInput" class="form-control">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
            <option value="1">1 ‚Äî –Ω–µ—Ç –±–æ–ª–∏</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 ‚Äî —Å–∏–ª—å–Ω–∞—è –±–æ–ª—å</option>
          </select>
        </div>
      </section>

      <!-- –°–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π -->
      <div id="exercisesContainer"></div>

      <!-- –¢–∞–π–º–µ—Ä –æ—Ç–¥—ã—Ö–∞ -->
      <div class="timer-display" id="timerDisplay" style="display: none;">
        ‚è± –û—Ç–¥—ã—Ö: <strong id="timer">90</strong> —Å–µ–∫
      </div>

      <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
      <button id="saveSession" class="btn-primary btn-large" style="margin: 2rem 0 4rem;">
        ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
      </button>
    </div>
  </main>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ –ø–æ–¥–≤–∞–ª–∞ -->
  <div id="footer-placeholder"></div>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

  <!-- –õ–æ–≥–∏–∫–∞ -->
  <script type="module">
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { WorkoutTracker } from '/modules/workoutTracker.js';
    import { DataService } from '/services/dataService.js';
    import { StorageManager } from '/utils/storage.js';

    document.addEventListener('DOMContentLoaded', async () => {
      await HeaderController.loadHeader();
      new ThemeManager();

      const sessionStatus = document.getElementById('sessionStatus');
      const programInfo = document.getElementById('programInfo');
      const readinessSection = document.getElementById('readinessSection');
      const exercisesContainer = document.getElementById('exercisesContainer');

      try {
        // === –ü–æ–ª—É—á–∞–µ–º ID –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏–∑ URL ===
        const urlParams = new URLSearchParams(window.location.search);
        const programId = urlParams.get('id');
        const programName = urlParams.get('name');

        if (!programId || !programName) {
          sessionStatus.textContent = "‚ùå –ù–µ —É–∫–∞–∑–∞–Ω ID –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã.";
          sessionStatus.className = 'error-text';
          return;
        }

        // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WorkoutPlanner ===
        const { WorkoutPlanner } = await import('../core/workoutPlanner.js');
        const planner = new WorkoutPlanner();
        await planner.init();

        // === –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ ID ===
        let program = planner.getCurrent();

        // ‚úÖ –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–µ—Ç –ò–õ–ò –Ω–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—É—é
        if (!program || !program.schedule || program.schedule.length === 0) {
          sessionStatus.textContent = "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã...";
          program = await planner.generate();
        }

        // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ schedule —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç
        if (!program.schedule || program.schedule.length === 0) {
          throw new Error("–ü—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫");
        }

        // === –ù–∞—Ö–æ–¥–∏–º —Å–µ—Å—Å–∏—é –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è (–∏–ª–∏ –ø–µ—Ä–≤—É—é) ===
        let session = program.schedule[0].session;

        // –ú–æ–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å: –±—Ä–∞—Ç—å –ø–æ –¥–Ω—é –Ω–µ–¥–µ–ª–∏
        const dayOfWeek = new Date().getDay(); // 0-6
        const todayIndex = dayOfWeek % program.schedule.length;
        if (program.schedule[todayIndex] && program.schedule[todayIndex].session) {
          session = program.schedule[todayIndex].session;
        }

        if (!session) {
          throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—É—é —Å–µ—Å—Å–∏—é –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ");
        }

        // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É —Å–µ—Å—Å–∏–∏ –µ—Å—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        if (!session.exercises || session.exercises.length === 0) {
          throw new Error("–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–∞—è —Å–µ—Å—Å–∏—è –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π");
        }

        // === –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π ===
        const exercisesData = await DataService.getExercises();
        const exerciseMap = Object.fromEntries(exercisesData.map(e => [e.id, e]));

        // === –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–≥—Ä–∞–º–º–µ ===
        document.getElementById('programName').textContent = program.name || programName;
        document.getElementById('programGoal').textContent = program.goal || '‚Äî';
        document.getElementById('programLevel').textContent = program.level || '‚Äî';
        document.getElementById('programFocus').textContent = session.focus || '‚Äî';

        programInfo.style.display = 'block';
        readinessSection.style.display = 'block';
        sessionStatus.style.display = 'none';

        // === –§—É–Ω–∫—Ü–∏—è: –ø–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–µ—Å—Å–∏—é –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è ===
        function getLastSessionForExercise(exId) {
          const keys = Object.keys(localStorage).filter(k => k.startsWith('morphe-workout-'));
          keys.sort((a, b) => b.localeCompare(a));

          for (const key of keys) {
            const session = StorageManager.getItem(key);
            if (!session?.exercises) continue;

            const exRecord = session.exercises.find(e => e.id === exId);
            if (exRecord) {
              return {
                weight: typeof exRecord.weight === 'number' ? exRecord.weight : 0,
                reps: typeof exRecord.reps === 'number' ? exRecord.reps : 10,
                rir: exRecord.rir ?? '?',
                notes: exRecord.notes || ''
              };
            }
          }

          return null;
        }

        // === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π —Å–µ—Å—Å–∏–∏ ===
        let timerInterval = null;

        session.exercises.forEach(ex => {
          const exercise = exerciseMap[ex.id] || { name: ex.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ' };
          const restSec = ex.rest || 90;

          const exerciseEl = document.createElement('div');
          exerciseEl.className = 'exercise-card';

          const lastSession = getLastSessionForExercise(ex.id);
          let comparisonHtml = '';
          if (lastSession) {
            comparisonHtml = `
              <div class="comparison">
                üìå –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: ${lastSession.weight} –∫–≥ √ó ${lastSession.reps}, RIR ${lastSession.rir}${
                  lastSession.notes ? ` (${lastSession.notes})` : ''
                }
              </div>
            `;
          }

          // –¢–µ—Ö–Ω–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
          const techniqueTag = ex.technique ? 
            `<span class="technique-tag">${ex.technique}</span>` : '';

          exerciseEl.innerHTML = `
            <div class="exercise-header">
              <h3>${exercise.name}</h3>
              <span class="pill">${ex.sets}√ó${ex.reps}${techniqueTag}</span>
            </div>
            ${ex.tempo ? `<p><small>‚è± –¢–µ–º–ø: ${ex.tempo}</small></p>` : ''}
            ${exercise.scientificBasis?.progressionRule ? 
              `<p><small>üí° ${exercise.scientificBasis.progressionRule}</small></p>` : ''
            }
            <div class="form-row">
              <div class="form-group">
                <label>–í–µ—Å (–∫–≥)</label>
                <input type="number" step="0.5" class="weight-input form-control" data-id="${ex.id}" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 80">
              </div>
              <div class="form-group">
                <label>RIR</label>
                <select class="rir-select form-control" data-id="${ex.id}">
                  <option value=""></option>
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>–ó–∞–º–µ—Ç–∫–∏</label>
              <textarea class="notes-input form-control" data-id="${ex.id}" rows="1" placeholder="–ö–∞–∫ –ø—Ä–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏–∫–∞?"></textarea>
            </div>
            <button 
              onclick="startRest(${restSec})"
              class="btn-outline btn-small">
              ‚è± –ù–∞—á–∞—Ç—å –æ—Ç–¥—ã—Ö (${restSec} —Å–µ–∫)
            </button>
            ${comparisonHtml}
          `;
          exercisesContainer.appendChild(exerciseEl);
        });

        // === –¢–∞–π–º–µ—Ä –æ—Ç–¥—ã—Ö–∞ ===
        window.startRest = function(duration) {
          const timerEl = document.getElementById('timer');
          const display = document.getElementById('timerDisplay');

          if (timerInterval) clearInterval(timerInterval);

          let time = duration;
          timerEl.textContent = time;
          display.style.display = 'block';

          timerInterval = setInterval(() => {
            time--;
            timerEl.textContent = time;
            if (time <= 0) {
              clearInterval(timerInterval);
              display.style.display = 'none';
              alert("–û—Ç–¥—ã—Ö –∑–∞–≤–µ—Ä—à—ë–Ω! –ì–æ—Ç–æ–≤—ã –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ–¥—Ö–æ–¥—É.");
            }
          }, 1000);
        };

        // === –°–∏–ª–æ–≤—ã–µ —Å–æ–≤–µ—Ç—ã ===
        try {
          const { StrengthProgress } = await import('../core/strengthProgress.js');
          const progressEngine = new StrengthProgress();

          document.querySelectorAll('.exercise-card').forEach(card => {
            const input = card.querySelector('.weight-input');
            if (!input) return;

            const exId = input.dataset.id;
            const lastSession = getLastSessionForExercise(exId);
            if (!lastSession) return;

            const rmEstimate = progressEngine.calculateOneRepMax(lastSession.weight, lastSession.reps);
            const doubleProgressReady = progressEngine.checkDoubleProgression(exId, lastSession);

            const adviceLines = [];
            if (rmEstimate) {
              adviceLines.push(`üìä –í–∞—à 1–ü–ú: ~${Math.round(rmEstimate)} –∫–≥`);
            }
            if (doubleProgressReady.ready) {
              adviceLines.push(`‚úÖ –ì–æ—Ç–æ–≤—ã –∫ —É–≤–µ–ª–∏—á–µ–Ω–∏—é –≤–µ—Å–∞!`);
            }

            if (adviceLines.length > 0) {
              const adviceEl = document.createElement('div');
              adviceEl.className = 'exercise-advice';
              adviceEl.innerHTML = adviceLines.map(line => `<small>${line}</small><br>`).join('');

              const timerButton = card.querySelector('button[onclick^="startRest"]');
              if (timerButton) {
                timerButton.insertAdjacentElement('afterend', adviceEl);
              } else {
                card.appendChild(adviceEl);
              }
            }
          });

        } catch (err) {
          console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥—É–ª—å strengthProgress:', err.message);
        }

        // === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ ===
        document.getElementById('saveSession').addEventListener('click', () => {
          const sessionData = {
            programId,
            programName: program.name || programName,
            date: new Date().toISOString(),
            rpe: document.getElementById('rpeInput').value || null,
            doms: document.getElementById('domsInput').value || null,
            exercises: []
          };

          document.querySelectorAll('.weight-input').forEach(input => {
            const id = input.dataset.id;
            const weight = input.value;
            const rir = document.querySelector(`.rir-select[data-id="${id}"]`).value;
            const notes = document.querySelector(`.notes-input[data-id="${id}"]`).value;

            if (weight) {
              sessionData.exercises.push({ 
                id, 
                weight: parseFloat(weight), 
                rir, 
                notes 
              });
            }
          });

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—É—é —Å–µ—Å—Å–∏—é –≤ WorkoutTracker
          const tracker = new WorkoutTracker();
          tracker.logSession(sessionData);

          alert("‚úÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
          window.location.href = '/index.html';
        });

      } catch (err) {
        sessionStatus.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
        sessionStatus.className = 'error-text';
        console.error(err);
      }
    });

    // –ü–æ–¥–≤–∞–ª
    document.addEventListener('DOMContentLoaded', () => {
      import('/core/HeaderController.js')
        .then(m => m.HeaderController.loadFooter())
        .catch(err => console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–≤–∞–ª–∞:', err));
    });
  </script>
</body>
</html>