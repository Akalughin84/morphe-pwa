<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî Morphe</title>

  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f97316">

  <!-- –ë–∞–∑–∞ -->
  <link rel="stylesheet" href="/styles/base/reset.css">
  <link rel="stylesheet" href="/styles/base/theme.css">
  <link rel="stylesheet" href="/styles/base/typography.css">
  <link rel="stylesheet" href="/styles/base/utilities.css">

  <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -->
  <link rel="stylesheet" href="/styles/components/buttons.css">
  <link rel="stylesheet" href="/styles/components/cards.css">
  <link rel="stylesheet" href="/styles/components/forms.css">
  <link rel="stylesheet" href="/styles/components/tabs.css">
  <link rel="stylesheet" href="/styles/components/mobile-menu.css">

  <!-- –ú–∞–∫–µ—Ç -->
  <link rel="stylesheet" href="/styles/layout/header.css">
  <link rel="stylesheet" href="/styles/layout/footer.css">
  <link rel="stylesheet" href="/styles/layout/scroll-top.css">

  <!-- –°—Ç–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
  <link rel="stylesheet" href="/styles/pages/workout-session.css">
</head>
<body>

  <div id="header-placeholder"></div>

  <main id="main-content" tabindex="-1">
    <div class="container">
      <div class="week-selector" id="weekSelector" style="display:none;"></div>
      <div class="session-header">
        <h1 class="session-title" id="sessionTitle">üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h1>
        <div class="session-progress" id="sessionProgress">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="session-progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
      </div>

      <div class="workout-container">
        <div class="exercise-list"></div>
      </div>

      <section class="readiness-section" id="readinessSection">
        <h2 class="readiness-title">üìä –ö–∞–∫ –ø—Ä–æ—à–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞?</h2>
        <div class="workout-form-group">
          <label for="rpeInput">–ù–∞—Å–∫–æ–ª—å–∫–æ –±—ã–ª–æ —Ç—è–∂–µ–ª–æ? (RPE)</label>
          <select id="rpeInput" class="form-control">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
            <option value="5">5 ‚Äî –ª–µ–≥–∫–æ: –º–æ–≥ –±—ã –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –µ—â—ë –¥–æ–ª–≥–æ</option>
            <option value="6">6 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–æ –ª–µ–≥–∫–æ: –ª—ë–≥–∫–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, –¥—ã—Ö–∞–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ</option>
            <option value="7">7 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–æ —Ç—è–∂–µ–ª–æ: –¥—ã—Ö–∞–Ω–∏–µ —É—á–∞—â–µ–Ω–æ, –Ω–æ —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å –º–æ–∂–Ω–æ</option>
            <option value="8">8 ‚Äî —Ç—è–∂–µ–ª–æ: –¥—ã—Ö–∞–Ω–∏–µ –≥–ª—É–±–æ–∫–æ–µ, —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å —Ç—Ä—É–¥–Ω–æ</option>
            <option value="9">9 ‚Äî –æ—á–µ–Ω—å —Ç—è–∂–µ–ª–æ: –ø–æ—á—Ç–∏ –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ, —Ö–æ—á–µ—Ç—Å—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è</option>
            <option value="10">10 ‚Äî –º–∞–∫—Å–∏–º—É–º: –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å, –ø–æ–ª–Ω–æ–µ –∏—Å—Ç–æ—â–µ–Ω–∏–µ</option>
          </select>
        </div>
        <div class="workout-form-group">
          <label for="domsInput">–ë–æ–ª—å –≤ –º—ã—à—Ü–∞—Ö?</label>
          <select id="domsInput" class="form-control">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
            <option value="1">1 ‚Äî –Ω–µ—Ç –±–æ–ª–∏: –º—ã—à—Ü—ã –Ω–µ –±–µ—Å–ø–æ–∫–æ—è—Ç</option>
            <option value="2">2 ‚Äî –ª—ë–≥–∫–∞—è —Å–∫–æ–≤–∞–Ω–Ω–æ—Å—Ç—å: —á—É–≤—Å—Ç–≤—É–µ—Ç—Å—è –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏</option>
            <option value="3">3 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è –±–æ–ª—å: –æ—â—É—â–∞–µ—Ç—Å—è –≤ –ø–æ–∫–æ–µ, –Ω–æ –Ω–µ –º–µ—à–∞–µ—Ç</option>
            <option value="4">4 ‚Äî —Å–∏–ª—å–Ω–∞—è –±–æ–ª—å: –º–µ—à–∞–µ—Ç –æ–±—ã—á–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</option>
            <option value="5">5 ‚Äî –æ—á–µ–Ω—å —Å–∏–ª—å–Ω–∞—è –±–æ–ª—å: —Ç—Ä—É–¥–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è, –Ω—É–∂–µ–Ω –æ—Ç–¥—ã—Ö</option>
          </select>
        </div>
      </section>

      <button id="saveSession" class="btn-primary save-btn" style="display: none;">
        ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
      </button>
    </div>
  </main>

  <!-- <div class="rest-overlay" id="restOverlay" role="timer" aria-live="polite">
    <div class="timer-ring" id="timerRing">
      <svg width="200" height="200">
        <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8"></circle>
        <circle cx="100" cy="100" r="90" fill="none" stroke="var(--accent)" stroke-width="8"
                stroke-dasharray="565" stroke-dashoffset="565" id="timerCircle"></circle>
      </svg>
    </div>
    <div class="timer-text" id="timerText">90</div>
    <div class="timer-label">–û—Ç–¥—ã—Ö</div>
    <button class="skip-rest-btn" id="skipRestBtn" type="button">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
  </div> -->

  <div id="footer-placeholder"></div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

  <script type="module">
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { WorkoutTracker } from '/modules/workoutTracker.js';
    import { DataService } from '/services/dataService.js';
    import { StorageManager } from '/utils/storage.js';
    import { UserService } from '/services/userService.js';

    document.addEventListener('DOMContentLoaded', async () => {
      let timerInterval = null;
      let hasUnsavedChanges = false;
      const aiAdviceCache = new Map();
      let session = null;
      let exerciseMap = {};
      let profile = null;
      let isDataLoaded = false;
      let activeDetails = null;
      let programId = null;
      let programName = null;

      // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

      function getLastSessionForExercise(exId) {
        const keys = Object.keys(localStorage)
          .filter(k => k.startsWith('morphe-workout-'))
          .sort((a, b) => b.localeCompare(a));
        for (const key of keys) {
          const s = StorageManager.getItem(key);
          if (!s?.exercises) continue;
          const ex = s.exercises.find(e => e.id === exId);
          if (ex) return ex;
        }
        return null;
      }

      let currentRestInterval = null;

      function startRestTimerLocal(duration, displayElement, exerciseIndex, setsElement) {
        let time = duration;
        let setsCompleted = parseInt(setsElement.textContent.split('/')[0]) || 0;
        const totalSets = session.exercises[exerciseIndex].sets;
        displayElement.textContent = time;
        if (currentRestInterval) clearInterval(currentRestInterval);
        currentRestInterval = setInterval(() => {
          time--;
          displayElement.textContent = time;
          if (time <= 0) {
            stopRestTimerLocal();
            if ('vibrate' in navigator) navigator.vibrate([200, 100, 200]);
            setsCompleted++;
            if (setsElement) {
              setsElement.innerHTML = `<span>${setsCompleted}/${totalSets}</span><small>–ü–æ–¥—Ö–æ–¥–æ–≤</small>`;
            }
            if (setsCompleted < totalSets) {
              alert('–í—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞ –æ–∫–æ–Ω—á–µ–Ω–æ! üí™');
            } else {
              alert('–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–¥—Ö–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω! –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üéâ');
            }
          }
        }, 1000);
      }

      function stopRestTimerLocal() {
        if (currentRestInterval) {
          clearInterval(currentRestInterval);
          currentRestInterval = null;
        }
      }

      // function startRestTimer(duration) {
      //   const overlay = document.getElementById('restOverlay');
      //   const timerText = document.getElementById('timerText');
      //   const circle = document.getElementById('timerCircle');
      //   const total = 2 * Math.PI * 90;
      //   let time = duration;
      //   timerText.textContent = time;
      //   circle.style.strokeDasharray = total;
      //   circle.style.strokeDashoffset = total;
      //   overlay.classList.add('active');
      //   if (timerInterval) clearInterval(timerInterval);
      //   timerInterval = setInterval(() => {
      //     time--;
      //     timerText.textContent = time;
      //     const offset = total * (time / duration);
      //     circle.style.strokeDashoffset = offset;
      //     if (time <= 0) {
      //       stopRestTimer();
      //       if ('vibrate' in navigator) navigator.vibrate([200, 100, 200]);
      //       alert('–í—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞ –æ–∫–æ–Ω—á–µ–Ω–æ! üí™');
      //     }
      //   }, 1000);
      // }

      // function stopRestTimer() {
      //   if (timerInterval) {
      //     clearInterval(timerInterval);
      //     timerInterval = null;
      //   }
      //   document.getElementById('restOverlay').classList.remove('active');
      // }

      async function generateExerciseAdvice(exerciseConfig, exerciseData, profile, card) {
        const placeholder = card.querySelector('.advice-placeholder');
        if (!placeholder) return;
        const cacheKey = `advice-${exerciseConfig.id}-${profile?.injuries?.join(',') || 'none'}`;
        if (aiAdviceCache.has(cacheKey)) {
          placeholder.innerHTML = aiAdviceCache.get(cacheKey);
          return;
        }
        try {
          const { AIAssistant } = await import('/core/aiAssistant.js');
          const ai = new AIAssistant();
          let focus = 'full';
          if (exerciseData.muscleGroup) {
            const muscleToFocus = { legs: 'legs', chest: 'push', back: 'pull', shoulders: 'push', arms: 'pull', abs: 'core' };
            focus = muscleToFocus[exerciseData.muscleGroup] || 'full';
          }
          const advice = ai.generateWarmupAdvice(focus, {
            injuries: profile?.injuries || [],
            level: profile?.level || 'beginner',
            workoutLocation: profile?.workoutLocation || 'gym'
          });

          let shouldShow = true;
          if (exerciseData.contraindications?.length && profile?.injuries?.length) {
            const hasConflict = exerciseData.contraindications.some(c => profile.injuries.includes(c));
            if (hasConflict) shouldShow = false;
          }

          if (!shouldShow) {
            aiAdviceCache.set(cacheKey, '');
            placeholder.innerHTML = '';
            return;
          }

          const adviceHtml = `
            <div class="exercise-advice">
              <strong>${advice.title}</strong>
              <p>${advice.message}</p>
              <div class="ai-actions">
                <button class="btn-sm btn-outline" data-reaction="accepted">–ü–æ–ª–µ–∑–Ω–æ</button>
                <button class="btn-sm btn-outline" data-reaction="not_helpful">–ù–µ –Ω—É–∂–Ω–æ</button>
              </div>
            </div>
          `;
          placeholder.innerHTML = adviceHtml;
          aiAdviceCache.set(cacheKey, adviceHtml);
          placeholder.querySelectorAll('.ai-actions button').forEach(btn => {
            btn.addEventListener('click', () => {
              ai.recordAdviceFeedback(advice.id, btn.dataset.reaction);
              placeholder.innerHTML = '<p class="info-text">–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!</p>';
            });
          });
        } catch (e) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ–≤–µ—Ç –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:', e);
          placeholder.innerHTML = '';
        }
      }

      async function showPostWorkoutAdvice(session, profile) {
        const intensity = session.exercises.filter(e => e.weight).length > 3 ? 'high' : 'moderate';
        const userAllergies = profile?.allergies || [];
        let mealAdvice = '–ë–µ–ª–∫–æ–≤—ã–π –ø–µ—Ä–µ–∫—É—Å (—Ç–≤–æ—Ä–æ–≥, —è–π—Ü–∞, –∫—É—Ä–∏—Ü–∞)';
        let supplementAdvice = '';
        let extraAdvice = '';
        try {
          const { DataService } = await import('/services/dataService.js');
          const allFoods = await DataService.getFoods();
          const safeFoods = allFoods.filter(food => {
            if (!food.allergens || food.allergens.length === 0) return true;
            return !food.allergens.some(a => userAllergies.includes(a));
          });
          const postWorkoutOptions = safeFoods.filter(f => f.tags?.includes('post-workout') || (f.protein >= 20));
          if (postWorkoutOptions.length > 0) {
            mealAdvice = `${postWorkoutOptions[0].name} (${postWorkoutOptions[0].protein} –≥ –±–µ–ª–∫–∞)`;
          } else if (userAllergies.length > 0) {
            mealAdvice = '–ë–µ–ª–∫–æ–≤—ã–π –ø–µ—Ä–µ–∫—É—Å –±–µ–∑ –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤ (—Ä–∏—Å, —á–µ—á–µ–≤–∏—Ü–∞, –∫—É—Ä–∏—Ü–∞)';
          }
        } catch (e) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã:', e);
        }
        if (profile?.goal === 'lose' || profile?.workoutType === 'cardio') {
          supplementAdvice = '<li>üíä –û–º–µ–≥–∞-3: 1‚Äì2 –≥ –≤ –¥–µ–Ω—å —Å –µ–¥–æ–π</li>';
        } else if (profile?.goal === 'gain') {
          supplementAdvice = '<li>üíä –ö—Ä–µ–∞—Ç–∏–Ω: 3‚Äì5 –≥ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</li>';
        }
        if (profile?.smoking && profile.smoking !== 'no') {
          extraAdvice += '<li>üçä –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –≤–∏—Ç–∞–º–∏–Ω C (–∞–ø–µ–ª—å—Å–∏–Ω, –±–æ–ª–≥–∞—Ä—Å–∫–∏–π –ø–µ—Ä–µ—Ü)</li>';
        }
        if (profile?.alcohol && profile.alcohol !== 'none') {
          extraAdvice += '<li>üíß +500 –º–ª –≤–æ–¥—ã ‚Äî –∞–ª–∫–æ–≥–æ–ª—å –æ–±–µ–∑–≤–æ–∂–∏–≤–∞–µ—Ç</li>';
        }
        if (profile?.hemoglobin !== null && profile.hemoglobin < 120) {
          extraAdvice += '<li>ü©∏ –û—Ç–¥—ã—Ö–∞–π —Å–µ–≥–æ–¥–Ω—è ‚Äî –Ω–∏–∑–∫–∏–π –≥–µ–º–æ–≥–ª–æ–±–∏–Ω —Å–Ω–∏–∂–∞–µ—Ç –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å</li>';
        }
        if (profile?.vitaminD !== null && profile.vitaminD < 20) {
          extraAdvice += '<li>‚òÄÔ∏è –ü—Ä–∏–º–∏ –≤–∏—Ç–∞–º–∏–Ω D (2000‚Äì4000 –ú–ï) —Å –∂–∏—Ä–Ω–æ–π –ø–∏—â–µ–π</li>';
        }
        const adviceHtml = `
          <div class="exercise-card" style="background:#f0fdf4; border-left:4px solid #10b981; margin-top:24px;">
            <h3 style="margin-top:0;">üî• –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!</h3>
            <ul style="text-align:left; margin:12px 0; padding-left:20px;">
              <li>üíß –í—ã–ø–µ–π <strong>500 –º–ª –≤–æ–¥—ã</strong></li>
              <li>üöø ${intensity === 'high' ? '–ü—Ä–∏–º–∏ –¥—É—à' : '–£–º–æ–π—Å—è'}</li>
              <li>üçó –ß–µ—Ä–µ–∑ 30‚Äì45 –º–∏–Ω: ${mealAdvice}</li>
              ${supplementAdvice}
              ${extraAdvice}
            </ul>
          </div>
        `;

        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º .workout-container –≤–º–µ—Å—Ç–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ #exercisesContainer
        const workoutContainer = document.querySelector('.workout-container');
        if (workoutContainer) {
          workoutContainer.insertAdjacentHTML('beforeend', adviceHtml);
        } else {
          console.warn('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä .workout-container –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–≤–µ—Ç–∞.');
        }
      }

      function closeAllDetails() {
        if (activeDetails) {
          activeDetails.classList.remove('active');
          activeDetails = null;
        }
      }

      function renderPlanView() {
        const exerciseList = document.querySelector('.exercise-list');
        exerciseList.innerHTML = '';
        session.exercises.forEach((ex, index) => {
          const exercise = exerciseMap[ex.id] || { name: ex.name || '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ' };
          const metaItems = [];
          if (ex.type === 'warmup' || ex.type === 'stretch') {
            metaItems.push(`${ex.duration || ex.reps} –º–∏–Ω`);
          } else {
            metaItems.push(`${ex.sets}√ó${ex.reps}`);
            if (ex.tempo) metaItems.push(`‚è± ${ex.tempo}`);
          }

          const item = document.createElement('div');
          item.className = 'exercise-item';
          const imgSrc = exercise.posterUrl || '/assets/icons/default-exercise.png';
          item.innerHTML = `
            <img src="${imgSrc}" alt="${exercise.name}" onerror="this.src='/assets/icons/default-exercise.png'">
            <div class="exercise-info">
              <h3>${exercise.name}</h3>
              <div class="exercise-meta-small">${metaItems.join(' ‚Ä¢ ')}</div>
            </div>
          `;
          item.addEventListener('click', () => {
            closeAllDetails();
            const details = item.nextElementSibling;
            if (details && details.classList.contains('exercise-details')) {
              details.classList.add('active');
              activeDetails = details;
            } else {
              const details = document.createElement('div');
              details.className = 'exercise-details';
              details.innerHTML = getExerciseDetailsHTML(ex, exercise, index);
              item.parentNode.insertBefore(details, item.nextSibling);
              details.classList.add('active');
              activeDetails = details;
              initExerciseDetails(details, ex, exercise, index);
            }
          });
          exerciseList.appendChild(item);
        });
      }

      function getExerciseDetailsHTML(ex, exercise, index) {
        const restTime = ex.rest || 90;
        const circularProgressHtml = `
          <div class="circular-progress">
            <div class="circle"><span>${ex.reps}</span><small>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</small></div>
            <div class="circle"><span>${Math.floor(restTime/60)}:${(restTime%60).toString().padStart(2,'0')}</span><small>–û—Ç–¥—ã—Ö</small></div>
            <div class="circle" id="sets-circle-${index}"><span>0/${ex.sets}</span><small>–ü–æ–¥—Ö–æ–¥–æ–≤</small></div>
          </div>
        `;

        const restTimerHtml = `
          <div class="rest-timer-local">
            <span>‚è± –û—Ç–¥—ã—Ö:</span>
            <span class="timer-display" id="restTimerDisplay_${index}">${restTime}</span>
            <button class="start-rest-btn" data-index="${index}">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å</button>
            <button class="skip-rest-btn" data-index="${index}">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
          </div>
        `;

        let formHtml = '';
        if (ex.type === 'warmup' || ex.type === 'stretch') {
          formHtml = `
            <div class="workout-form-group">
              <label>–ó–∞–º–µ—Ç–∫–∏ (—á—Ç–æ —á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∏, –∫–∞–∫ –ø—Ä–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏–∫–∞)</label>
              <textarea class="notes-input" data-id="${ex.id}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–ë—ã–ª–æ –ª–µ–≥–∫–æ¬ª, ¬´–ß—É–≤—Å—Ç–≤–æ–≤–∞–ª –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –≤ –ø–ª–µ—á–∞—Ö¬ª"></textarea>
            </div>
          `;
        } else {
          const last = getLastSessionForExercise(ex.id);
          const lastWeight = last ? last.weight : '';
          const showWeightInput = !['cardio', 'core', 'mobility', 'light'].includes(exercise.type);

          if (showWeightInput) {
            formHtml = `
              <div class="form-row">
                <div class="workout-form-group">
                  <label>–í–µ—Å (–∫–≥)</label>
                  <input type="number" step="0.5" class="weight-input" data-id="${ex.id}" placeholder="0" value="${lastWeight}">
                </div>
                <div class="workout-form-group">
                  <label>RIR (–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –≤ –∑–∞–ø–∞—Å–µ)</label>
                  <select class="rir-select" data-id="${ex.id}">
                    <option value="">?</option>
                    <option value="0">0 ‚Äî –¥–æ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–∫–∞–∑–∞</option>
                    <option value="1">1 ‚Äî –º–æ–≥ –±—ã —Å–¥–µ–ª–∞—Ç—å –µ—â—ë 1</option>
                    <option value="2">2 ‚Äî –º–æ–≥ –±—ã —Å–¥–µ–ª–∞—Ç—å –µ—â—ë 2</option>
                    <option value="3">3 ‚Äî –º–æ–≥ –±—ã —Å–¥–µ–ª–∞—Ç—å –µ—â—ë 3</option>
                  </select>
                </div>
              </div>
              <div class="workout-form-group">
                <label>–ó–∞–º–µ—Ç–∫–∏</label>
                <textarea class="notes-input" data-id="${ex.id}" placeholder="–ö–∞–∫ –ø—Ä–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏–∫–∞?"></textarea>
              </div>
            `;
          } else {
            formHtml = `
              <div class="workout-form-group">
                <label>–ó–∞–º–µ—Ç–∫–∏ (–ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è, –≤—Ä–µ–º—è, –æ—â—É—â–µ–Ω–∏—è)</label>
                <textarea class="notes-input" data-id="${ex.id}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 45 —Å–µ–∫, –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"></textarea>
              </div>
            `;
          }
        }

        return `
          <div class="exercise-card">
            <div class="exercise-header">
              <div class="exercise-number">${index + 1}</div>
              <h2 class="exercise-name">${exercise.name}</h2>
            </div>
            ${getMediaHtml(exercise)}
            ${circularProgressHtml}
            ${restTimerHtml}
            ${formHtml}
            <div class="advice-placeholder" data-id="${ex.id}"></div>
          </div>
        `;
      }

      function getMediaHtml(exercise) {
        let mediaHtml = '';
        let mediaUrl = exercise.posterUrl || exercise.gifUrl || exercise.videoUrl;

        if (mediaUrl && mediaUrl !== '#') {
          if (mediaUrl.endsWith('.mp4') || mediaUrl.endsWith('.webm')) {
            mediaHtml = `<div class="exercise-video"><video controls preload="metadata" poster="${exercise.posterUrl || ''}"><source src="${mediaUrl}" type="video/mp4">–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.</video></div>`;
          } else {
            mediaHtml = `<div class="exercise-gif"><img src="${mediaUrl}" alt="${exercise.name}" loading="lazy"></div>`;
          }
        } else {
          mediaHtml = `
            <div class="exercise-fallback" style="text-align: center; padding: 20px;">
              <img src="/assets/icons/default-exercise.png" alt="–ò–∫–æ–Ω–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è" style="width: 60px; height: 60px; margin-bottom: 12px;">
              <small>‚ÑπÔ∏è ${exercise.description || '–í—ã–ø–æ–ª–Ω—è–π—Ç–µ –ø–ª–∞–≤–Ω–æ –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ.'}</small>
            </div>
          `;
        }
        return mediaHtml;
      }

      function initExerciseDetails(details, ex, exercise, index) {
        const advicePlaceholder = details.querySelector('.advice-placeholder');
        if (advicePlaceholder) {
          generateExerciseAdvice(ex, exercise, profile, details);
        }

        const startBtn = details.querySelector('.start-rest-btn');
        if (startBtn) {
          startBtn.addEventListener('click', () => {
            const displayElement = details.querySelector('.timer-display');
            const setsElement = document.getElementById(`sets-circle-${index}`).querySelector('span');
            startRestTimerLocal(ex.rest || 90, displayElement, index, setsElement);
          });
        }

        const skipBtn = details.querySelector('.skip-rest-btn');
        if (skipBtn) {
          skipBtn.addEventListener('click', () => {
            stopRestTimerLocal();
            const displayElement = details.querySelector('.timer-display');
            displayElement.textContent = ex.rest || 90;
          });
        }

        details.querySelectorAll('input, select, textarea').forEach(el => {
          el.addEventListener('input', () => {
            hasUnsavedChanges = true;
            updateSaveButtonState();
          });
        });
      }

      function updateSaveButtonState() {
        const saveBtn = document.getElementById('saveSession');
        const inputs = document.querySelectorAll('.weight-input, .notes-input');
        const hasInput = Array.from(inputs).some(input => input.value.trim() !== '');

        if (hasInput) {
          saveBtn.style.display = 'block';
        } else {
          saveBtn.style.display = 'none';
        }
      }

      // === –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–û–•–†–ê–ù–ï–ù–ò–Ø (–î–ï–õ–ï–ì–ò–†–û–í–ê–ù–ò–ï) ===
      document.addEventListener('click', async (e) => {
        if (e.target.id === 'saveSession') {
          e.preventDefault();
          if (!isDataLoaded || !session) {
            alert('–î–∞–Ω–Ω—ã–µ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ü–æ–¥–æ–∂–¥–∏—Ç–µ.');
            return;
          }

          const rpe = document.getElementById('rpeInput').value || null;
          const doms = document.getElementById('domsInput').value || null;

          const exercises = [];
          document.querySelectorAll('.weight-input').forEach(input => {
            const id = input.dataset.id;
            const weight = input.value;
            if (!weight) return;
            const rir = document.querySelector(`.rir-select[data-id="${id}"]`).value;
            const notes = document.querySelector(`.notes-input[data-id="${id}"]`).value;
            exercises.push({
              id,
              weight: parseFloat(weight),
              rir: rir || null,
              notes: notes || null
            });
          });

          document.querySelectorAll('.notes-input').forEach(textarea => {
            const id = textarea.dataset.id;
            const notes = textarea.value;
            const exType = session.exercises.find(ex => ex.id === id)?.type;
            if (notes && !exercises.some(e => e.id === id) && exType !== 'warmup' && exType !== 'stretch') {
              exercises.push({ id, weight: null, rir: null, notes });
            }
          });

          if (exercises.length === 0) {
            alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Ö–æ—Ç—è –±—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è');
            return;
          }

          const tracker = new WorkoutTracker();
          const savedSession = tracker.logSession({
            programId,
            programName: session.name || programName,
            date: new Date().toISOString(),
            rpe,
            doms,
            exercises,
            completed: true
          });

          try {
            const { AIAssistant } = await import('/core/aiAssistant.js');
            const ai = new AIAssistant();
            ai.recordUserAction('completed_workout', {
              rpe: rpe,
              exercisesCount: exercises.length
            });
          } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –≤ –ò–ò:', e);
          }

          await showPostWorkoutAdvice(savedSession, profile);
          hasUnsavedChanges = false;

          setTimeout(() => {
            window.location.href = '/pages/workouts.html';
          }, 5000);
        }
      });

      // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø UI ---

      try {
        await HeaderController.loadHeader();
      } catch (e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ö–µ–¥–µ—Ä:', e);
      }

      new ThemeManager();

      // ‚ùå –£–î–ê–õ–ï–ù–û: const exercisesContainer = document.getElementById('exercisesContainer'); ‚Äî –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

      const sessionProgress = document.getElementById('sessionProgress');
      const sessionTitle = document.getElementById('sessionTitle');
      const readinessSection = document.getElementById('readinessSection');
      const weekSelector = document.getElementById('weekSelector');

      // document.getElementById('skipRestBtn').addEventListener('click', stopRestTimer);

      // --- –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ---

      try {
        const urlParams = new URLSearchParams(window.location.search);
        programId = urlParams.get('id');
        programName = urlParams.get('name');
        const weekParam = parseInt(urlParams.get('week')) || 1;

        if (!programId || !programName) {
          sessionProgress.textContent = "‚ùå –ù–µ —É–∫–∞–∑–∞–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞";
          sessionProgress.className = 'error-text';
          return;
        }

        const { WorkoutPlanner } = await import('/core/workoutPlanner.js');
        const planner = new WorkoutPlanner();
        await planner.init();

        let program = planner.getCurrent();
        if (!program || !program.schedule?.length) {
          if (programId) {
            program = await planner.usePredefinedProgram(programId, weekParam);
          } else {
            program = await planner.generate();
          }
        }

        if (!program.schedule?.length) throw new Error("–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø—É—Å—Ç–∞");

        const warnings = program.warnings || [];
        if (warnings.length > 0) {
          const warningsEl = document.createElement('div');
          warningsEl.className = 'alert warning';
          warningsEl.innerHTML = warnings.map(w => `<p>${w}</p>`).join('');
          document.querySelector('.session-header').insertAdjacentElement('beforebegin', warningsEl);
        }

        const originalProgramId = program.originalProgramId || program.id;
        if (originalProgramId && program.week) {
          weekSelector.style.display = 'flex';
          weekSelector.innerHTML = '';
          const maxWeeks = program.durationWeeks || 6;
          for (let w = 1; w <= maxWeeks; w++) {
            const btn = document.createElement('button');
            btn.className = `week-btn ${w === program.week ? 'active' : ''}`;
            btn.textContent = `–ù–µ–¥–µ–ª—è ${w}`;
            btn.onclick = () => {
              if (w !== program.week) {
                window.location.href = `/pages/workout-session.html?id=${originalProgramId}&name=${encodeURIComponent(program.name)}&week=${w}`;
              }
            };
            weekSelector.appendChild(btn);
          }
        }

        const today = new Date().toISOString().split('T')[0];
        const todayEntry = program.schedule.find(s => s.date === today);
        if (!todayEntry) {
          alert('‚ùå –°–µ–≥–æ–¥–Ω—è –Ω–µ –≤–∞—à —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –¥–µ–Ω—å.');
          window.location.href = '/pages/workouts.html';
          return;
        }

        if (todayEntry.focus === 'rest') {
          alert('–°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å –æ—Ç–¥—ã—Ö–∞. –û—Ç–ª–∏—á–Ω–æ, –¥–∞–π —Ç–µ–ª—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è!');
          window.location.href = '/pages/workouts.html';
          return;
        }

        session = todayEntry.session;
        if (!session?.exercises?.length) throw new Error("–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π");

        if (session.warnings?.length > 0) {
          const warningsEl = document.createElement('div');
          warningsEl.className = 'alert warning';
          warningsEl.innerHTML = session.warnings.map(w => `<p>${w}</p>`).join('');
          document.querySelector('.session-header').insertAdjacentElement('beforebegin', warningsEl);
        }

        sessionTitle.textContent = session.name || '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';
        sessionProgress.textContent = `–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 1 –∏–∑ ${session.exercises.length}`;

        const exercisesData = await DataService.getExercises();
        exerciseMap = Object.fromEntries(exercisesData.map(e => [e.id, e]));
        profile = UserService.getRawData ? UserService.getRawData() : {};

        renderPlanView();
        isDataLoaded = true;

      } catch (err) {
        console.error(err);
        sessionProgress.textContent = `‚ùå ${err.message}`;
        sessionProgress.className = 'error-text';
      }

      window.addEventListener('beforeunload', (e) => {
        if (hasUnsavedChanges) {
          e.preventDefault();
          e.returnValue = '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –¢–æ—á–Ω–æ –≤—ã–π—Ç–∏?';
          return e.returnValue;
        }
      });

      document.addEventListener('input', updateSaveButtonState);
    });
  </script>
</body>
</html>