<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è ‚Äî Morphe</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f97316">

  <!-- –ë–∞–∑–∞ -->
  <link rel="stylesheet" href="/styles/base/reset.css">
  <link rel="stylesheet" href="/styles/base/theme.css">
  <link rel="stylesheet" href="/styles/base/typography.css">
  <link rel="stylesheet" href="/styles/base/utilities.css">

  <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -->
  <link rel="stylesheet" href="/styles/components/buttons.css">
  <link rel="stylesheet" href="/styles/components/cards.css">
  <link rel="stylesheet" href="/styles/components/forms.css">
  <link rel="stylesheet" href="/styles/components/tabs.css">
  <link rel="stylesheet" href="/styles/components/mobile-menu.css">

  <!-- –ú–∞–∫–µ—Ç -->
  <link rel="stylesheet" href="/styles/layout/header.css">
  <link rel="stylesheet" href="/styles/layout/footer.css">
  <link rel="stylesheet" href="/styles/layout/scroll-top.css">

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ -->
  <link rel="stylesheet" href="/styles/pages/backup.css">
</head>
<body>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ —à–∞–ø–∫–∏ -->
  <div id="header-placeholder"></div>

  <main id="main-content" tabindex="-1">
    <div class="container">
      <h1>üì§ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</h1>
      <p>–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ ‚Äî –≤–∞—à–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å. –í—ã –º–æ–∂–µ—Ç–µ —Å–∫–∞—á–∞—Ç—å –∏—Ö –∏–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞.</p>

      <section class="card">
        <h2>üíæ –°–∫–∞—á–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é</h2>
        <p>–°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –≤—Å–µ—Ö –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö:</p>
        <ul>
          <li>–ü—Ä–æ—Ñ–∏–ª—å</li>
          <li>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</li>
          <li>–ü—Ä–æ–≥—Ä–µ—Å—Å (–≤–µ—Å, –æ–±—Ö–≤–∞—Ç—ã)</li>
          <li>–¶–µ–ª–∏ –ø–æ —Å–∏–ª–µ</li>
          <li>–õ–æ–≥ –ø–∏—Ç–∞–Ω–∏—è</li>
          <li>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</li>
        </ul>
        <button id="downloadBackup" type="button" class="btn-primary">–°–∫–∞—á–∞—Ç—å JSON-—Ñ–∞–π–ª ‚Üí</button>
      </section>

      <section class="card">
        <h2>üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏</h2>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏, —á—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</p>
        <div class="form-group">
          <label for="restoreFile">–§–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ (.json)</label>
          <input type="file" id="restoreFile" accept=".json" class="form-control">
        </div>
        <button id="restoreBackup" type="button" class="btn-outline">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <p class="text-tertiary"><small>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: —ç—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ.</small></p>
      </section>

      <div id="backupFeedback" aria-live="polite"></div>
    </div>
  </main>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ –ø–æ–¥–≤–∞–ª–∞ -->
  <div id="footer-placeholder"></div>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

  <script type="module">
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { StorageManager } from '/utils/storage.js';

    document.addEventListener('DOMContentLoaded', async () => {
      await HeaderController.loadHeader();
      await HeaderController.loadHeader();
      new ThemeManager();

      const feedback = document.getElementById('backupFeedback');

      const KEYS_TO_BACKUP = [
        'morphe-user-profile',
        'morphe-workout-history',
        'morphe-progress-data',
        'morphe-strength-goals',
        'morphe-daily-food-log',
        'morphe-notifications',
        'morphe-scheduled-notifications',
        'morphe-current-workout-plan',
        'morphe-offline-visits',
        'morphe-supplement-views',
        'morphe-pro-unlocked',
        'morphe-user-config',
        'morphe-theme'
      ];

      document.getElementById('downloadBackup').addEventListener('click', () => {
        const backupData = {};
        
        KEYS_TO_BACKUP.forEach(key => {
          const value = localStorage.getItem(key);
          if (value !== null) {
            try {
              backupData[key] = JSON.parse(value);
            } catch (e) {
              console.warn(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å ${key}:`, e);
            }
          }
        });

        backupData.meta = {
          version: "v1.5.0",
          appName: "Morphe",
          exportDate: new Date().toISOString(),
          device: navigator.userAgent
        };

        const blob = new Blob([JSON.stringify(backupData, null, 2)], { 
          type: 'application/json' 
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `morphe-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);

        feedback.innerHTML = '<p class="success-text">‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ —Å–∫–∞—á–∞–Ω–∞.</p>';
        setTimeout(() => feedback.innerHTML = '', 3000);
      });

      document.getElementById('restoreBackup').addEventListener('click', async () => {
        const fileInput = document.getElementById('restoreFile');
        if (!fileInput.files.length) {
          feedback.innerHTML = '<p class="error-text">‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.</p>';
          return;
        }

        const file = fileInput.files[0];
        try {
          const content = await file.text();
          const data = JSON.parse(content);

          const confirmRestore = confirm(
            `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ?\n\n` +
            `–ë—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ.\n` +
            `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`
          );

          if (!confirmRestore) return;

          Object.keys(data).forEach(key => {
            if (key === 'meta') return;
            if (KEYS_TO_BACKUP.includes(key)) {
              localStorage.setItem(key, JSON.stringify(data[key]));
            }
          });

          feedback.innerHTML = '<p class="success-text">‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...</p>';
          setTimeout(() => {
            location.reload();
          }, 1500);

        } catch (err) {
          feedback.innerHTML = `<p class="error-text">‚ùå –û—à–∏–±–∫–∞: ${err.message}</p>`;
        }
      });
    });

    // –ü–æ–¥–≤–∞–ª
    document.addEventListener('DOMContentLoaded', () => {
      import('/core/HeaderController.js')
        .then(m => m.HeaderController.loadFooter())
        .catch(err => console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–≤–∞–ª–∞:', err));
    });
  </script>
</body>
</html>