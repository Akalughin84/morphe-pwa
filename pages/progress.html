<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Morphe ‚Äî –ü—Ä–æ–≥—Ä–µ—Å—Å</title>
  <link rel="stylesheet" href="../styles.css" />
  <link rel="stylesheet" href="../styles-form.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .chart-loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 300px;
      color: #666;
      font-style: italic;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    .btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <header class="page-header">
    <div class="container">
      <a href="../index.html" class="logo-link">
        <div class="logo">Morphe</div>
      </a>

      <!-- –ì–∞–º–±—É—Ä–≥–µ—Ä -->
      <button id="menuToggle" class="menu-toggle" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <nav id="mainNav" class="page-nav" aria-label="–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
        <a href="../pages/profile.html" class="nav-link">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
        <a href="../pages/workouts.html" class="nav-link">üí™ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</a>
        <a href="../pages/nutrition.html" class="nav-link">üçΩ –ü–∏—Ç–∞–Ω–∏–µ</a>
        <a href="../pages/supplements.html" class="nav-link">üíä –í–∏—Ç–∞–º–∏–Ω—ã</a>
        <a href="../pages/premium.html" class="nav-link">üíé Pro</a>
      </nav>
    </div>
  </header>

  <main class="progress-page">
    <div class="container">
      <h1>üìà –û—Ç—Å–ª–µ–∂–∏–≤–∞–π —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h1>
      <p>–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –∑–∞–º–µ—Ä—ã ‚Äî –∫–ª—é—á –∫ –ø–æ–Ω–∏–º–∞–Ω–∏—é, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞.</p>

      <!-- –°—Ç–∞—Ç—É—Å —Ü–µ–ª–∏ -->
      <div id="goalSummary" aria-live="polite"></div>

      <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ -->
      <div class="controls-group">
        <div class="form-group">
          <label for="weight">–í–µ—Å (–∫–≥)</label>
          <input type="number" id="weight" step="0.1" placeholder="77.7" aria-describedby="weightHelp">
          <div id="weightHelp" class="sr-only">–ù–∞–∂–º–∏—Ç–µ Enter –∏–ª–∏ –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</div>
          <button id="addWeightBtn" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>

        <div class="form-group">
          <label for="waist">–û–±—Ö–≤–∞—Ç —Ç–∞–ª–∏–∏ (—Å–º)</label>
          <input type="number" id="waist" step="0.5" placeholder="108" aria-describedby="waistHelp">
          <div id="waistHelp" class="sr-only">–ù–∞–∂–º–∏—Ç–µ Enter –∏–ª–∏ –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</div>
          <button id="addWaistBtn" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è -->
      <section class="stats-grid" aria-labelledby="statsHeading">
        <h2 id="statsHeading" class="sr-only">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–º–µ—Ä—ã</h2>
        <article class="stat-card">
          <h3>‚öñÔ∏è –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–µ—Å</h3>
          <p id="lastWeight" aria-live="polite">‚Äî</p>
        </article>
        <article class="stat-card">
          <h3>üìè –ü–æ—Å–ª–µ–¥–Ω—è—è —Ç–∞–ª–∏—è</h3>
          <p id="lastWaist" aria-live="polite">‚Äî</p>
        </article>
        <article class="stat-card">
          <h3>üìÖ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ</h3>
          <p id="lastDate" aria-live="polite">‚Äî</p>
        </article>
      </section>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
      <section class="charts" aria-labelledby="chartsHeading">
        <h2 id="chartsHeading" class="sr-only">–ì—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</h2>
        <div class="chart-box">
          <h2>üìâ –í–µ—Å –ø–æ –¥–Ω—è–º</h2>
          <div id="weightChartContainer">
            <div class="chart-loading" id="weightChartLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –≤–µ—Å–∞...</div>
            <canvas id="weightChart" role="img" aria-label="–ì—Ä–∞—Ñ–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Å–∞ —Å —Ç–µ—á–µ–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏"></canvas>
          </div>
        </div>
        <div class="chart-box">
          <h2>üìâ –û–±—Ö–≤–∞—Ç —Ç–∞–ª–∏–∏</h2>
          <div id="waistChartContainer">
            <div class="chart-loading" id="waistChartLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ —Ç–∞–ª–∏–∏...</div>
            <canvas id="waistChart" role="img" aria-label="–ì—Ä–∞—Ñ–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ö–≤–∞—Ç–∞ —Ç–∞–ª–∏–∏ —Å —Ç–µ—á–µ–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏"></canvas>
          </div>
        </div>
      </section>

      <!-- –§–æ—Ç–æ –¥–æ/–ø–æ—Å–ª–µ -->
      <section class="photo-section" aria-labelledby="photoHeading">
        <h3 id="photoHeading">üì∏ –§–æ—Ç–æ –¥–æ/–ø–æ—Å–ª–µ</h3>
        <p>–î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å.</p>
        <input type="file" accept="image/*" id="photoInput" style="margin-bottom: 1rem;" aria-label="–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞">
        <button id="savePhotoBtn" class="btn-secondary">üì∑ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
        <div id="photoPreview" style="margin-top: 1rem;" aria-live="polite"></div>
      </section>

      <!-- –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö -->
      <div style="text-align: center; margin: 2rem 0;">
        <button id="exportCsvBtn" class="btn-secondary">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
        <button id="clearProgressBtn" class="btn-danger" style="margin-left: 1rem;">‚ö†Ô∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
      </div>
    </div>
  </main>

  <script type="module">
    import { MorpheProfile } from '../modules/profile.js';
    import { ProgressTracker } from '../modules/progressTracker.js';
    import { GoalTracker } from '../core/goalTracker.js';

    const profile = new MorpheProfile();
    const progressTracker = new ProgressTracker();

    // === –ö–≠–® –î–õ–Ø –§–û–†–ú–ê–¢–ê –î–ê–¢ ===
    const dateFormatter = new Intl.DateTimeFormat('ru-RU', {
      day: 'numeric',
      month: 'short'
    });

    function formatDate(isoDate) {
      if (!isoDate) return '‚Äî';
      const date = new Date(isoDate);
      return dateFormatter.format(date);
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===
    async function init() {
      try {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
        if (!profile.isComplete()) {
          const overlay = document.createElement('div');
          overlay.innerHTML = `
            <div class="container" style="padding: 4rem 2rem; text-align: center;">
              <h2>üîí –î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</h2>
              <p>–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å, —Å–Ω–∞—á–∞–ª–∞ <a href="../pages/profile.html">–∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</a>.</p>
            </div>`;
          overlay.style.position = 'fixed';
          overlay.style.top = '0';
          overlay.style.left = '0';
          overlay.style.width = '100%';
          overlay.style.height = '100%';
          overlay.style.backgroundColor = 'white';
          overlay.style.zIndex = '9999';
          overlay.style.display = 'flex';
          overlay.style.justifyContent = 'center';
          overlay.style.alignItems = 'center';
          document.body.appendChild(overlay);
          return;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–ª–∏
        const goalTracker = new GoalTracker(profile.data || {}, {
          weights: progressTracker.weightLog,
          waist: progressTracker.waistLog
        });
        goalTracker.load();

        const lastWeightEl = document.getElementById('lastWeight');
        const lastWaistEl = document.getElementById('lastWaist');
        const lastDateEl = document.getElementById('lastDate');
        const goalSummaryEl = document.getElementById('goalSummary');

        // === –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø ===
        function getGoalLabel(type) {
          const labels = {
            'muscle_gain': '–ù–∞–±–æ—Ä –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã',
            'fat_loss': '–°–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –∂–∏—Ä–∞'
          };
          return labels[type] || type;
        }

        function getPhaseLabel(phase) {
          const labels = {
            foundation: '–ó–∞–∫–ª–∞–¥–∫–∞ –æ—Å–Ω–æ–≤—ã',
            intensify: '–ò–Ω—Ç–µ–Ω—Å–∏—Ñ–∏–∫–∞—Ü–∏—è',
            peak: '–ü–∏–∫–æ–≤–∞—è —Ñ–∞–∑–∞'
          };
          return labels[phase] || phase;
        }

        // === –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¶–ï–õ–ò ===
        function renderGoal() {
          if (!goalTracker.goal) {
            goalSummaryEl.innerHTML = `
              <div class="ai-advice-panel" style="margin-bottom: 30px;">
                <h3>üéØ –£—Å—Ç–∞–Ω–æ–≤–∏ —Ü–µ–ª—å</h3>
                <p>–•–æ—á–µ—à—å –Ω–∞–±—Ä–∞—Ç—å –º—ã—à—Ü—ã –∏–ª–∏ —Å–Ω–∏–∑–∏—Ç—å % –∂–∏—Ä–∞? –ü–æ—Å—Ç–∞–≤—å —Ü–µ–ª—å ‚Äî –∏ —è –ø—Ä–æ–≤–µ–¥—É —Ç–µ–±—è –¥–æ —Ñ–∏–Ω–∏—à–∞.</p>
                <button id="createGoalBtn" class="btn-accent">‚ûï –ü–æ—Å—Ç–∞–≤–∏—Ç—å —Ü–µ–ª—å</button>
              </div>
            `;
            const createBtn = document.getElementById('createGoalBtn');
            if (createBtn) {
              createBtn.addEventListener('click', createGoal);
            }
            return;
          }

          const status = goalTracker.getStatus();

          goalSummaryEl.innerHTML = `
            <div class="ai-advice-panel" style="margin-bottom: 30px;">
              <h3>üéØ –¢–≤–æ—è —Ü–µ–ª—å: ${getGoalLabel(goalTracker.goal.type)}</h3>
              <p><strong>–§–∞–∑–∞:</strong> ${getPhaseLabel(status.phase)}</p>
              <p><strong>–ù–µ–¥–µ–ª—è:</strong> ${status.currentWeek} –∏–∑ ${goalTracker.goal.weeks}</p>
              <p><strong>–û—Å—Ç–∞–ª–æ—Å—å:</strong> ${status.daysLeft} –¥–Ω–µ–π</p>
              
              <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${Math.round(status.progress)}%"></div>
              </div>
              <p>${Math.round(status.progress)}% –∑–∞–≤–µ—Ä—à–µ–Ω–æ</p>

              ${status.nextMilestone ? 
                `<p><small>–°–ª–µ–¥—É—é—â–∞—è –≤–µ—Ö–∞: ${status.nextMilestone.target} –∫–≥ ‚Äî ${formatDate(status.nextMilestone.date)}</small></p>` 
                : ''}

              <p class="encouragement">${status.encouragement}</p>
            </div>
          `;
        }

        // === –°–û–ó–î–ê–ù–ò–ï –¶–ï–õ–ò ===
        function createGoal() {
          const choice = prompt(
            "–ö–∞–∫–∞—è —É —Ç–µ–±—è —Ü–µ–ª—å?\n\n" +
            "1 ‚Äî –ù–∞–±–æ—Ä –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã\n" +
            "2 ‚Äî –°–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –∂–∏—Ä–∞"
          );

          let type = null;
          if (choice === '1') type = 'muscle_gain';
          if (choice === '2') type = 'fat_loss';

          if (!type) {
            alert("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä.");
            return;
          }

          const target = parseFloat(prompt(`–ù–∞ —Å–∫–æ–ª—å–∫–æ –∫–≥ —Ö–æ—á–µ—à—å ${choice === '1' ? '–Ω–∞–±—Ä–∞—Ç—å' : '—Å–Ω–∏–∑–∏—Ç—å'}?`));
          const weeks = parseInt(prompt("–ó–∞ —Å–∫–æ–ª—å–∫–æ –Ω–µ–¥–µ–ª—å?", "12"));

          if (isNaN(target) || isNaN(weeks) || weeks <= 0) {
            alert("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —á–∏—Å–ª–∞.");
            return;
          }

          goalTracker.setGoal(type, target, weeks);
          goalTracker.save();
          renderGoal();
          alert(`üéØ –¶–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ${getGoalLabel(type)} –Ω–∞ ${target} –∫–≥ –∑–∞ ${weeks} –Ω–µ–¥–µ–ª—å!`);
        }

        // === –í–í–û–î –î–ê–ù–ù–´–• ===
        function addWeight() {
          const input = document.getElementById('weight');
          const value = parseFloat(input.value.trim());
          if (isNaN(value) || value <= 0) {
            alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–µ—Å–∞.");
            return;
          }

          const today = new Date().toISOString().split('T')[0];
          const existing = progressTracker.weightLog.find(e => e.date === today);
          if (existing) {
            if (!confirm(`–£–∂–µ –µ—Å—Ç—å –∑–∞–ø–∏—Å—å –∑–∞ —Å–µ–≥–æ–¥–Ω—è: ${existing.weight} –∫–≥. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å?`)) {
              return;
            }
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å
            progressTracker.weightLog = progressTracker.weightLog.filter(e => e.date !== today);
          }

          progressTracker.logWeight(value);
          input.value = '';
          updateAll();
          alert(`‚úÖ –í–µ—Å ${value} –∫–≥ –¥–æ–±–∞–≤–ª–µ–Ω!`);
        }

        function addWaist() {
          const input = document.getElementById('waist');
          const value = parseFloat(input.value.trim());
          if (isNaN(value) || value <= 0) {
            alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∞–ª–∏–∏.");
            return;
          }

          const today = new Date().toISOString().split('T')[0];
          const existing = progressTracker.waistLog.find(e => e.date === today);
          if (existing) {
            if (!confirm(`–£–∂–µ –µ—Å—Ç—å –∑–∞–ø–∏—Å—å –∑–∞ —Å–µ–≥–æ–¥–Ω—è: ${existing.waist} —Å–º. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å?`)) {
              return;
            }
            progressTracker.waistLog = progressTracker.waistLog.filter(e => e.date !== today);
          }

          progressTracker.logWaist(value);
          input.value = '';
          updateAll();
          alert(`‚úÖ –¢–∞–ª–∏—è ${value} —Å–º –¥–æ–±–∞–≤–ª–µ–Ω–∞!`);
        }

        // === –û–ß–ò–°–¢–ö–ê ===
        function clearProgress() {
          if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.")) {
            progressTracker.clearAll();
            localStorage.removeItem('morphe_current_goal');
            localStorage.removeItem('morphe_progress_photos');
            goalTracker.goal = null;
            goalTracker.load();
            updateAll();
            document.getElementById('photoPreview').innerHTML = '';
            alert("üóë –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ —Ü–µ–ª–∏ —É–¥–∞–ª–µ–Ω—ã.");
          }
        }

        // === –û–ë–ù–û–í–õ–ï–ù–ò–ï –° –î–ï–ë–ê–£–ù–°–û–ú ===
        let updateTimeout;
        function updateAll() {
          clearTimeout(updateTimeout);
          updateTimeout = setTimeout(() => {
            updateStats();
            updateCharts();
            renderGoal();
          }, 300);
        }

        function updateStats() {
          const lastWeight = progressTracker.getLastEntry('weight');
          const lastWaist = progressTracker.getLastEntry('waist');

          lastWeightEl.textContent = lastWeight ? `${lastWeight.weight} –∫–≥ (${lastWeight.dayOfWeek})` : "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
          lastWaistEl.textContent = lastWaist ? `${lastWaist.waist} —Å–º (${lastWaist.dayOfWeek})` : "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
          lastDateEl.textContent = lastWeight ? formatDate(lastWeight.date) : "‚Äî";

          goalTracker.history.weights = progressTracker.weightLog;
        }

        // === –ì–†–ê–§–ò–ö–ò ===
        let weightChart, waistChart;

        function updateCharts() {
          try {
            const weightCtx = document.getElementById('weightChart').getContext('2d');
            const waistCtx = document.getElementById('waistChart').getContext('2d');

            const weightData = progressTracker.getWeightData();
            const waistData = progressTracker.getWaistData();

            if (!Array.isArray(weightData)) {
              console.error("Invalid weight data:", weightData);
              return;
            }

            if (weightChart) weightChart.destroy();
            if (waistChart) waistChart.destroy();

            // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä—ã
            document.getElementById('weightChartLoading').style.display = 'none';
            document.getElementById('waistChartLoading').style.display = 'none';
            document.getElementById('weightChart').style.display = 'block';
            document.getElementById('waistChart').style.display = 'block';

            // === –ì–†–ê–§–ò–ö –í–ï–°–ê ===
            let labels = weightData.map(d => formatDate(d.x));
            let values = weightData.map(d => d.y);

            const datasets = [
              {
                label: '–í–µ—Å (–∫–≥)',
                data: values, // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: data –≤–º–µ—Å—Ç–æ values
                borderColor: '#2E7D32',
                backgroundColor: 'rgba(46,125,50,0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 4
              }
            ];

            // –ü—Ä–æ–≥–Ω–æ–∑ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ >=2 —Ç–æ—á–µ–∫
            if (weightData.length >= 2) {
              const regression = linearRegression(weightData.map(d => ({ x: new Date(d.x).getTime(), y: d.y })));
              const forecast = generateForecastPoints(regression, 8);
              
              const forecastValues = Array(labels.length).fill(null);
              forecast.forEach(p => forecastValues.push(p.y));

              // –†–∞—Å—à–∏—Ä—è–µ–º –º–µ—Ç–∫–∏
              const extendedLabels = [...labels];
              for (let i = 1; i <= 8; i++) {
                extendedLabels.push(`+${i}–Ω`);
              }

              datasets.push({
                label: '–ü—Ä–æ–≥–Ω–æ–∑',
                data: forecastValues, // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: data –≤–º–µ—Å—Ç–æ forecastValues
                borderColor: '#FF9800',
                borderDash: [5, 5],
                pointRadius: 0,
                showLine: true
              });

              labels = extendedLabels;
            }

            weightChart = new Chart(weightCtx, {
              type: 'line',
              data: { // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω –∫–ª—é—á data
                datasets,
                labels
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { display: true }, // ‚úÖ –í–∫–ª—é—á–∏–ª –ª–µ–≥–µ–Ω–¥—É –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
                  tooltip: {
                    callbacks: {
                      title: (context) => formatDate(context[0].parsed.x),
                      label: (context) => `–í–µ—Å: ${context.parsed.y} –∫–≥`
                    }
                  }
                },
                scales: {
                  x: {
                    title: { display: true, text: '–î–∞—Ç–∞' }
                  },
                  y: {
                    title: { display: true, text: '–ö–∏–ª–æ–≥—Ä–∞–º–º—ã' },
                    beginAtZero: false
                  }
                }
              }
            });

            // === –ì–†–ê–§–ò–ö –¢–ê–õ–ò–ò ===
            const waistLabels = waistData.map(d => formatDate(d.x));
            const waistValues = waistData.map(d => d.y);

            waistChart = new Chart(waistCtx, {
              type: 'line',
              data: { // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω –∫–ª—é—á data
                datasets: [{
                  label: '–¢–∞–ª–∏—è (—Å–º)',
                  data: waistValues, // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: data –≤–º–µ—Å—Ç–æ waistValues
                  borderColor: '#FF6F00',
                  backgroundColor: 'rgba(255,111,0,0.1)',
                  fill: true,
                  tension: 0.4,
                  pointRadius: 4
                }],
                labels: waistLabels
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { display: true }, // ‚úÖ –í–∫–ª—é—á–∏–ª –ª–µ–≥–µ–Ω–¥—É
                  tooltip: {
                    callbacks: {
                      title: (context) => formatDate(context[0].parsed.x),
                      label: (context) => `–¢–∞–ª–∏—è: ${context.parsed.y} —Å–º`
                    }
                  }
                },
                scales: {
                  x: {
                    title: { display: true, text: '–î–∞—Ç–∞' }
                  },
                  y: {
                    title: { display: true, text: '–°–∞–Ω—Ç–∏–º–µ—Ç—Ä—ã' },
                    beginAtZero: false
                  }
                }
              }
            });

          } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤:", err);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
          }
        }

        // === –õ–ò–ù–ï–ô–ù–ê–Ø –†–ï–ì–†–ï–°–°–ò–Ø –ò –ü–†–û–ì–ù–û–ó ===
        function linearRegression(points) {
          let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
          const n = points.length;

          points.forEach(p => {
            sumX += p.x;
            sumY += p.y;
            sumXY += p.x * p.y;
            sumXX += p.x * p.x;
          });

          const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
          const intercept = (sumY - slope * sumX) / n;

          return { slope, intercept };
        }

        function generateForecastPoints(regression, weeks) {
          const now = Date.now();
          const points = [];

          for (let i = 1; i <= weeks * 7; i++) {
            const date = new Date(now + i * 24 * 60 * 60 * 1000);
            const x = date.toISOString().split('T')[0];
            const y = regression.intercept + regression.slope * date.getTime();
            points.push({ x, y: parseFloat(y.toFixed(1)) });
          }

          return points;
        }

        // === –§–û–¢–û –î–û/–ü–û–°–õ–ï ===
        function savePhoto() {
          const input = document.getElementById('photoInput');
          const file = input.files[0];
          if (!file) {
            alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ");
            return;
          }

          if (!file.type.startsWith('image/')) {
            alert("–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
            return;
          }

          const reader = new FileReader();
          reader.onload = function(e) {
            const photos = JSON.parse(localStorage.getItem('morphe_progress_photos') || '[]');
            const today = new Date().toISOString().split('T')[0];
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç –ø–æ –¥–∞—Ç–µ
            const existingIndex = photos.findIndex(p => p.date === today);
            if (existingIndex >= 0) {
              if (!confirm("–§–æ—Ç–æ –∑–∞ —Å–µ–≥–æ–¥–Ω—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ó–∞–º–µ–Ω–∏—Ç—å?")) {
                return;
              }
              photos[existingIndex] = {
                url: e.target.result,
                date: today
              };
            } else {
              photos.push({
                url: e.target.result,
                date: today
              });
            }

            localStorage.setItem('morphe_progress_photos', JSON.stringify(photos));
            showPhotos();
            alert("‚úÖ –§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
            input.value = '';
          };
          reader.onerror = function() {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞");
          };
          reader.readAsDataURL(file);
        }

        function showPhotos() {
          const container = document.getElementById('photoPreview');
          const photos = JSON.parse(localStorage.getItem('morphe_progress_photos') || '[]');

          if (photos.length === 0) {
            container.innerHTML = '<p>–§–æ—Ç–æ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
            return;
          }

          container.innerHTML = photos.map(p => `
            <div style="display:inline-block; margin:5px; text-align:center;">
              <img src="${p.url}" alt="–§–æ—Ç–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –æ—Ç ${p.date}" style="max-width:150px; border-radius:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <p style="margin:5px 0 0 0; font-size:0.8rem; color: #555;">${formatDate(p.date)}</p>
            </div>
          `).join('');
        }

        // === –≠–ö–°–ü–û–†–¢ –í CSV ===
        function exportToCSV() {
          try {
            const weightMap = new Map(progressTracker.weightLog.map(e => [e.date, e.weight]));
            const waistMap = new Map(progressTracker.waistLog.map(e => [e.date, e.waist]));

            const allDates = [...new Set([...weightMap.keys(), ...waistMap.keys()])].sort();

            let csv = '–î–∞—Ç–∞,–í–µ—Å (–∫–≥),–¢–∞–ª–∏—è (—Å–º)\n';
            
            allDates.forEach(date => {
              const weight = weightMap.get(date) || '';
              const waist = waistMap.get(date) || '';
              csv += `${date},${weight},${waist}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `morphe_progress_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
          } catch (err) {
            console.error("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:", err);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ");
          }
        }

        // === –ì–ê–ú–ë–£–†–ì–ï–†-–ú–ï–ù–Æ ===
        const menuToggle = document.getElementById('menuToggle');
        const mainNav = document.getElementById('mainNav');

        if (menuToggle && mainNav) {
          menuToggle.addEventListener('click', () => {
            const isExpanded = menuToggle.getAttribute('aria-expanded') === 'true';
            menuToggle.setAttribute('aria-expanded', !isExpanded);
            menuToggle.classList.toggle('active');
            mainNav.classList.toggle('active');
          });

          document.querySelectorAll('.page-nav a').forEach(link => {
            link.addEventListener('click', () => {
              menuToggle.classList.remove('active');
              mainNav.classList.remove('active');
              menuToggle.setAttribute('aria-expanded', 'false');
            });
          });

          document.addEventListener('click', (e) => {
            if (!mainNav.contains(e.target) && !menuToggle.contains(e.target)) {
              menuToggle.classList.remove('active');
              mainNav.classList.remove('active');
              menuToggle.setAttribute('aria-expanded', 'false');
            }
          });
        }

        // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ===
        document.getElementById('addWeightBtn')?.addEventListener('click', addWeight);
        document.getElementById('addWaistBtn')?.addEventListener('click', addWaist);
        document.getElementById('savePhotoBtn')?.addEventListener('click', savePhoto);
        document.getElementById('exportCsvBtn')?.addEventListener('click', exportToCSV);
        document.getElementById('clearProgressBtn')?.addEventListener('click', clearProgress);

        // Enter –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–≤–æ–¥–∞
        document.getElementById('weight')?.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') addWeight();
        });
        document.getElementById('waist')?.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') addWaist();
        });

        // === –ó–ê–ü–£–°–ö ===
        showPhotos();
        updateStats();
        updateCharts();
        renderGoal();

      } catch (initError) {
        console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", initError);
        alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –∏–ª–∏ –∑–∞–π—Ç–∏ –ø–æ–∑–∂–µ.");
      }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Chart.js
    if (typeof Chart === 'undefined') {
      document.addEventListener('DOMContentLoaded', () => {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –≥—Ä–∞—Ñ–∏–∫–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.");
        document.querySelectorAll('.chart-loading').forEach(el => {
          el.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤";
          el.style.color = "red";
        });
      });
    } else {
      // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      init();
    }
  </script>
</body>
</html>