<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>–ü—Ä–æ–≥—Ä–µ—Å—Å ‚Äî Morphe</title>

  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f97316">

  <!-- –ë–∞–∑–∞ -->
  <link rel="stylesheet" href="/styles/base/reset.css">
  <link rel="stylesheet" href="/styles/base/theme.css">
  <link rel="stylesheet" href="/styles/base/typography.css">
  <link rel="stylesheet" href="/styles/base/utilities.css">

  <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -->
  <link rel="stylesheet" href="/styles/components/buttons.css">
  <link rel="stylesheet" href="/styles/components/cards.css">
  <link rel="stylesheet" href="/styles/components/forms.css">
  <link rel="stylesheet" href="/styles/components/tabs.css">
  <link rel="stylesheet" href="/styles/components/mobile-menu.css">

  <!-- –ú–∞–∫–µ—Ç -->
  <link rel="stylesheet" href="/styles/layout/header.css">
  <link rel="stylesheet" href="/styles/layout/footer.css">
  <link rel="stylesheet" href="/styles/layout/scroll-top.css">

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ -->
  <link rel="stylesheet" href="/styles/pages/progress.css">

</head>
<body>

  <div id="header-placeholder"></div>

  <main id="main-content" tabindex="-1">
    <div class="container">
      <h1>üìà –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å</h1>
      <p>–§–∏–∫—Å–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî –≤–∏–¥—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</p>

      <!-- üß† –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ -->
      <section class="card" id="aiInsightSection" style="display: none;">
        <h2>üß† –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h2>
        <div id="aiInsightContent">
          <p id="aiInsightText">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞...</p>
        </div>
      </section>

      <!-- üìä –ü—Ä–æ–≥–Ω–æ–∑ –∏ —Ç—Ä–µ–Ω–¥—ã -->
      <section class="card" id="forecastSection" style="display: none;">
        <h2>üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –∏ –¥–∏–Ω–∞–º–∏–∫–∞</h2>
        <div class="stats-grid-2">
          <div class="stat-card">
            <h3>–í–µ—Å</h3>
            <p id="weightTrend">‚Äî</p>
          </div>
          <div class="stat-card">
            <h3>–ü—Ä–æ–≥–Ω–æ–∑</h3>
            <p id="weightForecast">‚Äî</p>
          </div>
        </div>
      </section>

      <!-- –§–æ—Ä–º–∞ –∑–∞–º–µ—Ä–æ–≤ -->
      <form id="progressForm" class="card minimalist-card" novalidate>
        <div class="form-grid-2x4">
          <div class="input-icon">
            <span>‚öñÔ∏è</span>
            <input type="number" id="weight" name="weight" step="0.1" min="40" max="200" required placeholder="–í–µ—Å, –∫–≥" class="form-control-compact">
          </div>
          <div class="input-icon">
            <span>ü´Å</span>
            <input type="number" id="chest" name="chest" step="0.5" placeholder="–ì—Ä—É–¥—å, —Å–º" class="form-control-compact">
          </div>
          <div class="input-icon">
            <span>üåÄ</span>
            <input type="number" id="waist" name="waist" step="0.5" placeholder="–¢–∞–ª–∏—è, —Å–º" class="form-control-compact">
          </div>
          <div class="input-icon">
            <span>ü¶µ</span>
            <input type="number" id="thighLeft" name="thighLeft" step="0.5" placeholder="–ë–µ–¥—Ä–æ –õ, —Å–º" class="form-control-compact">
          </div>
          <div class="input-icon">
            <span>ü¶µ</span>
            <input type="number" id="thighRight" name="thighRight" step="0.5" placeholder="–ë–µ–¥—Ä–æ –ü, —Å–º" class="form-control-compact">
          </div>
          <div class="input-icon">
            <span>üí™</span>
            <input type="number" id="bicepLeft" name="bicepLeft" step="0.5" placeholder="–ë–∏—Ü–µ–ø—Å –õ, —Å–º" class="form-control-compact">
          </div>
          <div class="input-icon">
            <span>üí™</span>
            <input type="number" id="bicepRight" name="bicepRight" step="0.5" placeholder="–ë–∏—Ü–µ–ø—Å –ü, —Å–º" class="form-control-compact">
          </div>
          <div class="input-icon full-width">
            <span>üìù</span>
            <textarea id="notes" name="notes" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." rows="1" class="form-control-compact"></textarea>
          </div>
        </div>
        <button type="submit" class="btn-orange">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚Üí</button>
      </form>

      <div id="formFeedback" aria-live="polite"></div>

      <!-- üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
      <section class="card progress-calendar">
        <h2>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
        
        <div class="calendar-controls">
          <button id="prevMonth">&larr; –ü—Ä–µ–¥.</button>
          <span id="currentMonthTitle">–û–∫—Ç—è–±—Ä—å 2025</span>
          <button id="nextMonth">–°–ª–µ–¥. &rarr;</button>
        </div>
        
        <div class="legend">
          <div class="legend-item">
            <div class="legend-color body-color"></div>
            <span>üìè –ó–∞–º–µ—Ä —Ç–µ–ª–∞</span>
          </div>
          <div class="legend-item">
            <div class="legend-color nutrition-color"></div>
            <span>ü•ó –ü–∏—Ç–∞–Ω–∏–µ</span>
          </div>
          <div class="legend-item">
            <div class="legend-color workout-color"></div>
            <span>üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span>
          </div>
          <div class="legend-item">
            <div class="legend-color supplement-color"></div>
            <span>üíä –í–∏—Ç–∞–º–∏–Ω—ã</span>
          </div>
          <div class="legend-item">
            <div class="legend-color multiple-color"></div>
            <span>üü£ –ù–µ—Å–∫–æ–ª—å–∫–æ</span>
          </div>
        </div>
        
        <div class="calendar-header">
          <div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div>–í—Å</div>
        </div>
        <div class="calendar-grid" id="progressCalendar"></div>
      </section>
    </div>
  </main>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
  <div id="dayModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="modalDateTitle">–î–µ—Ç–∞–ª–∏ –∑–∞ ‚Äî</h2>
      
      <div id="modalBodySection" style="display: none;">
        <h3>üìè –ó–∞–º–µ—Ä—ã —Ç–µ–ª–∞</h3>
        <div id="modalBodyItems"></div>
      </div>
      
      <div id="modalNutritionSection" style="display: none;">
        <h3>ü•ó –ü–∏—Ç–∞–Ω–∏–µ</h3>
        <div id="modalNutritionItems"></div>
      </div>
      
      <div id="modalWorkoutSection" style="display: none;">
        <h3>üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h3>
        <div id="modalWorkoutItems"></div>
      </div>
      
      <div id="modalSupplementSection" style="display: none;">
        <h3>üíä –î–æ–±–∞–≤–∫–∏</h3>
        <div id="modalSupplementItems"></div>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

<script type="module">
  import { HeaderController } from '/core/HeaderController.js';
  import { ThemeManager } from '/core/themeManager.js';
  import { ProgressTracker } from '/modules/progressTracker.js';
  import { ProgressCalendar } from '/modules/progressCalendar.js';
  import { AIAssistant } from '/modules/aiAssistant.js';
  import { AnalyticsEngine } from '/core/analytics.js';
  import { UserService } from '/services/userService.js';

  document.addEventListener('DOMContentLoaded', async () => {
    // await HeaderController.loadHeader();
    try {
      await HeaderController.loadHeader();
      await HeaderController.loadFooter();
      new ThemeManager();

      const aiInsightSection = document.getElementById('aiInsightSection');
      const aiInsightText = document.getElementById('aiInsightText');
      const forecastSection = document.getElementById('forecastSection');
      const weightTrendEl = document.getElementById('weightTrend');
      const weightForecastEl = document.getElementById('weightForecast');
      const form = document.getElementById('progressForm');
      const feedback = document.getElementById('formFeedback');

      // === –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ===
      const modal = document.getElementById('dayModal');
      const closeBtn = document.querySelector('.close');

      function closeModal() {
        modal.classList.remove('show');
        setTimeout(() => {
          modal.style.display = 'none';
        }, 300);
      }

      closeBtn.addEventListener('click', closeModal);

      window.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      async function showDayModal(dateStr) {
        const calendar = new ProgressCalendar();
        const details = await calendar.getDayDetails(dateStr);
        
        const title = document.getElementById('modalDateTitle');
        const date = new Date(dateStr);
        const day = date.getDate();
        const monthNames = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
          '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];
        const month = monthNames[date.getMonth()];
        const year = date.getFullYear();
        const weekday = date.toLocaleDateString('ru-RU', { weekday: 'long' });
        title.textContent = `üìÖ ${day} ${month} ${year} ‚Ä¢ ${weekday}`;
        
        // –ó–∞–º–µ—Ä—ã —Ç–µ–ª–∞
        const bodySection = document.getElementById('modalBodySection');
        const bodyItems = document.getElementById('modalBodyItems');
        if (details.body.length > 0) {
          const lastEntry = details.body[details.body.length - 1];
          bodyItems.innerHTML = `
            <p>–í–µ—Å: ${lastEntry.weight} –∫–≥
            ${lastEntry.chest ? ` | –ì—Ä—É–¥—å: ${lastEntry.chest} —Å–º` : ''}
            ${lastEntry.waist ? ` | –¢–∞–ª–∏—è: ${lastEntry.waist} —Å–º` : ''}
            ${lastEntry.bicepLeft || lastEntry.bicepRight ? 
              ` | –ë–∏—Ü–µ–ø—Å: –õ ${lastEntry.bicepLeft || '‚Äî'} / –ü ${lastEntry.bicepRight || '‚Äî'} —Å–º` : ''}
            ${lastEntry.thighLeft || lastEntry.thighRight ? 
              ` | –ë–µ–¥—Ä–æ: –õ ${lastEntry.thighLeft || '‚Äî'} / –ü ${lastEntry.thighRight || '‚Äî'} —Å–º` : ''}
            ${lastEntry.notes ? `<br><small>üí¨ ${lastEntry.notes}</small>` : ''}
            </p>
          `;
          bodySection.style.display = 'block';
        } else {
          bodySection.style.display = 'none';
        }
        
        // –ü–∏—Ç–∞–Ω–∏–µ
        const nutritionSection = document.getElementById('modalNutritionSection');
        const nutritionItems = document.getElementById('modalNutritionItems');
        if (details.nutrition.length > 0) {
          nutritionSection.style.display = 'block';
          nutritionItems.innerHTML = details.nutrition.map(item => `
            <p>${item.name} (${item.grams}–≥) ‚Äî ${Math.round(item.calories * item.grams / 100)} –∫–∫–∞–ª</p>
          `).join('');
        } else {
          nutritionSection.style.display = 'none';
        }
        
        // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
        const workoutSection = document.getElementById('modalWorkoutSection');
        const workoutItems = document.getElementById('modalWorkoutItems');
        if (details.workouts.length > 0) {
          workoutSection.style.display = 'block';

          const { DataService } = await import('/services/dataService.js');
          const exercisesData = await DataService.getExercises();
          const exerciseMap = Object.fromEntries(exercisesData.map(e => [e.id, e]));

          workoutItems.innerHTML = details.workouts.map(w => {
            const exercisesList = w.exercises && w.exercises.length > 0
              ? `<ul>${w.exercises.map(ex => {
                  const fullEx = exerciseMap[ex.id] || { name: ex.name || '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ' };

                  // === –£–õ–£–ß–®–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –°–ï–¢–û–í –ò –ü–û–í–¢–û–†–û–í ===
                  const sets = ex.sets != null && ex.sets !== '' ? parseInt(ex.sets) : null;
                  const reps = ex.reps != null && ex.reps !== '' ? ex.reps : null;
                  const weight = ex.weight != null ? `${ex.weight} –∫–≥` : '‚Äî';

                  let repDisplay = weight;
                  if (sets !== null && reps !== null) {
                    repDisplay = `${sets} √ó ${reps} (${weight})`;
                  } else if (sets !== null) {
                    repDisplay = `${sets} –ø–æ–¥—Ö–æ–¥–æ–≤ (${weight})`;
                  } else if (reps !== null) {
                    repDisplay = `${reps} –ø–æ–≤—Ç–æ—Ä–æ–≤ (${weight})`;
                  }

                  let repClass = '';
                  if (sets >= 4) {
                    repClass = 'good-rep';
                  } else if (sets >= 2) {
                    repClass = 'medium-rep';
                  } else {
                    repClass = 'low-rep';
                  }

                  return `<li class="${repClass}">
                            <strong>${fullEx.name}</strong>: ${repDisplay}
                          </li>`;
                }).join('')}</ul>`
              : '<p>–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p>';

            return `<div class="workout-item">
                      <h4>üí™ ${w.name || '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'}</h4>
                      ${exercisesList}
                    </div>`;
          }).join('');
        } else {
          workoutSection.style.display = 'none';
        }
        
        // –î–æ–±–∞–≤–∫–∏
        const supplementSection = document.getElementById('modalSupplementSection');
        const supplementItems = document.getElementById('modalSupplementItems');
        if (details.supplements && details.supplements.length > 0) {
          supplementSection.style.display = 'block';
          const supplements = await (await fetch('/data/supplements.json')).json();
          const supplementMap = Object.fromEntries(supplements.map(s => [s.id, s]));

          supplementItems.innerHTML = details.supplements.map(entry => `
            <p>üíä ${supplementMap[entry.supplementId]?.name || '–î–æ–±–∞–≤–∫–∞'}</p>
          `).join('');
        } else {
          supplementSection.style.display = 'none';
        }

        // –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç
        const hasAnyData = 
          details.body.length > 0 || 
          details.nutrition.length > 0 || 
          details.workouts.length > 0 || 
          (details.supplements && details.supplements.length > 0);

        if (!hasAnyData) {
          document.getElementById('modalBodySection').style.display = 'block';
          document.getElementById('modalBodyItems').innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å.</p>';
        }

        modal.style.display = 'block';
        requestAnimationFrame(() => {
          modal.classList.add('show');
        });
      }

      // === –ö–ê–õ–ï–ù–î–ê–†–¨ –ù–ê –ú–ï–°–Ø–¶ ===
      let currentMonth = new Date();

      async function renderCalendarForMonth(date) {
        const year = date.getFullYear();
        const month = date.getMonth();
        
        const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
          '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
        document.getElementById('currentMonthTitle').textContent = `${monthNames[month]} ${year}`;
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDayOfWeek = (firstDay.getDay() + 6) % 7;
        
        const calendarEl = document.getElementById('progressCalendar');
        calendarEl.innerHTML = '';
        
        for (let i = 0; i < startDayOfWeek; i++) {
          const empty = document.createElement('div');
          empty.className = 'calendar-day empty';
          calendarEl.appendChild(empty);
        }
        
        const calendar = new ProgressCalendar();
        const today = new Date().toISOString().split('T')[0];
        
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const dayEl = document.createElement('div');
          dayEl.className = 'calendar-day';
          dayEl.textContent = day;
          dayEl.dataset.date = dateStr;
          
          if (dateStr === today) {
            dayEl.classList.add('today');
          }
          
          const details = await calendar.getDayDetails(dateStr);
          const types = [];
          if (details.body.length > 0) types.push('body');
          if (details.nutrition.length > 0) types.push('nutrition');
          if (details.workouts.length > 0) types.push('workout');
          if (details.supplements && details.supplements.length > 0) types.push('supplement');
          
          if (types.length === 1) {
            dayEl.classList.add(`has-${types[0]}`);
          } else if (types.length > 1) {
            dayEl.classList.add('has-multiple');
          }
          
          dayEl.addEventListener('click', () => showDayModal(dateStr));
          calendarEl.appendChild(dayEl);
        }
      }

      // === –ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –° –ë–ò–û–ö–û–ù–¢–ï–ö–°–¢–û–ú ===
      try {
        const profile = UserService.getProfile()?.data || {};
        const ai = new AIAssistant();
        const aiAdvice = await ai.generateAdvice();
        
        let bioContextHtml = '';
        
        if (profile.smoking && profile.smoking !== 'no') {
          bioContextHtml += '<p>üö≠ –ö—É—Ä–µ–Ω–∏–µ —Å–Ω–∏–∂–∞–µ—Ç –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å –∏ —É—Å–≤–æ–µ–Ω–∏–µ –≤–∏—Ç–∞–º–∏–Ω–æ–≤.</p>';
        }
        if (profile.alcohol && profile.alcohol !== 'none') {
          bioContextHtml += '<p>üç∑ –ê–ª–∫–æ–≥–æ–ª—å –∑–∞–º–µ–¥–ª—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º—ã—à—Ü.</p>';
        }
        if (profile.hemoglobin !== null && profile.hemoglobin < 120) {
          bioContextHtml += '<p>ü©∏ –ù–∏–∑–∫–∏–π –≥–µ–º–æ–≥–ª–æ–±–∏–Ω ‚Üí –±–æ–ª—å—à–µ –æ—Ç–¥—ã—Ö–∞ –∏ –∂–µ–ª–µ–∑–æ—Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤.</p>';
        }
        if (profile.vitaminD !== null && profile.vitaminD < 20) {
          bioContextHtml += '<p>‚òÄÔ∏è –ù–∏–∑–∫–∏–π –≤–∏—Ç–∞–º–∏–Ω D ‚Üí —á–∞—â–µ –±—ã–≤–∞–π—Ç–µ –Ω–∞ —Å–æ–ª–Ω—Ü–µ.</p>';
        }
        const chronic = profile.chronicConditions || [];
        if (chronic.includes('heart') || chronic.includes('hypertension')) {
          bioContextHtml += '<p>‚ù§Ô∏è –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–µ—Ä–¥—Ü–µ–º –∏–∑–±–µ–≥–∞–π—Ç–µ –ø–∏–∫–æ–≤—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫.</p>';
        }
        
        aiInsightText.innerHTML = `
          ${aiAdvice.emoji ? aiAdvice.emoji + ' ' : ''}<strong>${aiAdvice.title}</strong><br>
          ${aiAdvice.message}
          ${bioContextHtml ? `<div class="bio-context">${bioContextHtml}</div>` : ''}
        `;
        aiInsightSection.style.display = 'block';
      } catch (err) {
        console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏–∑:', err);
      }

      // === –ü–†–û–ì–ù–û–ó –ò –¢–†–ï–ù–î–´ –° –£–ß–Å–¢–û–ú –ë–ò–û–ö–û–ù–¢–ï–ö–°–¢–ê ===
      try {
        const profile = UserService.getProfile()?.data;
        const analytics = new AnalyticsEngine(profile);
        const progressInsight = await analytics._getProgressInsight();
        
        weightTrendEl.textContent = progressInsight.text || '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö';
        
        const tracker = new ProgressTracker();
        const recent = tracker.getSince(21);
        if (recent.length >= 2 && profile && profile.targetWeight) {
          const first = recent[recent.length - 1];
          const last = recent[0];
          const weeks = Math.max(1, (new Date(last.date) - new Date(first.date)) / (7 * 24 * 60 * 60 * 1000));
          const changePerWeek = (last.weight - first.weight) / weeks;
          
          let forecastText = '';
          const chronic = profile.chronicConditions || [];
          if (chronic.includes('heart') || chronic.includes('hypertension')) {
            forecastText = '‚ù§Ô∏è –ü—Ä–æ–≥—Ä–µ—Å—Å —Å—Ç–∞–±–∏–ª–µ–Ω. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —É–º–µ—Ä–µ–Ω–Ω—ã–π —Ç–µ–º–ø.';
          } else if (profile.smoking === 'regular' || profile.alcohol === 'frequent') {
            forecastText = '‚ö†Ô∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–º–µ–¥–ª–µ–Ω–æ. –ü—Ä–æ–≥—Ä–µ—Å—Å –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ.';
          } else if (Math.abs(changePerWeek) > 0.1) {
            const diff = Math.abs(profile.targetWeight - last.weight);
            const weeksToGoal = diff / Math.abs(changePerWeek);
            forecastText = `–¶–µ–ª—å –∑–∞ ~${Math.ceil(weeksToGoal)} –Ω–µ–¥–µ–ª—å`;
          } else {
            forecastText = '–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å';
          }
          
          weightForecastEl.textContent = forecastText;
        } else {
          weightForecastEl.textContent = '–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö';
        }
        
        forecastSection.style.display = 'block';
      } catch (err) {
        console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑:', err);
      }

      // === –°–û–•–†–ê–ù–ï–ù–ò–ï –ó–ê–ú–ï–†–û–í ===
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const weight = parseFloat(formData.get('weight'));
        if (isNaN(weight) || weight < 40 || weight > 200) {
          feedback.innerHTML = '<p class="error-text">‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å (40‚Äì200 –∫–≥)</p>';
          return;
        }

        const hasAnyMeasurement = 
          formData.get('chest') || formData.get('waist') || 
          formData.get('thighLeft') || formData.get('thighRight') || 
          formData.get('bicepLeft') || formData.get('bicepRight');

        if (!hasAnyMeasurement) {
          feedback.innerHTML = '<p class="error-text">‚ùå –£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∑–∞–º–µ—Ä —Ç–µ–ª–∞</p>';
          return;
        }

        try {
          const tracker = new ProgressTracker();
          const record = tracker.add({
            weight: weight,
            chest: formData.get('chest') ? parseFloat(formData.get('chest')) : null,
            waist: formData.get('waist') ? parseFloat(formData.get('waist')) : null,
            thighLeft: formData.get('thighLeft') ? parseFloat(formData.get('thighLeft')) : null,
            thighRight: formData.get('thighRight') ? parseFloat(formData.get('thighRight')) : null,
            bicepLeft: formData.get('bicepLeft') ? parseFloat(formData.get('bicepLeft')) : null,
            bicepRight: formData.get('bicepRight') ? parseFloat(formData.get('bicepRight')) : null,
            notes: formData.get('notes')
          });

          feedback.innerHTML = '<p class="success-text">‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!</p>';
          form.reset();
          renderCalendarForMonth(currentMonth);
          setTimeout(() => { feedback.innerHTML = ''; }, 2000);
        } catch (err) {
          feedback.innerHTML = `<p class="error-text">‚ùå –û—à–∏–±–∫–∞: ${err.message}</p>`;
        }
      });

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      renderCalendarForMonth(currentMonth);

    } catch (err) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', err);
      const feedback = document.getElementById('formFeedback');
      if (feedback) {
        feedback.innerHTML = `<p class="error-text">‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }
  });
</script>
</body>
</html>