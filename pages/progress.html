<!-- /pages/progress.html -->
<!-- v3.0.1 ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —Å undefined exercises -->

<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü—Ä–æ–≥—Ä–µ—Å—Å ‚Äî Morphe</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">

  <!-- –°—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/styles-shared.css">

  <style>
    /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
    .progress-calendar {
      margin: 32px 0;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin: 16px 0;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      border-radius: 8px;
      background: var(--bg-surface);
      position: relative;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      border: 1px solid var(--border);
    }

    .calendar-day:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .calendar-day.has-body {
      background: #2ecc71; /* üü¢ –ó–∞–º–µ—Ä */
      color: white;
    }

    .calendar-day.has-nutrition {
      background: #f39c12; /* üü° –ü–∏—Ç–∞–Ω–∏–µ */
      color: white;
    }

    .calendar-day.has-workout {
      background: #3498db; /* üîµ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ */
      color: white;
    }

    .calendar-day.has-multiple {
      background: #9b59b6; /* üü£ –ù–µ—Å–∫–æ–ª—å–∫–æ —Ç–∏–ø–æ–≤ */
      color: white;
    }

    .calendar-day.today {
      border: 2px solid var(--accent);
    }

    .calendar-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      font-weight: bold;
      font-size: 0.8rem;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .legend {
      display: flex;
      gap: 16px;
      margin: 16px 0;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }

    /* –î–µ—Ç–∞–ª–∏ –¥–Ω—è */
    .day-details {
      margin-top: 32px;
      padding: 24px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--card-bg);
    }

    .day-details h3 {
      margin-top: 0;
      color: var(--text);
      padding-bottom: 8px;
      border-bottom: 2px solid var(--accent);
    }

    .detail-section {
      margin: 24px 0;
    }

    .detail-section h4 {
      margin: 0 0 16px 0;
      color: var(--text);
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .detail-item {
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .detail-item:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ —à–∞–ø–∫–∏ -->
  <div id="header-placeholder"></div>

  <main id="main-content" tabindex="-1">
    <div class="container">
      <h1>üìà –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å</h1>
      <p>–§–∏–∫—Å–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–ª–∞, –ø–∏—Ç–∞–Ω–∏—è –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ ‚Äî —ç—Ç–æ –ª—É—á—à–∏–π –º–æ—Ç–∏–≤–∞—Ç–æ—Ä.</p>

      <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ –∑–∞–º–µ—Ä–æ–≤ -->
      <form id="progressForm" class="card" novalidate>
        <div class="form-group">
          <label for="date">–î–∞—Ç–∞</label>
          <input type="date" id="date" name="date" required class="form-control">
        </div>

        <div class="form-group">
          <label for="weight">–í–µ—Å (–∫–≥)</label>
          <input type="number" id="weight" name="weight" step="0.1" min="40" max="200" required placeholder="75.5" class="form-control">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="chest">–ì—Ä—É–¥—å (—Å–º)</label>
            <input type="number" id="chest" name="chest" step="0.5" placeholder="100" class="form-control">
          </div>
          <div class="form-group">
            <label for="waist">–¢–∞–ª–∏—è (—Å–º)</label>
            <input type="number" id="waist" name="waist" step="0.5" placeholder="85" class="form-control">
          </div>
          <div class="form-group">
            <label for="hips">–ë—ë–¥—Ä–∞ (—Å–º)</label>
            <input type="number" id="hips" name="hips" step="0.5" placeholder="98" class="form-control">
          </div>
        </div>

        <div class="form-group">
          <label for="notes">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <textarea id="notes" name="notes" rows="3" placeholder="–ß—É–≤—Å—Ç–≤—É—é –ø—Ä–∏—Ä–æ—Å—Ç —Å–∏–ª—ã..." class="form-control"></textarea>
        </div>

        <button type="submit" class="btn-primary btn-large">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Üí</button>
      </form>

      <div id="formFeedback" aria-live="polite"></div>

      <!-- üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
      <section class="card progress-calendar">
        <h2>üìÖ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</h2>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-color" style="background: #2ecc71;"></div>
            <span>üü¢ –ó–∞–º–µ—Ä —Ç–µ–ª–∞</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #f39c12;"></div>
            <span>üü° –ü–∏—Ç–∞–Ω–∏–µ</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #3498db;"></div>
            <span>üîµ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #9b59b6;"></div>
            <span>üü£ –ù–µ—Å–∫–æ–ª—å–∫–æ</span>
          </div>
        </div>
        <div class="calendar-header">
          <div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div>–í—Å</div>
        </div>
        <div class="calendar-grid" id="progressCalendar"></div>
      </section>

      <!-- üìã –î–µ—Ç–∞–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è -->
      <section id="dayDetailsSection" class="day-details" style="display: none;">
        <h3 id="dayDetailsTitle">–î–µ—Ç–∞–ª–∏ –∑–∞ ‚Äî</h3>
        
        <!-- –ó–∞–º–µ—Ä—ã —Ç–µ–ª–∞ -->
        <div id="bodyDetails" class="detail-section" style="display: none;">
          <h4>üìè –ó–∞–º–µ—Ä—ã —Ç–µ–ª–∞</h4>
          <div id="bodyItems"></div>
        </div>

        <!-- –ü–∏—Ç–∞–Ω–∏–µ -->
        <div id="nutritionDetails" class="detail-section" style="display: none;">
          <h4>üçΩ –ü–∏—Ç–∞–Ω–∏–µ</h4>
          <div id="nutritionItems"></div>
        </div>

        <!-- –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
        <div id="workoutDetails" class="detail-section" style="display: none;">
          <h4>üèãÔ∏è‚Äç‚ôÇÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h4>
          <div id="workoutItems"></div>
        </div>
      </section>

      <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–º–µ—Ä–æ–≤ -->
      <section class="card" id="historySection" style="display: none; margin-top: 32px;">
        <h2>üìè –ò—Å—Ç–æ—Ä–∏—è –∑–∞–º–µ—Ä–æ–≤ —Ç–µ–ª–∞</h2>
        <div id="progressHistory"></div>
      </section>
    </div>
  </main>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ –ø–æ–¥–≤–∞–ª–∞ -->
  <div id="footer-placeholder"></div>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

  <!-- –õ–æ–≥–∏–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
  <script type="module">
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { ProgressTracker } from '/modules/progressTracker.js';
    import { ProgressCalendar } from '/modules/progressCalendar.js';

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await HeaderController.loadHeader();
        new ThemeManager();

        const form = document.getElementById('progressForm');
        const feedback = document.getElementById('formFeedback');
        const historySection = document.getElementById('historySection');
        const historyList = document.getElementById('progressHistory');
        const calendarEl = document.getElementById('progressCalendar');
        const dayDetailsSection = document.getElementById('dayDetailsSection');
        const dayDetailsTitle = document.getElementById('dayDetailsTitle');

        const tracker = new ProgressTracker();
        const calendar = new ProgressCalendar();

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã
        document.getElementById('date').valueAsDate = new Date();

        // === –†–µ–Ω–¥–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–º–µ—Ä–æ–≤ ===
        function renderBodyProgress() {
          const entries = tracker.getAll();
          if (entries.length === 0) return;

          historySection.style.display = 'block';
          historyList.innerHTML = entries.map(entry => {
            const date = new Date(entry.date).toLocaleDateString('ru-RU', {
              day: '2-digit',
              month: 'short',
              year: 'numeric'
            });

            const nutritionEntries = calendar.nutrition.entries.filter(e => e.date === entry.date);
            const nutritionCalories = nutritionEntries.reduce((sum, item) => {
              const ratio = item.grams / 100;
              return sum + (item.calories * ratio);
            }, 0);

            const nutritionText = nutritionCalories > 0
              ? `‚Ä¢ üçΩÔ∏è ${Math.round(nutritionCalories)} –∫–∫–∞–ª`
              : '';

            return `
              <div class="history-item">
                <strong>${date}</strong> ‚Ä¢ ${entry.weight} –∫–≥ ${nutritionText}
                ${entry.chest ? `‚Ä¢ –ì—Ä—É–¥—å: ${entry.chest} —Å–º` : ''}
                ${entry.waist ? `‚Ä¢ –¢–∞–ª–∏—è: ${entry.waist} —Å–º` : ''}
                ${entry.hips ? `‚Ä¢ –ë—ë–¥—Ä–∞: ${entry.hips} —Å–º` : ''}
                ${entry.notes ? `<p><small>üí¨ ${entry.notes}</small></p>` : ''}
              </div>
            `;
          }).join('');
        }

        // === –†–µ–Ω–¥–µ—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ===
        function renderProgressCalendar() {
          const data = calendar.getLast30DaysData();
          calendarEl.innerHTML = '';

          data.forEach(day => {
            const date = new Date(day.date);
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.textContent = date.getDate();
            dayEl.dataset.date = day.date;

            const types = [];
            if (day.hasBody) types.push('body');
            if (day.hasNutrition) types.push('nutrition');
            if (day.hasWorkout) types.push('workout');

            if (types.length === 0) {
              // –ù–∏—á–µ–≥–æ
            } else if (types.length === 1) {
              dayEl.classList.add(`has-${types[0]}`);
            } else {
              dayEl.classList.add('has-multiple');
            }

            const today = new Date();
            if (date.toDateString() === today.toDateString()) {
              dayEl.classList.add('today');
            }

            dayEl.addEventListener('click', () => {
              showDayDetails(day.date);
            });

            calendarEl.appendChild(dayEl);
          });
        }

        // === –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –¥–Ω—è ===
        function showDayDetails(dateStr) {
          const details = calendar.getDayDetails(dateStr);
          const date = new Date(dateStr).toLocaleDateString('ru-RU', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });

          dayDetailsTitle.textContent = `–î–µ—Ç–∞–ª–∏ –∑–∞ ${date}`;
          dayDetailsSection.style.display = 'block';

          // –ó–∞–º–µ—Ä—ã —Ç–µ–ª–∞
          const bodyDetails = document.getElementById('bodyDetails');
          const bodyItems = document.getElementById('bodyItems');
          if (details.body.length > 0) {
            bodyDetails.style.display = 'block';
            bodyItems.innerHTML = details.body.map(entry => `
              <div class="detail-item">
                –í–µ—Å: ${entry.weight} –∫–≥
                ${entry.chest ? ` | –ì—Ä—É–¥—å: ${entry.chest} —Å–º` : ''}
                ${entry.waist ? ` | –¢–∞–ª–∏—è: ${entry.waist} —Å–º` : ''}
                ${entry.hips ? ` | –ë—ë–¥—Ä–∞: ${entry.hips} —Å–º` : ''}
                ${entry.notes ? `<br><small>üí¨ ${entry.notes}</small>` : ''}
              </div>
            `).join('');
          } else {
            bodyDetails.style.display = 'none';
          }

          // –ü–∏—Ç–∞–Ω–∏–µ
          const nutritionDetails = document.getElementById('nutritionDetails');
          const nutritionItems = document.getElementById('nutritionItems');
          if (details.nutrition.length > 0) {
            nutritionDetails.style.display = 'block';
            nutritionItems.innerHTML = details.nutrition.map(entry => `
              <div class="detail-item">
                <strong>${entry.name}</strong> (${entry.meal})
                <br>
                ${entry.grams} –≥ ‚Ä¢ ${Math.round(entry.calories * entry.grams / 100)} –∫–∫–∞–ª
              </div>
            `).join('');
          } else {
            nutritionDetails.style.display = 'none';
          }

          // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –∑–∞—â–∏—Ç–∞ –æ—Ç undefined
          const workoutDetails = document.getElementById('workoutDetails');
          const workoutItems = document.getElementById('workoutItems');
          if (details.workouts.length > 0) {
            workoutDetails.style.display = 'block';
            workoutItems.innerHTML = details.workouts.map(workout => {
              // ‚úÖ –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ exercises undefined ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
              const exercises = workout.exercises || [];
              
              return `
                <div class="detail-item">
                  <strong>${workout.programName}</strong> (${workout.durationMinutes} –º–∏–Ω)
                  ${exercises.length > 0 ? 
                    `<ul>${exercises.map(ex => 
                      `<li>${ex.id}: ${ex.weight || 0} –∫–≥${
                        ex.rir != null ? `, RIR ${ex.rir}` : ''
                      }${
                        ex.notes ? ` (${ex.notes})` : ''
                      }</li>`
                    ).join('')}</ul>` : ''}
                  ${workout.rpe ? `<small>üìä RPE: ${workout.rpe}</small>` : ''}
                  ${workout.doms ? `<small> üí¢ DOMS: ${workout.doms}</small>` : ''}
                </div>
              `;
            }).join('');
          } else {
            workoutDetails.style.display = 'none';
          }

          dayDetailsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
        renderBodyProgress();
        renderProgressCalendar();

        // === –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∑–∞–º–µ—Ä–æ–≤ ===
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          const formData = new FormData(form);

          try {
            tracker.add({
              date: formData.get('date'),
              weight: parseFloat(formData.get('weight')),
              chest: formData.get('chest') ? parseFloat(formData.get('chest')) : null,
              waist: formData.get('waist') ? parseFloat(formData.get('waist')) : null,
              hips: formData.get('hips') ? parseFloat(formData.get('hips')) : null,
              notes: formData.get('notes')
            });

            feedback.innerHTML = '<p class="success-text">‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!</p>';
            form.reset();
            document.getElementById('date').valueAsDate = new Date();

            renderBodyProgress();
            renderProgressCalendar();

            setTimeout(() => {
              feedback.innerHTML = '';
            }, 2000);

          } catch (err) {
            feedback.innerHTML = `<p class="error-text">‚ùå –û—à–∏–±–∫–∞: ${err.message}</p>`;
          }
        });

      } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', err);
        const feedback = document.getElementById('formFeedback');
        if (feedback) {
          feedback.innerHTML = `<p class="error-text">‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${err.message}</p>`;
        }
      }
    });
  </script>
</body>
</html>