<!-- /pages/goals.html -->
<!-- v1.2.0 ‚Äî –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ü–µ–ª–µ–π –ø–æ —Å–∏–ª–µ -->

<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–¶–µ–ª–∏ ‚Äî Morphe</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">

  <!-- –ë–∞–∑–∞ -->
  <link rel="stylesheet" href="/styles/base/reset.css">
  <link rel="stylesheet" href="/styles/base/theme.css">
  <link rel="stylesheet" href="/styles/base/typography.css">
  <link rel="stylesheet" href="/styles/base/utilities.css">

  <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -->
  <link rel="stylesheet" href="/styles/components/buttons.css">
  <link rel="stylesheet" href="/styles/components/cards.css">
  <link rel="stylesheet" href="/styles/components/forms.css">
  <link rel="stylesheet" href="/styles/components/tabs.css">
  <link rel="stylesheet" href="/styles/components/mobile-menu.css">

  <!-- –ú–∞–∫–µ—Ç -->
  <link rel="stylesheet" href="/styles/layout/header.css">
  <link rel="stylesheet" href="/styles/layout/footer.css">
  <link rel="stylesheet" href="/styles/layout/scroll-top.css">

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ -->
  <link rel="stylesheet" href="/styles/pages/goals.css">  
</head>
<body>  

  <!-- –ó–∞–≥–ª—É—à–∫–∞ —à–∞–ø–∫–∏ -->
  <div id="header-placeholder"></div>

  <main id="main-content">
    <div class="container">
      <h1>üéØ –í–∞—à–∏ —Ü–µ–ª–∏ –ø–æ —Å–∏–ª–µ</h1>
      <p>–°—Ç–∞–≤—å—Ç–µ —Ü–µ–ª–∏ ‚Äî –∏ –¥–æ—Å—Ç–∏–≥–∞–π—Ç–µ –∏—Ö —à–∞–≥ –∑–∞ —à–∞–≥–æ–º.</p>

      <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
      <form id="goalForm" novalidate style="margin-bottom: 2rem;">
        <div class="form-row">
          <div class="form-group">
            <label for="exerciseName">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</label>
            <input type="text" id="exerciseName" name="exerciseName" required placeholder="–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è">
          </div>
          <div class="form-group">
            <label for="unit">–ï–¥–∏–Ω–∏—Ü–∞</label>
            <select id="unit" name="unit" required>
              <option value="kg">–∫–≥ (–≤–µ—Å)</option>
              <option value="reps">–ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</option>
              <option value="time">–≤—Ä–µ–º—è (—Å–µ–∫)</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="currentValue">–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</label>
            <input type="number" step="0.1" id="currentValue" name="currentValue" required placeholder="80">
          </div>
          <div class="form-group">
            <label for="targetValue">–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</label>
            <input type="number" step="0.1" id="targetValue" name="targetValue" required placeholder="100">
          </div>
        </div>

        <div class="form-group">
          <label for="notes">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <textarea id="notes" name="notes" rows="2" placeholder="–•–æ—á—É –ø–æ–¥–Ω—è—Ç—å –ø–ª–∞—Ç–æ..."></textarea>
        </div>

        <button type="submit" class="btn-primary btn-large">–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å ‚Üí</button>
      </form>

      <div id="formFeedback" aria-live="polite"></div>

      <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ü–µ–ª–∏ -->
      <section class="card" id="activeGoalsSection">
        <h2>üí™ –ê–∫—Ç–∏–≤–Ω—ã–µ —Ü–µ–ª–∏</h2>
        <div id="activeGoalsList"></div>
      </section>

      <!-- –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ -->
      <section class="card" id="completedGoalsSection" style="display: none;">
        <h2>‚úÖ –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ü–µ–ª–∏</h2>
        <div id="completedGoalsList"></div>
      </section>
    </div>
  </main>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ –ø–æ–¥–≤–∞–ª–∞ -->
  <div id="footer-placeholder"></div>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

  <!-- –õ–æ–≥–∏–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
  <script type="module">
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { StrengthGoalTracker } from '/core/strengthGoalTracker.js';
    import { DateUtils } from '/utils/dateUtils.js';

    document.addEventListener('DOMContentLoaded', async () => {
      await HeaderController.loadHeader();
      await HeaderController.loadHeader();
      new ThemeManager();

      const form = document.getElementById('goalForm');
      const feedback = document.getElementById('formFeedback');
      const activeList = document.getElementById('activeGoalsList');
      const completedList = document.getElementById('completedGoalsList');
      const completedSection = document.getElementById('completedGoalsSection');

      const tracker = new StrengthGoalTracker();

      // === –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ü–µ–ª–µ–π ===
      function renderGoals() {
        const active = tracker.getActive();
        const completed = tracker.getCompleted();

        // –ê–∫—Ç–∏–≤–Ω—ã–µ
        activeList.innerHTML = active.length > 0 
          ? active.map(renderGoalCard).join('')
          : '<p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é!</p>';

        // –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ
        if (completed.length > 0) {
          completedList.innerHTML = completed.map(renderCompletedGoal).join('');
          completedSection.style.display = 'block';
        }
      }

      function renderGoalCard(goal) {
        const progress = tracker.getProgressPercent(goal);
        const forecast = tracker.getCompletionForecast(goal);
        const rate = tracker.getProgressRate(goal);

        return `
          <div class="goal-card">
            <div class="goal-header">
              <strong>${goal.exerciseName}</strong>
              <span class="pill">${goal.unit === 'kg' ? '–≤–µ—Å' : goal.unit === 'reps' ? '–ø–æ–≤—Ç.' : '–≤—Ä–µ–º—è'}</span>
            </div>
            
            <div class="progress-bar">
              <div class="bar-fill" style="width: ${progress}%"></div>
            </div>
            
            <p><strong>${goal.currentValue}</strong> / ${goal.targetValue} ${goal.unit}</p>
            
            ${forecast ? `
              <p><small>üìÖ –ü—Ä–æ–≥–Ω–æ–∑: ${forecast.date} (${forecast.days} –¥–Ω.)</small></p>
            ` : ''}
            
            <p><small>üìä –¢–µ–º–ø: ${{
              fast: '–ë—ã—Å—Ç—Ä—ã–π',
              steady: '–°—Ç–∞–±–∏–ª—å–Ω—ã–π',
              slow: '–ú–µ–¥–ª–µ–Ω–Ω—ã–π',
              stalled: '–ó–∞—Å—Ç–æ–π'
            }[rate]}</small></p>

            ${goal.notes ? `<p><small>üí¨ ${goal.notes}</small></p>` : ''}

            <div style="margin-top: 1rem;">
              <button 
                onclick="updateGoalProgress(${goal.id})"
                class="btn-outline btn-small">
                –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
              </button>
            </div>
          </div>
        `;
      }

      function renderCompletedGoal(goal) {
        const completedDate = new Date(goal.completedAt).toLocaleDateString('ru-RU');
        return `
          <div class="goal-card completed">
            <strong>üéâ ${goal.exerciseName}</strong>
            <p>–î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ: ${completedDate}</p>
            <p><strong>${goal.targetValue} ${goal.unit}</strong></p>
          </div>
        `;
      }

      renderGoals();

      // === –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–ª–∏ ===
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(form);

        try {
          tracker.add({
            exerciseName: formData.get('exerciseName'),
            currentValue: parseFloat(formData.get('currentValue')),
            targetValue: parseFloat(formData.get('targetValue')),
            unit: formData.get('unit'),
            notes: formData.get('notes')
          });

          feedback.innerHTML = '<p class="success-text">‚úÖ –¶–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∞! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.</p>';
          form.reset();
          setTimeout(() => feedback.innerHTML = '', 3000);

          renderGoals();

        } catch (err) {
          feedback.innerHTML = `<p class="error-text">‚ùå –û—à–∏–±–∫–∞: ${err.message}</p>`;
        }
      });

      // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ===
      window.updateGoalProgress = function(goalId) {
        const goal = tracker.findById(goalId);
        const newValue = prompt(
          `–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è "${goal.exerciseName}"`,
          goal.currentValue
        );

        if (!newValue) return;

        const numValue = parseFloat(newValue);
        if (isNaN(numValue) || numValue < goal.currentValue) {
          alert('–ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º –∏ –±–æ–ª—å—à–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ.');
          return;
        }

        tracker.updateProgress(goalId, numValue);
        alert(`–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª—ë–Ω: ${numValue} ${goal.unit}`);
        renderGoals();
      };

    });
  </script>
</body>
</html>