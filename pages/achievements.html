<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è ‚Äî Morphe</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f97316">

  <!-- –ë–∞–∑–∞ -->
  <link rel="stylesheet" href="/styles/base/reset.css">
  <link rel="stylesheet" href="/styles/base/theme.css">
  <link rel="stylesheet" href="/styles/base/typography.css">
  <link rel="stylesheet" href="/styles/base/utilities.css">

  <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -->
  <link rel="stylesheet" href="/styles/components/buttons.css">
  <link rel="stylesheet" href="/styles/components/cards.css">
  <link rel="stylesheet" href="/styles/components/forms.css">
  <link rel="stylesheet" href="/styles/components/tabs.css">
  <link rel="stylesheet" href="/styles/components/mobile-menu.css">

  <!-- –ú–∞–∫–µ—Ç -->
  <link rel="stylesheet" href="/styles/layout/header.css">
  <link rel="stylesheet" href="/styles/layout/footer.css">
  <link rel="stylesheet" href="/styles/layout/scroll-top.css">

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü—ã -->
  <link rel="stylesheet" href="/styles/pages/achievements.css"> 
</head>
<body>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ —à–∞–ø–∫–∏ -->
  <div id="header-placeholder"></div>

  <main id="main-content" tabindex="-1">
    <div class="container">
      <section class="card">
        <h1>–¢–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è —Å–∏–ª—ã</h1>
        <p class="page-subtitle">–ö–∞–∂–¥–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî —à–∞–≥ –∫ –ª—É—á—à–µ–π –≤–µ—Ä—Å–∏–∏ —Å–µ–±—è.</p>
        <p id="achievementsStats" class="info-text">–ó–∞–≥—Ä—É–∑–∫–∞...</p>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS) -->
        <div id="achievementsContainer"></div>

        <!-- –ë–ª–æ–∫ "–¢–≤–æ–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥" -->
        <div id="nextStepBlock" style="display: none; margin-top: 2rem;">
          <div class="card next-step-card">
            <h2>üéØ –¢–≤–æ–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥</h2>
            <ul id="nextStepList"></ul>
          </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π -->
        <div id="noAchievements" style="display: none; text-align: center; padding: 2rem;">
          <p>–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π.<br>–ü—Ä–æ–¥–æ–ª–∂–∞–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è ‚Äî –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è!</p>
        </div>
      </section>
    </div>
  </main>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ –ø–æ–¥–≤–∞–ª–∞ -->
  <div id="footer-placeholder"></div>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

  <script type="module">
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { AchievementsManager } from '/modules/achievementsManager.js';
    import { AchievementEngine } from '/core/achievementEngine.js';

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await HeaderController.loadHeader();
        new ThemeManager();

        const statsEl = document.getElementById('achievementsStats');
        const containerEl = document.getElementById('achievementsContainer');
        const noEl = document.getElementById('noAchievements');

        const manager = new AchievementsManager();
        const engine = new AchievementEngine();

        const unlockedBefore = new Set(manager.getUnlocked());
        await engine.checkAll();
        const unlockedAfter = new Set(manager.getUnlocked());
        const newlyUnlocked = [...unlockedAfter].filter(id => !unlockedBefore.has(id));

        const allAchievements = manager.getAllWithStatus();
        const upcoming = allAchievements
          .filter(a => 
            !a.unlocked && 
            a.target != null && 
            typeof a.progress === 'number' && 
            a.progress > 0 && 
            a.progress >= a.target * 0.7
          )
          .sort((a, b) => (b.progress / b.target) - (a.progress / a.target))
          .slice(0, 2);

        const unlockedCount = manager.getUnlockedCount();
        statsEl.innerHTML = `<strong>${unlockedCount}</strong> –∏–∑ ${allAchievements.length} –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –ø–æ–ª—É—á–µ–Ω–æ`;

        const categories = {
          streak: { title: 'üî• –°–µ—Ä–∏–∏', items: [] },
          goal: { title: 'üéØ –¶–µ–ª–∏', items: [] },
          progress: { title: 'üìà –ü—Ä–æ–≥—Ä–µ—Å—Å', items: [] },
          profile: { title: 'üë§ –ü—Ä–æ—Ñ–∏–ª—å', items: [] },
          ethics: { title: 'üßò –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞', items: [] },
          secret: { title: '‚ùì –°–µ–∫—Ä–µ—Ç—ã', items: [] },
          other: { title: '–†–∞–∑–Ω–æ–µ', items: [] }
        };

        allAchievements.forEach(a => {
          const cat = categories[a.type] || categories.other;
          cat.items.push(a);
        });

        const visibleCategories = Object.entries(categories).filter(([, cat]) => cat.items.length > 0);

        if (unlockedCount === 0) {
          noEl.style.display = 'block';
          containerEl.style.display = 'none';
        } else {
          noEl.style.display = 'none';
          containerEl.style.display = 'block';

          // === –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π ===
          containerEl.innerHTML = visibleCategories.map(([key, cat]) => {
            const hasUnlocked = cat.items.some(item => item.unlocked);
            const storageKey = `achievements-category-${key}`;
            let isOpen = hasUnlocked;
            const savedState = localStorage.getItem(storageKey);
            if (savedState !== null) {
              isOpen = savedState === 'open';
            }

            const cardsHtml = cat.items.map(a => {
              const isUnlocked = a.unlocked;
              const isSecret = a.secret;
              
              let levelBadge = '';
              if (a.type === 'streak' && isUnlocked) {
                let levelClass = '';
                if (a.target >= 30) levelClass = 'level-gold';
                else if (a.target >= 7) levelClass = 'level-silver';
                else if (a.target >= 3) levelClass = 'level-bronze';
                
                if (levelClass) {
                  const levelIcon = levelClass === 'level-gold' ? 'ü•á' :
                                   levelClass === 'level-silver' ? 'ü•à' : 'ü•â';
                  levelBadge = `<span class="achievement-level ${levelClass}">${levelIcon}</span>`;
                }
              }

              const icon = isUnlocked ? (a.icon || 'üèÜ') : (isSecret ? '‚ùì' : 'üîí');

              let progressHtml = '';
              if (a.target != null && typeof a.progress === 'number' && !isSecret) {
                progressHtml = `
                  <progress value="${Math.min(a.progress, a.target)}" max="${a.target}" 
                            aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å: ${a.progress} –∏–∑ ${a.target}"></progress>
                  <small>${a.progress}/${a.target}</small>
                `;
              } else if (isSecret && a.progress != null) {
                // –î–ª—è —Å–µ–∫—Ä–µ—Ç–æ–≤ ‚Äî –∑–∞–≥–ª—É—à–∫–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –Ω–∞–º–µ–∫–Ω—É—Ç—å, —á—Ç–æ "—á—Ç–æ-—Ç–æ –∏–¥—ë—Ç")
                // –ò–ª–∏ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–∏—á–µ–≥–æ –Ω–µ –±—ã–ª–æ
                progressHtml = '<p class="secret-hint">–ß—Ç–æ-—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç...</p>';
              }

              const title = isUnlocked ? a.title : (isSecret ? '???' : a.title || '–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ');
              let desc = '';
              if (isUnlocked) {
                desc = a.narrative || a.description;
              } else if (isSecret) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–º—ë–∫ –≤–º–µ—Å—Ç–æ –∑–∞–≥–∞–¥–∫–∏
                desc = a.hint || '–°–æ–≤–µ—Ä—à–∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ...';
              } else {
                desc = a.description || '–¢—Ä–µ–Ω–∏—Ä—É–π—Å—è, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
              }

              return `
                <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'} ${isSecret ? 'secret' : ''}" 
                     role="article" 
                     aria-label="${title} ${isUnlocked ? '‚Äî –ø–æ–ª—É—á–µ–Ω–æ' : '‚Äî –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ'}">
                  <div class="achievement-header">
                    <div class="achievement-icon">${icon}</div>
                    <div>
                      <h3>${title}</h3>
                      ${levelBadge}
                    </div>
                  </div>
                  <p>${desc}</p>
                  ${progressHtml}
                </div>
              `;
            }).join('');

            return `
              <details class="achievements-category" ${isOpen ? 'open' : ''} data-category="${key}">
                <summary>
                  <h2>${cat.title}</h2>
                </summary>
                <div class="achievements-grid">
                  ${cardsHtml}
                </div>
              </details>
            `;
          }).join('');

          // === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è ===
          containerEl.addEventListener('toggle', (e) => {
            if (e.target.tagName === 'DETAILS') {
              const category = e.target.dataset.category;
              const isOpen = e.target.hasAttribute('open');
              localStorage.setItem(`achievements-category-${category}`, isOpen ? 'open' : 'closed');
            }
          });

          // === –ë–ª–æ–∫ "–¢–≤–æ–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥" ===
          const nextStepBlock = document.getElementById('nextStepBlock');
          const nextStepList = document.getElementById('nextStepList');

          if (unlockedCount > 0 && upcoming.length > 0) {
            nextStepList.innerHTML = upcoming.map(a => `
              <li>
                <strong>${a.title}</strong> ‚Äî –æ—Å—Ç–∞–ª–æ—Å—å ${a.target - a.progress}!
              </li>
            `).join('');
            nextStepBlock.style.display = 'block';
          } else {
            nextStepBlock.style.display = 'none';
          }

          // === –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ ===
          if (newlyUnlocked.length > 0) {
            import('/utils/confetti.js').then(({ default: confetti }) => {
              if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                confetti({
                  particleCount: 150,
                  spread: 70,
                  origin: { y: 0.6 }
                });
              }
            }).catch(err => console.warn('Confetti –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω:', err));
          }
        }

        await HeaderController.loadFooter();

      } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π:', err);
        const statsEl = document.getElementById('achievementsStats');
        if (statsEl) {
          statsEl.textContent = `–û—à–∏–±–∫–∞: ${err.message}`;
          statsEl.className = 'error-text';
        }
      }
    });
  </script>
</body>
</html>