<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî Morphe</title>

  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f97316">

  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/styles-shared.css">
  <link rel="stylesheet" href="/styles-header.css">
  <style>
    .page-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    .page-title {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--text-primary);
      margin: 0;
    }
    .today-card {
      background: linear-gradient(135deg, var(--accent), #ea580c);
      color: white;
      border-radius: 24px;
      padding: 28px;
      margin-bottom: 2rem;
      box-shadow: 0 8px 24px rgba(249, 115, 22, 0.4);
      position: relative;
      overflow: hidden;
    }
    .today-card::before {
      content: "";
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200px;
      height: 200px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
    }
    .today-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0 0 16px 0;
      position: relative;
    }
    .today-focus {
      font-size: 1rem;
      opacity: 0.9;
      margin-bottom: 20px;
      position: relative;
    }
    .start-btn {
      background: white;
      color: var(--accent);
      font-weight: 700;
      padding: 16px;
      font-size: 1.2rem;
      border-radius: 16px;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .start-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }

    .section-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 2rem 0 1.2rem 0;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .section-subtitle {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    .program-overview {
      display: flex;
      justify-content: space-between;
      background: var(--bg-surface-alt);
      padding: 16px;
      border-radius: 16px;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
    }
    .overview-item {
      text-align: center;
    }
    .overview-value {
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--accent);
    }

    .recommendation-card {
      background: var(--bg-surface);
      border-radius: 18px;
      padding: 20px;
      margin-bottom: 16px;
      border-left: 4px solid var(--accent);
      box-shadow: 0 2px 8px var(--shadow);
    }
    .recommendation-card.priority-critical { border-left-color: var(--danger); }
    .recommendation-card.priority-high { border-left-color: var(--warning); }
    .recommendation-card.priority-medium { border-left-color: var(--accent); }
    .recommendation-card.priority-low { border-left-color: var(--success); }

    .rec-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }
    .rec-title {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--text-primary);
      margin: 0;
    }
    .rec-type {
      background: var(--bg-surface-alt);
      padding: 4px 10px;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .muscle-icons {
      margin-top: 8px;
      font-size: 1.2rem;
      opacity: 0.8;
    }

    .forecast-card {
      background: var(--bg-surface);
      border-radius: 18px;
      padding: 20px;
      margin-top: 1.5rem;
      box-shadow: 0 2px 8px var(--shadow);
    }
    .forecast-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .forecast-title {
      font-weight: 700;
      color: var(--text-primary);
    }
    .trend-indicator {
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 50px;
      font-size: 0.85rem;
    }
    .trend-up { background: #ecfdf5; color: #065f46; }
    .trend-down { background: #fef2f2; color: #991b1b; }
    .trend-stable { background: #fffbeb; color: #92400e; }

    .forecast-bar {
      height: 12px;
      background: var(--border);
      border-radius: 6px;
      margin: 16px 0;
      overflow: hidden;
    }
    .forecast-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #ea580c);
      border-radius: 6px;
      transition: width 0.5s ease;
    }

    .regenerate-btn {
      width: 100%;
      margin-top: 1.5rem;
      padding: 14px;
      font-weight: 600;
      font-size: 1.05rem;
    }

    #programSelection {
      margin-bottom: 2rem;
    }
    #programSelection .recommendation-card {
      border-left: none;
      border: 1px solid var(--border);
    }

    @media (max-width: 768px) {
      .page-title { font-size: 1.5rem; }
      .today-card { padding: 20px; }
      .start-btn { padding: 14px; font-size: 1.1rem; }
      .program-overview { flex-direction: column; gap: 12px; }
    }
  </style>
</head>
<body>

  <div id="header-placeholder"></div>

  <main id="main-content" tabindex="-1">
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h1>
        <p id="workoutStatus" class="info-text" aria-live="polite">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏...</p>
      </div>

      <section id="programSelection" class="card" style="display: none;">
        <h2>üéØ –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ç–æ–≤—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É</h2>
        <div id="programOptions"></div>
      </section>

      <section id="todaySection" class="today-card" style="display: none;">
        <h2 class="today-title" id="todayTitle">‚Äî</h2>
        <p class="today-focus" id="todayFocus">–§–æ–∫—É—Å: ‚Äî</p>
        <button id="startWorkoutBtn" class="start-btn">
          ‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
        </button>
      </section>

      <div class="program-overview" id="programOverview" style="display: none;">
        <div class="overview-item">
          <div>–ü—Ä–æ–≥—Ä–∞–º–º–∞</div>
          <div class="overview-value" id="overviewName">‚Äî</div>
        </div>
        <div class="overview-item">
          <div>–ù–µ–¥–µ–ª—è</div>
          <div class="overview-value">1</div>
        </div>
        <div class="overview-item">
          <div>–î–µ–Ω—å</div>
          <div class="overview-value" id="overviewDay">1/3</div>
        </div>
      </div>

      <section id="forecastSection" class="forecast-card" style="display: none;">
        <div class="forecast-header">
          <h3 class="forecast-title">üìà –ü—Ä–æ–≥–Ω–æ–∑ —Å–∏–ª—ã: –ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è</h3>
          <span class="trend-indicator trend-up" id="trendIndicator">‚Üë –†–æ—Å—Ç</span>
        </div>
        <p><strong>–¢–µ–∫—É—â–∏–π 1–ü–ú:</strong> <span id="current1RM">‚Äî</span> –∫–≥</p>
        <p><strong>–ß–µ—Ä–µ–∑ 4 –Ω–µ–¥–µ–ª–∏:</strong> <span id="predicted1RM">‚Äî</span> –∫–≥</p>
        <div class="forecast-bar">
          <div class="forecast-fill" id="forecastFill" style="width: 0%;"></div>
        </div>
        <p id="forecastAdvice" class="section-subtitle"></p>
      </section>

      <h2 class="section-title">üß† –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
      <div id="recommendationsList"></div>

      <button id="regeneratePlan" class="btn-primary regenerate-btn" style="display: none;">
        üí• –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É
      </button>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

  <script type="module">
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { UserService } from '/services/userService.js';
    import { DataService } from '/services/dataService.js'; // ‚úÖ –ò–ú–ü–û–†–¢–ò–†–û–í–ê–ù

    const MUSCLE_EMOJI = {
      chest: 'üí™', back: 'ü¶æ', legs: 'ü¶µ', arms: 'üí™',
      shoulders: 'ü§∏', abs: 'üî•', fullbody: 'üèãÔ∏è', cardio: '‚ù§Ô∏è'
    };

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await HeaderController.loadHeader();
        new ThemeManager();

        const workoutStatus = document.getElementById('workoutStatus');
        const todaySection = document.getElementById('todaySection');
        const programOverview = document.getElementById('programOverview');
        const forecastSection = document.getElementById('forecastSection');
        const recommendationsList = document.getElementById('recommendationsList');
        const regenerateBtn = document.getElementById('regeneratePlan');

        if (!UserService.isProfileComplete()) {
          workoutStatus.textContent = "‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.";
          workoutStatus.className = "error-text";
          return;
        }

        // === –ó–ê–ì–†–£–ó–ö–ê –ì–û–¢–û–í–´–• –ü–†–û–ì–†–ê–ú–ú ===
        const profile = UserService.getRawData();
        const allPrograms = await DataService.getPrograms();
        const matchingPrograms = allPrograms.filter(p =>
          p.goal === profile.goal &&
          (p.level === 'all' || p.level === profile.level) &&
          p.workoutLocation === profile.workoutLocation
        );

        if (matchingPrograms.length > 0) {
          const optionsHtml = matchingPrograms.map(p => `
            <div class="recommendation-card">
              <h3>${p.name}</h3>
              <p>${p.description}</p>
              <small>${p.durationWeeks} –Ω–µ–¥–µ–ª—å ‚Ä¢ ${p.daysPerWeek} –¥–Ω./–Ω–µ–¥</small>
              <button class="btn-primary btn-small" data-program-id="${p.id}">
                –í—ã–±—Ä–∞—Ç—å
              </button>
            </div>
          `).join('');
          document.getElementById('programOptions').innerHTML = optionsHtml;
          document.getElementById('programSelection').style.display = 'block';
        }

        // === –ó–ê–ì–†–£–ó–ö–ê –¢–ï–ö–£–©–ï–ô –ü–†–û–ì–†–ê–ú–ú–´ ===
        let plan = null;
        try {
          const { WorkoutPlanner } = await import('/core/workoutPlanner.js');
          const planner = new WorkoutPlanner();
          await planner.init();

          plan = planner.getCurrent();
          if (!plan) {
            plan = await planner.generate();
          }

          const today = new Date().toISOString().split('T')[0];
          const todaySession = plan.schedule.find(s => s.date === today) || plan.schedule[0];
          const session = todaySession?.session;

          if (session) {
            document.getElementById('todayTitle').textContent = session.name;
            document.getElementById('todayFocus').textContent = `–§–æ–∫—É—Å: ${session.focus}`;
            document.getElementById('startWorkoutBtn').dataset.id = session.id;
            document.getElementById('startWorkoutBtn').dataset.name = session.name;
            todaySection.style.display = 'block';
          } else {
            console.warn('‚ö†Ô∏è –°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ');
          }

          document.getElementById('overviewName').textContent = plan.name || '‚Äî';
          document.getElementById('overviewDay').textContent = `${plan.schedule.findIndex(s => s.date === today) + 1}/${plan.schedule.length}`;
          programOverview.style.display = 'flex';

          regenerateBtn.style.display = 'block';
          regenerateBtn.addEventListener('click', async () => {
            regenerateBtn.disabled = true;
            regenerateBtn.innerHTML = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
            try {
              const newPlan = await planner.regenerate();
              window.location.reload();
            } catch (err) {
              alert(`–û—à–∏–±–∫–∞: ${err.message}`);
              regenerateBtn.disabled = false;
              regenerateBtn.textContent = 'üí• –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É';
            }
          });

        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã:', err);
          workoutStatus.textContent = `‚ùå ${err.message}`;
          workoutStatus.className = 'error-text';
        }

        // === –ü—Ä–æ–≥–Ω–æ–∑ —Å–∏–ª—ã ===
        try {
          const { StrengthProgress } = await import('/core/strengthProgress.js');
          const engine = new StrengthProgress();
          const history = engine.getExerciseHistory('squat-barbell');
          if (history?.length >= 3) {
            const forecast = engine.predictFutureOneRM(history, 4);
            if (forecast) {
              document.getElementById('current1RM').textContent = Math.round(forecast.current);
              document.getElementById('predicted1RM').textContent = Math.round(forecast.predicted);
              
              const max = Math.max(forecast.current, forecast.predicted) * 1.2;
              const width = (forecast.predicted / max) * 100;
              document.getElementById('forecastFill').style.width = `${width}%`;

              const trendEl = document.getElementById('trendIndicator');
              if (forecast.trend === '—Ä–æ—Å—Ç') {
                trendEl.textContent = '‚Üë –†–æ—Å—Ç';
                trendEl.className = 'trend-indicator trend-up';
              } else if (forecast.trend === '—Å–ø–∞–¥') {
                trendEl.textContent = '‚Üì –°–ø–∞–¥';
                trendEl.className = 'trend-indicator trend-down';
              } else {
                trendEl.textContent = '‚Üí –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å';
                trendEl.className = 'trend-indicator trend-stable';
              }

              const advice = forecast.predicted > forecast.current + 5 
                ? '–û—Ç–ª–∏—á–Ω—ã–π —Ç–µ–º–ø! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.' 
                : forecast.predicted < forecast.current 
                  ? '–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –ø–∏—Ç–∞–Ω–∏–µ.' 
                  : '–ü—Ä–æ–≥—Ä–µ—Å—Å —Å—Ç–∞–±–∏–ª–µ–Ω. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Ç–µ–º–ø!';
              document.getElementById('forecastAdvice').textContent = advice;

              forecastSection.style.display = 'block';
            }
          }
        } catch (e) {
          console.warn('–ü—Ä–æ–≥–Ω–æ–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', e.message);
        }

        // === –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ===
        try {
          const { ExerciseRecommender } = await import('/core/exerciseRecommender.js');
          const recommender = new ExerciseRecommender();
          const recs = await recommender.getRecommendations();

          if (recs.length > 0) {
            recommendationsList.innerHTML = recs
              .filter(r => r.exercise)
              .map(r => {
                const muscles = r.exercise.primaryMuscles || [];
                const icons = muscles.slice(0, 2).map(m => MUSCLE_EMOJI[m] || '‚ö°').join(' ');

                let priorityClass = 'priority-medium';
                if (r.priority === 'critical') priorityClass = 'priority-critical';
                else if (r.priority === 'high') priorityClass = 'priority-high';
                else if (r.priority === 'low') priorityClass = 'priority-low';

                return `
                  <div class="recommendation-card ${priorityClass}">
                    <div class="rec-header">
                      <h3 class="rec-title">${r.exercise.name}</h3>
                      <span class="rec-type">${r.exercise.type}</span>
                    </div>
                    <p>${r.reason}</p>
                    <div class="muscle-icons">${icons}</div>
                  </div>
                `;
              }).join('');
          } else {
            recommendationsList.innerHTML = '<p class="info-text">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üôå</p>';
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:', err);
          recommendationsList.innerHTML = '<p class="error-text">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.</p>';
        }

      } catch (err) {
        console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', err);
        document.getElementById('workoutStatus').textContent = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.";
        document.getElementById('workoutStatus').className = "error-text";
      }
    });

    // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–õ–ò–ö–û–í ===
    document.addEventListener('click', async (e) => {
      if (e.target.classList.contains('start-workout-btn') || e.target.id === 'startWorkoutBtn') {
        const btn = e.target;
        const id = btn.dataset.id;
        const name = encodeURIComponent(btn.dataset.name);
        window.location.href = `/pages/workout-session.html?id=${id}&name=${name}`;
      }

      if (e.target.matches('[data-program-id]')) {
        const programId = e.target.dataset.programId;
        const { WorkoutPlanner } = await import('/core/workoutPlanner.js');
        const planner = new WorkoutPlanner();
        await planner.init();
        await planner.usePredefinedProgram(programId);
        window.location.reload();
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      import('/core/HeaderController.js')
        .then(m => m.HeaderController.loadFooter())
        .catch(console.error);
    });
  </script>
</body>
</html>