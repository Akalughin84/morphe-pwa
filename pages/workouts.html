<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Morphe ‚Äî –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</title>
  <link rel="stylesheet" href="../styles.css" />
  <link rel="stylesheet" href="../styles-form.css" />

  <!-- Chart.js + date adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <style>
    /* –ü–ª–∞–≤–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ –∏ –≥—Ä–∞—Ñ–∏–∫–∞ */
    .modal-overlay {
      transition: opacity 0.3s ease;
    }
    .modal-content {
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .chart-box {
      transition: opacity 0.4s ease, transform 0.4s ease;
    }
    .error { color: #d32f2f; }
    .warning-badge { color: #ff9800; }
    .ai-advice-panel { margin: 1rem 0; padding: 1rem; background: #f1f8e9; border-radius: 8px; }
    .exercise-tip, .exercise-status { margin: 0.5rem 0; }
    .set-inline-group { display: flex; gap: 4px; margin: 4px 0; }
    .btn-tiny-disabled { opacity: 0.6; cursor: not-allowed; }
    .timer-display { font-weight: bold; margin-right: 8px; }
    .exercise-picker-grid { display: grid; gap: 10px; margin-top: 10px; }
    .exercise-picker-item { padding: 10px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; }
    .exercise-picker-item:hover { background: #f5f5f5; }
    .progress-bar-container { height: 8px; background: #e0e0e0; border-radius: 4px; margin: 8px 0; }
    .progress-bar { height: 100%; background: #4caf50; border-radius: 4px; transition: width 0.3s ease; }
    .encouragement { font-style: italic; color: #2e7d32; margin-top: 8px; }

    /* Visually hidden for screen readers */
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <!-- Skip to content link (–∫–∞–∫ –≤ index.html) -->
  <a href="#main-content" class="skip-link">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é</a>

  <header class="page-header">
    <div class="container">
      <!-- –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ —Å index.html -->
      <a href="../index.html" class="logo" aria-label="Morphe ‚Äî –Ω–∞ –≥–ª–∞–≤–Ω—É—é">
        Morphe
        <span class="visually-hidden">–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</span>
      </a>

      <!-- –ì–∞–º–±—É—Ä–≥–µ—Ä -->
      <button id="menuToggle" class="menu-toggle" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <nav id="mainNav" class="page-nav" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
        <a href="../pages/profile.html" class="nav-link">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
        <a href="../pages/nutrition.html" class="nav-link">üçΩ –ü–∏—Ç–∞–Ω–∏–µ</a>
        <a href="../pages/progress.html" class="nav-link">üìà –ü—Ä–æ–≥—Ä–µ—Å—Å</a>
        <a href="../pages/supplements.html" class="nav-link">üíä –í–∏—Ç–∞–º–∏–Ω—ã</a>
        <a href="../pages/premium.html" class="nav-link">üíé Pro</a>
      </nav>
    </div>
  </header>

  <main id="main-content" class="workouts-page">
    <div class="container">
      <h1>üìÖ –¢–≤–æ—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h1>
      <p id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</p>

      <!-- –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–µ–ª–∏ –ø–æ —Å–∏–ª–µ -->
      <button onclick="setStrengthGoal()" class="btn-secondary" style="margin-bottom: 1rem;" type="button">
        üéØ –ü–æ—Å—Ç–∞–≤–∏—Ç—å —Ü–µ–ª—å –ø–æ —Å–∏–ª–µ
      </button>

      <!-- AI-–°–æ–≤–µ—Ç–Ω–∏–∫ -->
      <div id="aiAdviceContainer"></div>

      <!-- –ü—Ä–æ–≥—Ä–∞–º–º–∞ -->
      <div id="programContainer"></div>

      <!-- –§–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ -->
      <div class="form-container" style="margin-top: 3rem;">
        <h3>üìù –ö–∞–∫ –ø—Ä–æ—à–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞?</h3>
        <div class="form-group">
          <label for="feedbackInput">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø–æ –∂–µ–ª–∞–Ω–∏—é)</label>
          <textarea 
            id="feedbackInput" 
            rows="3"
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–æ–ª–µ–ª–æ –∫–æ–ª–µ–Ω–æ –ø–æ—Å–ª–µ –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π, –Ω–µ —Å–º–æ–≥ —Å–¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–¥—Ö–æ–¥"></textarea>
        </div>
        <button onclick="completeWorkout()" class="btn-primary" type="button">
          ‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é
        </button>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é -->
      <div class="chart-box" id="exerciseChartBox" style="display:none; margin-top: 40px; opacity: 0; transform: translateY(10px);">
        <h2 id="chartTitle">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é</h2>
        <canvas id="exerciseChart" height="200"></canvas>
      </div>
    </div>
  </main>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
  <div id="exercisePickerModal" class="modal-overlay" style="display:none; opacity:0;" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content" style="opacity:0; transform: scale(0.95);">
      <h3 id="modalTitle">–í—ã–±–µ—Ä–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
      
      <!-- –§–∏–ª—å—Ç—Ä—ã -->
      <div class="form-row">
        <label for="muscleFilter" class="visually-hidden">–§–∏–ª—å—Ç—Ä –ø–æ –≥—Ä—É–ø–ø–µ –º—ã—à—Ü</label>
        <select id="muscleFilter" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ –≥—Ä—É–ø–ø–µ –º—ã—à—Ü">
          <option value="">–ì—Ä—É–ø–ø–∞ –º—ã—à—Ü</option>
          <option value="legs">–ù–æ–≥–∏</option>
          <option value="push">–ì—Ä—É–¥—å/–ü–ª–µ—á–∏</option>
          <option value="pull">–°–ø–∏–Ω–∞/–ë–∏—Ü–µ–ø—Å</option>
          <option value="core">–ö–æ—Ä–ø—É—Å</option>
        </select>
        
        <label for="equipFilter" class="visually-hidden">–§–∏–ª—å—Ç—Ä –ø–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é</label>
        <select id="equipFilter" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é">
          <option value="">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option>
          <option value="dumbbells">–ì–∞–Ω—Ç–µ–ª–∏</option>
          <option value="machine">–¢—Ä–µ–Ω–∞–∂—ë—Ä</option>
          <option value="bodyweight">–°–≤–æ–π –≤–µ—Å</option>
        </select>
      </div>

      <!-- –ü–æ–∏—Å–∫ -->
      <label for="exerciseSearch" class="visually-hidden">–ü–æ–∏—Å–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</label>
      <input type="text" id="exerciseSearch" placeholder="–ü–æ–∏—Å–∫..." style="width:100%; padding:8px; margin:10px 0;" aria-label="–ü–æ–∏—Å–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π">

      <!-- –°–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π -->
      <div id="exerciseList" class="exercise-picker-grid"></div>

      <!-- –ö–Ω–æ–ø–∫–∏ -->
      <div style="margin-top: 1rem; text-align: right;">
        <button onclick="closeExercisePicker()" class="btn-secondary" type="button">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ JS –æ—Ç–∫–ª—é—á–µ–Ω -->
  <noscript>
    <div style="background: #ffebee; color: #c62828; padding: 1rem; margin: 1rem; border-radius: 8px; text-align: center;">
      ‚ö†Ô∏è –î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º JavaScript. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∫–ª—é—á–∏—Ç–µ –µ–≥–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.
    </div>
  </noscript>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('‚úÖ SW –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', reg.scope))
          .catch(err => console.log('‚ùå –û—à–∏–±–∫–∞ SW:', err));
      });
    }
  </script>

  <!-- –ú–æ–¥—É–ª–∏ -->
  <script type="module">
    import { MorpheProfile } from '../modules/profile.js';
    import { WorkoutPlanner } from '../core/workoutPlanner.js';
    import { WorkoutTracker } from '../modules/workoutTracker.js';
    import { StrengthGoalTracker } from '../core/strengthGoalTracker.js';

    const profile = new MorpheProfile();
    const statusEl = document.getElementById('status');
    const aiAdviceContainer = document.getElementById('aiAdviceContainer');
    const programContainer = document.getElementById('programContainer');

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–∫–µ—Ä–∞ ===
    const workoutTracker = new WorkoutTracker();
    const history = workoutTracker.history || []; // –ó–∞—â–∏—Ç–∞ –æ—Ç undefined

    if (!profile.isComplete()) {
      statusEl.innerHTML = `
        <p>‚ùå –ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É, —Å–Ω–∞—á–∞–ª–∞ <a href="../pages/profile.html">–∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</a>.</p>
      `;
      programContainer.style.display = 'none';
      throw new Error("–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω");
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º ===
    let exercises = [];
    let searchTimeout = null;

    async function loadExercises() {
      // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ localStorage
      const cached = localStorage.getItem('morphe_exercises');
      if (cached) {
        exercises = JSON.parse(cached);
        return;
      }

      try {
        const response = await fetch('../data/exercises.json');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        exercises = data.exercises || [];
        localStorage.setItem('morphe_exercises', JSON.stringify(exercises));
      } catch (e) {
        console.error("Failed to load exercises:", e);
        document.getElementById('exerciseList').innerHTML = '<p class="error">‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.</p>';
      }
    }

    // === –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ===
    const planner = new WorkoutPlanner(profile.data, history);
    let weeklyPlan = [];

    try {
      weeklyPlan = planner.plan();
    } catch (e) {
      statusEl.innerHTML = `<p class="error">‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã: ${e.message}</p>`;
      console.error(e);
      programContainer.style.display = 'none';
      throw e;
    }

    // === –¶–µ–ª—å –ø–æ —Å–∏–ª–µ ===
    const strengthGoalTracker = new StrengthGoalTracker(profile.data, { 
      workoutTracker: history 
    });
    strengthGoalTracker.load();

    // === –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–ª–∏ –ø–æ —Å–∏–ª–µ ===
    if (strengthGoalTracker.goal) {
      const status = strengthGoalTracker.getStatus();
      aiAdviceContainer.innerHTML = `
        <div class="ai-advice-panel">
          <h3>üéØ –¶–µ–ª—å: ${status.goal.exerciseName}</h3>
          <p><strong>–¢–µ–∫—É—â–∏–π –≤–µ—Å:</strong> ${status.currentWeight} –∫–≥</p>
          <p><strong>–¶–µ–ª—å:</strong> ${status.goal.targetWeight} –∫–≥</p>
          <p><strong>–û—Å—Ç–∞–ª–æ—Å—å:</strong> ${status.daysLeft} –¥–Ω–µ–π</p>
          
          <div class="progress-bar-container">
            <div class="progress-bar" style="width: ${status.progress}%"></div>
          </div>
          <p>${status.progress}% –∑–∞–≤–µ—Ä—à–µ–Ω–æ</p>

          ${status.weeklyGainNeeded > 0 
            ? `<p><small>–ù—É–∂–Ω–æ –ø—Ä–∏–±–∞–≤–ª—è—Ç—å: ${status.weeklyGainNeeded} –∫–≥/–Ω–µ–¥</small></p>` 
            : ''}

          <p class="encouragement">${status.encouragement}</p>
        </div>
      `;
    }

    // === –†–µ–Ω–¥–µ—Ä –ø—Ä–æ–≥—Ä–∞–º–º—ã ===
    function renderProgram(plan) {
      statusEl.textContent = "";

      programContainer.innerHTML = plan.map(day => renderDay(day)).join('');

      initTimers();
    }

    function renderDay(day) {
      if (day.type === 'rest') {
        return `
          <div class="workout-day rest">
            <h3>üõå ${day.name}</h3>
            <p>${day.description || '–û—Ç–¥–æ—Ö–Ω–∏, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Å—å, –≥–æ—Ç–æ–≤—å—Å—è –∫ —Å–ª–µ–¥—É—é—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ.'}</p>
          </div>
        `;
      } else {
        return `
          <div class="workout-day">
            <h3>üí™ ${day.name}</h3>
            ${day.warning ? `<p class="warning-badge">‚ö†Ô∏è ${day.warning}</p>` : ''}
            ${day.description ? `<p><em>${day.description}</em></p>` : ''}
            <ul>
              ${day.exercises.map(ex => renderExercise(ex)).join('')}
            </ul>
          </div>
        `;
      }
    }

    function renderExercise(ex) {
      const lastPerf = workoutTracker.getLastPerformance(ex.id);
      return `
        <li class="exercise-item">
          <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
          <div class="exercise-header">
            <strong>${ex.name}</strong>
            <span class="recommended-weight">${ex.sets}√ó${ex.reps}, –æ—Ç–¥—ã—Ö: ${ex.rest}</span>
          </div>

          <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –∏ —Å—Ç–∞—Ç—É—Å -->
          ${getExerciseTip(ex.id)}
          ${getProgressStatus(ex.id, ex.name)}

          <!-- –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–≤–æ–¥ –ø–æ–¥—Ö–æ–¥–æ–≤ -->
          <div class="set-tracker-inline" data-exercise-id="${ex.id}">
            ${Array.from({ length: parseInt(ex.sets) || 4 }).map((_, i) => `
              <div class="set-inline-group">
                <input type="number" placeholder="–ø–æ–≤—Ç" class="reps-input" min="1" max="30" aria-label="–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è, –ø–æ–¥—Ö–æ–¥ ${i+1}">
                <input type="number" placeholder="–∫–≥" class="weight-input" step="0.5" min="0" aria-label="–í–µ—Å, –ø–æ–¥—Ö–æ–¥ ${i+1}">
                <select class="rpe-select" aria-label="RPE, –ø–æ–¥—Ö–æ–¥ ${i+1}">
                  <option value="">RPE</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                </select>
              </div>
            `).join('')}
          </div>

          <!-- –§—É—Ç–µ—Ä: —Ç–∞–π–º–µ—Ä –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
          <div class="exercise-footer">
            <div class="timer-controls">
              <div class="timer-display">00:00</div>
              <button class="timer-btn" data-duration="${getRestSeconds(ex.rest)}" type="button" aria-label="–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä –æ—Ç–¥—ã—Ö–∞">‚è±Ô∏è</button>
            </div>
            <div class="exercise-actions">
              <button onclick="saveExercise('${ex.id}', this)" class="btn-tiny" type="button" aria-label="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–¥—Ö–æ–¥">‚úÖ</button>
              <button onclick="showExerciseChart('${ex.id}', '${ex.name}')" class="btn-tiny" type="button" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞">üìä</button>
              <button onclick="openExercisePicker('${ex.id}', this)" class="btn-tiny" type="button" aria-label="–ó–∞–º–µ–Ω–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ">‚öôÔ∏è</button>
            </div>
          </div>
        </li>
      `;
    }

    // === –ü–û–î–°–ö–ê–ó–ö–ò –ü–û –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø–ú ===
    function getExerciseTip(exerciseId) {
      const tips = {
        'goblet_squat': `
          <div class="exercise-tip">
            <small>‚ÑπÔ∏è <strong>–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è:</strong> –°–ø–∏–Ω–∞ –ø—Ä—è–º–∞—è, –≥—Ä—É–¥—å –≤–ø–µ—Ä—ë–¥. –ö–æ–ª–µ–Ω–∏ ‚Äî –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Å—Ç–æ–ø.</small>
          </div>`,
        'db_bench_press': `
          <div class="exercise-tip">
            <small>‚ÑπÔ∏è <strong>–ñ–∏–º –ª—ë–∂–∞:</strong> –õ–æ–ø–∞—Ç–∫–∏ —Å–≤–æ–¥–∏, –Ω–æ–≥–∏ —É–ø–∏—Ä–∞–π—Å—è. –ù–µ –æ—Ç—Ä—ã–≤–∞–π –ø–æ—è—Å–Ω–∏—Ü—É.</small>
          </div>`,
        'overhead_press': `
          <div class="exercise-tip">
            <small>‚ÑπÔ∏è <strong>–ñ–∏–º —Å—Ç–æ—è:</strong> –ö–æ—Ä–ø—É—Å –Ω–∞–ø—Ä—è–∂—ë–Ω, –≤–µ—Å –Ω–∞–¥ —Ü–µ–Ω—Ç—Ä–æ–º. –ù–µ –ø–µ—Ä–µ–≥–∏–±–∞–π –ø–æ—è—Å–Ω–∏—Ü—É.</small>
          </div>`,
        'row_incline': `
          <div class="exercise-tip">
            <small>‚ÑπÔ∏è <strong>–¢—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏:</strong> –°–ø–∏–Ω–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞ –ø–æ–ª—É. –¢—è–Ω–∏—Ç–µ –ª–æ–∫—Ç–µ–º, –∞ –Ω–µ —Ä—É–∫–æ–π.</small>
          </div>`
      };
      return tips[exerciseId] || '';
    }

    // === –°–¢–ê–¢–£–° –ü–†–û–ì–†–ï–°–°–ê –ü–û –£–ü–†–ê–ñ–ù–ï–ù–ò–Æ ===
    function getProgressStatus(exerciseId, exerciseName) {
      const lastPerf = workoutTracker.getLastPerformance(exerciseId);
      if (!lastPerf) return '';

      const history = workoutTracker.getExerciseHistory(exerciseId);
      if (history.length < 2) return '';

      const firstWeight = history[0].y;
      const lastWeight = history[history.length - 1].y;
      const change = lastWeight - firstWeight;

      if (change <= 0) return '';

      const days = (new Date(history[history.length - 1].x) - new Date(history[0].x)) / (1000 * 60 * 60 * 24);
      const weeks = days / 7;
      const weeklyGain = weeks > 0 ? (change / weeks).toFixed(2) : 0;

      return `
        <div class="exercise-status">
          <small>üìà –†–æ—Å—Ç: +${weeklyGain} –∫–≥/–Ω–µ–¥ | –ü–∏–∫: ${lastWeight} –∫–≥</small>
        </div>
      `;
    }

    // === –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ü–†–û–ì–†–ê–ú–ú–´ ===
    renderProgram(weeklyPlan);

    // === AI-—Å–æ–≤–µ—Ç–Ω–∏–∫ ===
    function showAIAdvice() {
      const safeHistory = Array.isArray(history) ? history : [];
      const lastWorkouts = safeHistory.slice(-3);

      if (lastWorkouts.length === 0) return;

      const avgRPE = lastWorkouts.reduce((a, w) => a + (parseFloat(w.summary?.avgRPE) || 0), 0) / lastWorkouts.length;

      const advicePanel = document.createElement('div');
      advicePanel.className = 'ai-advice-panel';
      advicePanel.innerHTML = `
        <h3>ü§ñ Morphe AI: –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ä–º—ã</h3>
        <div class="advice-item advice-info">
          ${avgRPE > 8.5 
            ? '‚ö†Ô∏è <strong>–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞</strong> –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–∞–∑–≥—Ä—É–∑–∫—É –∏–ª–∏ —Å–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞.' 
            : '‚úÖ <strong>–¢–µ–º–ø –Ω–∞–≥—Ä—É–∑–∫–∏ –≤ –Ω–æ—Ä–º–µ.</strong> –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ —Ç–µ–º–ø–µ.'}
        </div>
      `;

      if (!document.querySelector('#aiAdviceContainer .ai-advice-panel')) {
        aiAdviceContainer.appendChild(advicePanel);
      }
    }

    showAIAdvice();

    // === –¢–ê–ô–ú–ï–† ===
    function initTimers() {
      document.querySelectorAll('.timer-btn').forEach(btn => {
        const duration = parseInt(btn.dataset.duration) || 60;
        const display = btn.parentElement.querySelector('.timer-display');
        
        btn.addEventListener('click', () => startTimer(btn, display, duration));
      });
    }

    function startTimer(button, display, duration) {
      let timeLeft = duration;
      display.textContent = formatTime(timeLeft);
      button.disabled = true;
      button.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ...";

      const timer = setInterval(() => {
        timeLeft--;
        display.textContent = formatTime(timeLeft);

        if (timeLeft <= 0) {
          clearInterval(timer);
          button.disabled = false;
          button.textContent = "‚úÖ";
          playBeep();
        }
      }, 1000);
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
      const secs = (seconds % 60).toString().padStart(2, '0');
      return `${mins}:${secs}`;
    }

    function getRestSeconds(restText) {
      const map = { '60 —Å–µ–∫': 60, '75 —Å–µ–∫': 75, '90 —Å–µ–∫': 90 };
      return map[restText] || 60;
    }

    function playBeep() {
      try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
        
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.5);
      } catch (e) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫:", e);
      }
    }

    // === –í–ï–î–ï–ù–ò–ï –ü–û–î–•–û–î–û–í ===
    let userInput = {};

    window.saveExercise = function(exerciseId, button) {
      const row = button.closest('.exercise-item');
      const setGroups = row.querySelectorAll('.set-inline-group');
      const completedSets = [];

      let valid = true;

      setGroups.forEach((group, index) => {
        const repsInput = group.querySelector('.reps-input');
        const weightInput = group.querySelector('.weight-input');
        const rpeSelect = group.querySelector('.rpe-select');

        const reps = repsInput.value.trim() ? parseFloat(repsInput.value) : null;
        const weight = weightInput.value.trim() ? parseFloat(weightInput.value) : null;
        const rpe = rpeSelect.value;

        // –í–∞–ª–∏–¥–∞—Ü–∏—è: –µ—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ —á—Ç–æ-—Ç–æ –æ–¥–Ω–æ ‚Äî —Ç—Ä–µ–±—É–µ–º –∏ –≤—Ç–æ—Ä–æ–µ
        if ((reps !== null && !weight) || (weight !== null && !reps)) {
          alert(`–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏ –≤–µ—Å, –∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –¥–ª—è –ø–æ–¥—Ö–æ–¥–∞ ${index + 1}`);
          valid = false;
          return;
        }

        if (reps !== null || weight !== null || rpe) {
          completedSets.push({
            set: index + 1,
            reps: reps || 0,
            weight: weight || 0,
            rpe: rpe || null
          });
        }
      });

      if (!valid) return;

      userInput[exerciseId] = { exerciseId, completedSets };

      // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
      button.textContent = "‚úÖ";
      button.disabled = true;
      button.classList.replace('btn-tiny', 'btn-tiny-disabled');

      playBeep();
    };

    // === –ó–ê–í–ï–†–®–ï–ù–ò–ï –¢–†–ï–ù–ò–†–û–í–ö–ò ===
    window.completeWorkout = function() {
      const feedback = document.getElementById('feedbackInput').value.trim();

      // –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ç—Ä–∞–≤–º
      const injuryKeywords = ['–±–æ–ª—å', '–±–æ–ª–∏—Ç', '—Ç—Ä–∞–≤–º–∞', '—Ç—è–Ω—É', '–ø–æ—Ç—è–Ω—É–ª'];
      const shoulderWords = ['–ø–ª–µ—á–æ', '–¥–µ–ª—å—Ç–∞', '—Ä—É–∫–∞'];
      const kneeWords = ['–∫–æ–ª–µ–Ω–æ', '–Ω–æ–≥–∞'];

      let detectedInjuries = [];

      if (injuryKeywords.some(k => feedback.toLowerCase().includes(k))) {
        if (shoulderWords.some(k => feedback.toLowerCase().includes(k))) detectedInjuries.push('shoulder');
        if (kneeWords.some(k => feedback.toLowerCase().includes(k))) detectedInjuries.push('knee');
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç—Ä–∞–≤–º—ã –≤ –ø—Ä–æ—Ñ–∏–ª—å
      if (detectedInjuries.length > 0) {
        profile.data.injuries = detectedInjuries;
        profile.save();
        
        // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –∑–∞–º–µ–Ω—É
        setTimeout(() => {
          const needsReplacement = weeklyPlan.flatMap(day => 
            day.exercises?.filter(ex => 
              ex.injuryRisk?.some(risk => detectedInjuries.includes(risk))
            ) || []
          );

          if (needsReplacement.length > 0) {
            const names = needsReplacement.map(ex => ex.name).join(', ');
            if (confirm(`–í—ã —É–ø–æ–º—è–Ω—É–ª–∏ –±–æ–ª—å. –•–æ—á–µ—à—å –∑–∞–º–µ–Ω–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: ${names}?`)) {
              needsReplacement.forEach(ex => openExercisePicker(ex.id, null));
            }
          }
        }, 500);
      }

      try {
        const completedWorkout = workoutTracker.logWorkout(
          weeklyPlan,
          Object.values(userInput),
          feedback
        );
        alert(`‚úÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!`);
        // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É –∏–ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
        alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.");
      }
    };

    // === –ì–†–ê–§–ò–ö –ü–†–û–ì–†–ï–°–°–ê ===
    let exerciseChart = null;

    window.showExerciseChart = function(exerciseId, exerciseName) {
      const rawHistory = workoutTracker.getExerciseHistory(exerciseId);
      if (rawHistory.length === 0) {
        alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞.");
        return;
      }

      // –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –¥–∞—Ç –∫ —Ñ–æ—Ä–º–∞—Ç—É, –ø–æ–Ω—è—Ç–Ω–æ–º—É Chart.js
      const history = rawHistory.map(item => ({
        ...item,
        x: new Date(item.x).toISOString() // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º ISO-—Ñ–æ—Ä–º–∞—Ç
      }));

      const ctx = document.getElementById('exerciseChart').getContext('2d');
      if (exerciseChart) exerciseChart.destroy();

      exerciseChart = new Chart(ctx, {
        type: 'line',
         data: {
          datasets: [{
            label: '–í–µ—Å (–∫–≥)',
            data: history,
            borderColor: '#2E7D32',
            backgroundColor: 'rgba(46,125,50,0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointBackgroundColor: '#2E7D32'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => `–í–µ—Å: ${context.parsed.y} –∫–≥, –ü–æ–≤—Ç–æ—Ä—ã: ${context.raw.reps}, RPE: ${context.raw.rpe}`
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: { 
                unit: 'day', 
                tooltipFormat: 'dd MMM',
                displayFormats: { day: 'dd MMM' } 
              },
              title: { display: true, text: '–î–∞—Ç–∞' }
            },
            y: {
              title: { display: true, text: '–ö–∏–ª–æ–≥—Ä–∞–º–º—ã' },
              beginAtZero: false
            }
          }
        }
      });

      document.getElementById('chartTitle').textContent = `üìä –ü—Ä–æ–≥—Ä–µ—Å—Å: ${exerciseName}`;
      const chartBox = document.getElementById('exerciseChartBox');
      chartBox.style.display = 'block';
      setTimeout(() => {
        chartBox.style.opacity = '1';
        chartBox.style.transform = 'translateY(0)';
      }, 50);
    };

    // === –ö–ê–°–¢–û–ú–ò–ó–ê–¶–ò–Ø –£–ü–†–ê–ñ–ù–ï–ù–ò–ô ===
    let currentExerciseId = null;
    let currentButton = null;

    window.openExercisePicker = async function(exerciseId, button) {
      currentExerciseId = exerciseId;
      currentButton = button;

      const modal = document.getElementById('exercisePickerModal');
      const modalContent = modal.querySelector('.modal-content');
      
      modal.style.display = 'flex';
      setTimeout(() => {
        modal.style.opacity = '1';
        modalContent.style.opacity = '1';
        modalContent.style.transform = 'scale(1)';
      }, 10);

      await loadExercises();
      renderExerciseList();

      // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ debounce –Ω–∞ –ø–æ–∏—Å–∫
      const searchInput = document.getElementById('exerciseSearch');
      searchInput.removeEventListener('input', handleSearchInput); // –∏–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–µ–π
      searchInput.addEventListener('input', handleSearchInput);
    };

    function handleSearchInput(e) {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        renderExerciseList();
      }, 300);
    }

    window.closeExercisePicker = function() {
      const modal = document.getElementById('exercisePickerModal');
      const modalContent = modal.querySelector('.modal-content');
      
      modalContent.style.opacity = '0';
      modalContent.style.transform = 'scale(0.95)';
      modal.style.opacity = '0';
      
      setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = ''; // —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
      }, 300);
    };

    function renderExerciseList() {
      const list = document.getElementById('exerciseList');
      const muscleFilter = document.getElementById('muscleFilter').value;
      const equipFilter = document.getElementById('equipFilter').value;
      const searchQuery = document.getElementById('exerciseSearch').value.toLowerCase();

      const filtered = exercises.filter(ex => {
        const matchesMuscle = !muscleFilter || 
          ex.muscleGroup?.primary?.includes(muscleFilter) || 
          ex.activityType === muscleFilter;
        
        const matchesEquip = !equipFilter || ex.equipment?.includes(equipFilter);
        
        const matchesSearch = !searchQuery || ex.name.toLowerCase().includes(searchQuery);
        
        const safeForInjuries = !(profile.data.injuries?.length > 0 && 
          ex.injuryRisk?.some(risk => profile.data.injuries.includes(risk)));

        return matchesMuscle && matchesEquip && matchesSearch && safeForInjuries;
      });

      if (filtered.length === 0) {
        list.innerHTML = '<p>–ù–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É.</p>';
        return;
      }

      list.innerHTML = filtered.map(ex => `
        <div class="exercise-picker-item" onclick="selectNewExercise('${ex.id}', '${ex.name}')">
          <strong>${ex.name}</strong>
          <small>${ex.description || ''}</small>
        </div>
      `).join('');
    }

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
    window.selectNewExercise = function(newId, newName) {
      let found = false;
      for (const day of weeklyPlan) {
        if (day.type !== 'rest') {
          const ex = day.exercises.find(e => e.id === currentExerciseId);
          if (ex) {
            ex.id = newId;
            ex.name = newName;
            found = true;
            break;
          }
        }
      }

      if (found && currentButton) {
        const row = currentButton.closest('.exercise-item');
        row.querySelector('strong').textContent = newName;
      }

      saveUserPreference(currentExerciseId, newId);

      closeExercisePicker();
      playBeep();
      alert(`‚úÖ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞: ${newName}`);
    };

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
    function saveUserPreference(oldId, newId) {
      const prefs = JSON.parse(localStorage.getItem('morphe_exercise_prefs') || '{}');
      prefs[oldId] = newId;
      localStorage.setItem('morphe_exercise_prefs', JSON.stringify(prefs));
    }

    // === –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–ª–∏ –ø–æ —Å–∏–ª–µ ===
    window.setStrengthGoal = function() {
      const exerciseId = prompt(
        "–í–≤–µ–¥–∏—Ç–µ ID —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:\n" +
        "goblet_squat ‚Äî –ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è\n" +
        "db_bench_press ‚Äî –ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª—ë–∂–∞\n" +
        "overhead_press ‚Äî –ñ–∏–º —Å—Ç–æ—è"
      );

      if (!exerciseId) return;

      const exerciseName = {
        'goblet_squat': '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è —Å –≥–∞–Ω—Ç–µ–ª—å—é',
        'db_bench_press': '–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª—ë–∂–∞',
        'overhead_press': '–ñ–∏–º —Å—Ç–æ—è'
      }[exerciseId] || exerciseId;

      const targetWeight = parseFloat(prompt("–ù–∞ –∫–∞–∫–æ–π –≤–µ—Å —Ö–æ—á–µ—à—å –≤—ã–π—Ç–∏? (–∫–≥)", "100"));
      const weeks = parseInt(prompt("–ó–∞ —Å–∫–æ–ª—å–∫–æ –Ω–µ–¥–µ–ª—å?", "8"));

      if (isNaN(targetWeight) || isNaN(weeks) || targetWeight <= 0 || weeks <= 0) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞.");
        return;
      }

      strengthGoalTracker.setGoal(exerciseId, exerciseName, targetWeight, weeks);
      alert(`üéØ –¶–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ${exerciseName} ‚Üí ${targetWeight} –∫–≥ –∑–∞ ${weeks} –Ω–µ–¥–µ–ª—å!`);
      location.reload();
    };

    // === –ì–∞–º–±—É—Ä–≥–µ—Ä-–º–µ–Ω—é ===
    const menuToggle = document.getElementById('menuToggle');
    const mainNav = document.getElementById('mainNav');

    if (menuToggle && mainNav) {
      menuToggle.addEventListener('click', () => {
        menuToggle.classList.toggle('active');
        mainNav.classList.toggle('active');
      });

      document.querySelectorAll('.page-nav a').forEach(link => {
        link.addEventListener('click', () => {
          menuToggle.classList.remove('active');
          mainNav.classList.remove('active');
        });
      });

      document.addEventListener('click', (e) => {
        if (!mainNav.contains(e.target) && !menuToggle.contains(e.target)) {
          menuToggle.classList.remove('active');
          mainNav.classList.remove('active');
        }
      });
    }

    // === –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞: –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ Esc ===
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('exercisePickerModal');
        if (modal.style.display === 'flex') {
          closeExercisePicker();
        }
      }
    });

    // === –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–∫—Ä–æ–ª–ª–∞ body –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ ===
    const modal = document.getElementById('exercisePickerModal');
    modal.addEventListener('transitionend', () => {
      if (modal.style.display === 'flex' && modal.style.opacity === '1') {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    });

  </script>
</body>
</html>