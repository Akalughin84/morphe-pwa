<!-- /pages/workouts.html -->
<!-- v4.1.0 ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –¥—É–±–ª–∏, –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞, –µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å -->

<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî Morphe</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">

  <!-- –°—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/styles-shared.css">

  <style>
    .skip-link {
      position: absolute;
      top: -40px;
      left: 10px;
      background: #000;
      color: #fff;
      padding: 8px;
      text-decoration: none;
      z-index: 1000;
      transition: top 0.3s;
      border: 2px solid transparent;
    }
    .skip-link:focus {
      top: 10px;
      outline: 2px solid #fff;
    }

    /* –°–ø–∏–Ω–Ω–µ—Ä */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
    .empty-state {
      text-align: center;
      padding: 32px;
      color: #666;
    }

    /* –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π */
    .priority-high { border-left: 4px solid #e74c3c; }
    .priority-medium { border-left: 4px solid #f39c12; }
    .priority-low { border-left: 4px solid #2ecc71; }

    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .error-text { color: #e74c3c; font-weight: 500; }
    .success-text { color: #2ecc71; font-weight: 500; }
    .info-text { color: #3498db; font-weight: 500; }

    /* –ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∏ –±–∞–ª–∞–Ω—Å–∞ */
    .recommendation-card {
      border-left: 4px solid #3498db;
      background: var(--bg-surface-alt);
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
    }

    .recommendation-card.priority-high {
      border-left-color: #e74c3c;
    }

    .recommendation-card.priority-medium {
      border-left-color: #f39c12;
    }

    .recommendation-card.priority-low {
      border-left-color: #2ecc71;
    }

    .rec-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 50px;
      background: var(--accent);
      color: white;
      font-size: 0.8rem;
    }

    /* –ü—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ */
    .program-schedule {
      background: var(--bg-surface);
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }

    .schedule-day {
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .schedule-day:last-child {
      border-bottom: none;
    }

    .day-title {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .day-focus {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .exercise-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .exercise-item {
      padding: 4px 0;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ —à–∞–ø–∫–∏ -->
  <div id="header-placeholder"></div>

  <main id="main-content" tabindex="-1">
    <div class="container">
      <h1>üí™ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h1>

      <!-- –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ -->
      <section class="card" id="currentPlanSection" style="display: none;" aria-labelledby="currentPlanHeading">
        <h2 id="currentPlanHeading">üéØ –í–∞—à–∞ —Ç–µ–∫—É—â–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h2>
        <p><strong id="planName">‚Äî</strong></p>
        <p id="planRecommendation">‚Äî</p>
        <div id="planSchedule" class="program-schedule"></div>
        <button id="regeneratePlan" class="btn-outline btn-small" aria-label="–û–±–Ω–æ–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É</button>
      </section>
      <p id="planStatus" aria-live="polite">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã...</p>

      <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º -->
      <section class="card" id="recommendationsSection" style="display: none;" aria-labelledby="recommendationsHeading">
        <h2 id="recommendationsHeading">üß† –í–∞–º —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç</h2>
        <div id="recommendationsList"></div>
        <p><small>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –≤–∞—à–µ–π —Ü–µ–ª–∏, —É—Ä–æ–≤–Ω–µ –∏ –∏—Å—Ç–æ—Ä–∏–∏.</small></p>
      </section>
      <p id="recStatus" aria-live="polite">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π...</p>

      <!-- –ü—Ä–æ–≥—Ä–∞–º–º—ã -->
      <p id="workoutStatus" aria-live="polite">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º...</p>
      <div id="programsContainer" style="display: none;"></div>
      <div id="noPrograms" style="display: none;">
        <p>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>
      </div>
    </div>
  </main>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ –ø–æ–¥–≤–∞–ª–∞ -->
  <div id="footer-placeholder"></div>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

  <!-- –õ–æ–≥–∏–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
  <script type="module">
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { WorkoutTracker } from '/modules/workoutTracker.js';
    import { UserService } from '/services/userService.js';

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // === 1. –ó–∞–≥—Ä—É–∑–∫–∞ UI ===
        await HeaderController.loadHeader();
        new ThemeManager();

        // === 2. –≠–ª–µ–º–µ–Ω—Ç—ã DOM ===
        const workoutStatus = document.getElementById('workoutStatus');
        const programsContainer = document.getElementById('programsContainer');
        const noPrograms = document.getElementById('noPrograms');

        const planStatus = document.getElementById('planStatus');
        const currentPlanSection = document.getElementById('currentPlanSection');
        const regenerateBtn = document.getElementById('regeneratePlan');

        const recStatus = document.getElementById('recStatus');
        const recommendationsSection = document.getElementById('recommendationsSection');
        const recommendationsList = document.getElementById('recommendationsList');

        // === 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è ===
        if (!UserService.isProfileComplete()) {
          workoutStatus.textContent = "‚ùå –ß—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å.";
          workoutStatus.className = "error-text";
          return;
        }

        const profileData = UserService.getRawData();
        console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω:', profileData);

        // === 4. –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º ===
        let programs = [];
        try {
          const { WorkoutPlanner } = await import('../core/workoutPlanner.js');
          const planner = new WorkoutPlanner();
          await planner.init();

          // ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¢–û–õ–¨–ö–û –û–î–ù–£ –ø—Ä–æ–≥—Ä–∞–º–º—É ‚Äî —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
          const program = await planner.generateWeeklyProgram();
          programs = [{
            id: program.id,
            name: program.name,
            level: program.level,
            daysPerWeek: program.daysPerWeek,
            description: `–£–Ω–∏–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å —Ä–æ—Ç–∞—Ü–∏–µ–π —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∏ —Ç–µ—Ö–Ω–∏–∫. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ ${new Date().toLocaleDateString('ru-RU')}.`,
            goal: program.goal
          }];

        } catch (err) {
          console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã:', err);
          noPrograms.style.display = 'block';
          return;
        }

        const userGoal = profileData.goal;
        const userLevel = profileData.level;

        const filtered = programs.filter(p => 
          p.goal === userGoal && 
          p.level === userLevel
        );

        if (filtered.length === 0) {
          programsContainer.innerHTML = `
            <p class="empty-state">
              –ü–æ–¥ –≤–∞—à—É —Ü–µ–ª—å <strong>${userGoal}</strong> –∏ —É—Ä–æ–≤–µ–Ω—å <strong>${userLevel}</strong> –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º.
              –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ü–µ–ª—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ.
            </p>
          `;
        } else {
          programsContainer.innerHTML = filtered.map(program => `
            <div class="card workout-card">
              <h3>${program.name}</h3>
              <p><strong>–£—Ä–æ–≤–µ–Ω—å:</strong> ${program.level}</p>
              <p><strong>–î–Ω–µ–π –≤ –Ω–µ–¥–µ–ª—é:</strong> ${program.daysPerWeek}</p>
              <p>${program.description}</p>
              <button 
                class="btn-primary btn-small start-workout-btn"
                data-name="${program.name}"
                data-id="${program.id}"
                aria-label="–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É: ${program.name}">
                –ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
              </button>
            </div>
          `).join('');
        }

        programsContainer.style.display = 'block';
        workoutStatus.style.display = 'none';

        // === 5. –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã ===
        const renderCurrentPlan = (plan) => {
          document.getElementById('planName').textContent = plan.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
          document.getElementById('planRecommendation').textContent = 
            `–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ${
              {
                increase: '—É–≤–µ–ª–∏—á–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É',
                maintain: '—Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–µ–º–ø',
                reduce: '—Å–Ω–∏–∑–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É'
              }[plan.recommendation] || '–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å'
            }`;

          // ‚úÖ –ö–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞ –≤–º–µ—Å—Ç–æ "–î–µ–Ω—å 1, –î–µ–Ω—å 2"
          const scheduleHtml = plan.schedule.map(s => `
            <div class="schedule-day">
              <div class="day-title">${s.session.name}</div>
              <div class="day-focus">–§–æ–∫—É—Å: ${s.focus}</div>
              <ul class="exercise-list">
                ${s.session.exercises.map(ex => `
                  <li class="exercise-item">${ex.name} ‚Äî ${ex.sets}√ó${ex.reps} (${ex.technique})</li>
                `).join('')}
              </ul>
            </div>
          `).join('');

          document.getElementById('planSchedule').innerHTML = scheduleHtml;

          planStatus.style.display = 'none';
          currentPlanSection.style.display = 'block';
        };

        // === –û–±—ä—è–≤–ª—è–µ–º plan –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –æ–Ω–∞ –±—ã–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ–∑–∂–µ ===
        let plan = null;

        // === –ó–∞–≥—Ä—É–∑–∫–∞/–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã ===
        try {
          const { WorkoutPlanner } = await import('../core/workoutPlanner.js');
          const planner = new WorkoutPlanner();
          
          await planner.init();

          plan = planner.getCurrent();

          if (!plan) {
            planStatus.textContent = "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã...";
            plan = await planner.generate();
          }

          renderCurrentPlan(plan);

          // === –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–ª–∞—Ç–æ ===
          if (planner.isPlateaued()) {
            const recommendationEl = document.getElementById('planRecommendation');

            recommendationEl.insertAdjacentHTML('beforeend', `
              <br><strong style="color: #e74c3c;">‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ø–ª–∞—Ç–æ.</strong>
              <button id="breakPlateauBtn" class="btn-warning btn-small" style="margin-top: 0.5rem;">
                üí• –°–º–µ–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É
              </button>
            `);

            document.getElementById('breakPlateauBtn').addEventListener('click', async () => {
              if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–º–µ–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É? –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –≤—ã–π—Ç–∏ –∏–∑ –∑–∞—Å—Ç–æ—è.")) {
                try {
                  const newPlan = await planner.regenerate();
                  renderCurrentPlan(newPlan);
                } catch (err) {
                  console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã:', err);
                  alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É.');
                }
              }
            });
          }

          regenerateBtn?.addEventListener('click', async () => {
            if (regenerateBtn.disabled) return;

            regenerateBtn.disabled = true;
            regenerateBtn.innerHTML = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è... <span class="spinner"></span>';

            try {
              const newPlan = await planner.regenerate();
              renderCurrentPlan(newPlan);

              const plateauBtn = document.getElementById('breakPlateauBtn');
              if (plateauBtn) {
                const parent = plateauBtn.closest('strong')?.parentElement;
                if (parent) parent.remove();
              }

            } catch (err) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã:', err);
              planStatus.textContent = `–û—à–∏–±–∫–∞: ${err.message}`;
              planStatus.className = "error-text";
              planStatus.style.display = 'block';
            } finally {
              regenerateBtn.disabled = false;
              regenerateBtn.textContent = "–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É";
            }
          });

        } catch (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã:', err);
          planStatus.textContent = `–û—à–∏–±–∫–∞: ${err.message}`;
          planStatus.className = "error-text";
        }

        // === 6. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º ===
        try {
          const { ExerciseRecommender } = await import('../core/exerciseRecommender.js');
          const recommender = new ExerciseRecommender();
          const recommendations = await recommender.getRecommendations();

          if (recommendations.length === 0) {
            recStatus.textContent = "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.";
            recStatus.style.display = 'block';
            return;
          }

          // ‚úÖ –ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å —Å "–ë–∞–ª–∞–Ω—Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏"
          recommendationsList.innerHTML = recommendations
            .filter(r => r.exercise)
            .map(r => `
              <div class="recommendation-card priority-${r.priority || 'medium'}">
                <div class="rec-header">
                  <strong>${r.exercise.name}</strong>
                  <span class="pill">${r.exercise.type}</span>
                </div>
                <p><em>${r.reason}</em></p>
                <p><small>üéØ ${r.exercise.primaryMuscles.slice(0, 2).join(', ')}</small></p>
                ${r.exercise.formTips ? 
                  `<details><summary>–°–æ–≤–µ—Ç—ã –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ</summary>
                    <ul>${r.exercise.formTips.map(t => `<li>${t}</li>`).join('')}</ul>
                  </details>` : ''
                }
              </div>
            `).join('');

          recStatus.style.display = 'none';
          recommendationsSection.style.display = 'block';

          // === –ü—Ä–æ–≥–Ω–æ–∑ —Å–∏–ª—ã ===
          try {
            const { StrengthProgress } = await import('../core/strengthProgress.js');
            const progressEngine = new StrengthProgress();
            const squatHistory = progressEngine.getExerciseHistory('squat-barbell') || [];

            if (squatHistory.length >= 3) {
              const forecast = progressEngine.predictFutureOneRM(squatHistory, 4);

              if (forecast) {
                const forecastHTML = `
                  <section class="card" style="margin-top: 2rem; border-left: 4px solid var(--accent);">
                    <h3>üìà –ü—Ä–æ–≥–Ω–æ–∑ —Å–∏–ª—ã: –ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è</h3>
                    <p><strong>–¢–µ–∫—É—â–∏–π 1–ü–ú:</strong> ${Math.round(forecast.current)} –∫–≥</p>
                    <p><strong>–ß–µ—Ä–µ–∑ 4 –Ω–µ–¥–µ–ª–∏:</strong> ${Math.round(forecast.predicted)} –∫–≥</p>
                    <p><strong>–¢—Ä–µ–Ω–¥:</strong> 
                      <span style="color: ${
                        forecast.trend === '—Ä–æ—Å—Ç' ? '#2ecc71' :
                        forecast.trend === '—Å–ø–∞–¥' ? '#e74c3c' : '#f39c12'
                      }; font-weight: 600;">
                        ${forecast.trend === '—Ä–æ—Å—Ç' ? '‚Üë –†–æ—Å—Ç' : 
                        forecast.trend === '—Å–ø–∞–¥' ? '‚Üì –°–ø–∞–¥' : '‚Üí –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å'}
                      </span>
                    </p>
                    ${
                      forecast.predicted > forecast.current + 5
                        ? '<p><small>–û—Ç–ª–∏—á–Ω—ã–π —Ç–µ–º–ø! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.</small></p>'
                        : forecast.predicted < forecast.current
                          ? '<p><small>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –ø–∏—Ç–∞–Ω–∏–µ.</small></p>'
                          : ''
                    }
                  </section>
                `;
                recommendationsSection.insertAdjacentHTML('afterend', forecastHTML);
              }
            }

          } catch (err) {
            console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ —Å–∏–ª—ã:', err.message);
          }

          // === –ê–Ω–∞–ª–∏–∑ –±–∞–ª–∞–Ω—Å–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ===
          try {
            const { WorkoutBalancer } = await import('../core/workoutBalancer.js');
            const balancer = new WorkoutBalancer();
            await balancer.init();

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ –ø–ª–∞–Ω–∞
            const exercisesToAnalyze = plan?.schedule?.[0]?.session?.exercises || [
              { id: 'bench-press', type: 'chest' },
              { id: 'pull-ups', type: 'back' },
              { id: 'squat-barbell', type: 'legs' }
            ];

            const analysis = balancer.classifyWorkout(exercisesToAnalyze);
            const advice = balancer.getBalanceAdvice(analysis);

            const priorityColor = 
              advice.priority === 'high' ? '#e74c3c' :
              advice.priority === 'medium' ? '#f39c12' : '#2ecc71';

            const balanceHTML = `
              <section class="recommendation-card" style="border-left-color: ${priorityColor}; margin-top: 2rem;">
                <h3>‚öñÔ∏è –ë–∞–ª–∞–Ω—Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h3>
                <p><strong>–¢–∏–ø:</strong> ${analysis.type}</p>
                <p><strong>–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ:</strong> Push ${analysis.ratio.push}%, Pull ${analysis.ratio.pull}%, Legs ${analysis.ratio.legs}%</p>
                <p><strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong></p>
                <p style="color: ${priorityColor};"><strong>${advice.advice}</strong></p>
              </section>
            `;

            recommendationsSection.insertAdjacentHTML('afterend', balanceHTML);

          } catch (err) {
            console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –±–∞–ª–∞–Ω—Å–∞:', err.message);
          }

        } catch (err) {
          recStatus.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
          recStatus.className = "error-text";
          console.error(err);
        }

        // === 7. –ö–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É" ===
        document.querySelectorAll('.start-workout-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const name = encodeURIComponent(btn.dataset.name);
            const id = btn.dataset.id;
            window.location.href = `/pages/workout-session.html?id=${id}&name=${name}`;

            btn.textContent = "‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ!";
            btn.disabled = true;
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');

            const mainContent = document.getElementById('main-content');
            mainContent.setAttribute('tabindex', '-1');
            mainContent.focus();

            setTimeout(() => {
              window.location.href = '/index.html';
            }, 1500);
          });
        });

      } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:', err);
        const workoutStatus = document.getElementById('workoutStatus');
        if (workoutStatus) {
          workoutStatus.textContent = "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.";
          workoutStatus.className = "error-text";
          workoutStatus.style.display = 'block';
        }
      }
    });
  </script>
</body>
</html>