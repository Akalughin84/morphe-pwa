<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî Morphe</title>

  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f97316">

  <!-- –ë–∞–∑–∞ -->
  <link rel="stylesheet" href="/styles/base/reset.css">
  <link rel="stylesheet" href="/styles/base/theme.css">
  <link rel="stylesheet" href="/styles/base/typography.css">
  <link rel="stylesheet" href="/styles/base/utilities.css">

  <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -->
  <link rel="stylesheet" href="/styles/components/buttons.css">
  <link rel="stylesheet" href="/styles/components/cards.css">
  <link rel="stylesheet" href="/styles/components/forms.css">
  <link rel="stylesheet" href="/styles/components/tabs.css">
  <link rel="stylesheet" href="/styles/components/mobile-menu.css">

  <!-- –ú–∞–∫–µ—Ç -->
  <link rel="stylesheet" href="/styles/layout/header.css">
  <link rel="stylesheet" href="/styles/layout/footer.css">
  <link rel="stylesheet" href="/styles/layout/scroll-top.css">

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ -->
  <link rel="stylesheet" href="/styles/pages/workouts.css">
</head>
<body>

  <div id="header-placeholder"></div>

  <main id="main-content" tabindex="-1">
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h1>
        <p id="workoutStatus" class="info-text" role="status" aria-live="polite">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏...</p>
      </div>

      <!-- –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø -->
      <div id="programWarnings" class="alert warning" style="display: none; margin-bottom: 1rem;"></div>

      <!-- –°–ï–ì–û–î–ù–Ø–®–ù–Ø–Ø –¢–†–ï–ù–ò–†–û–í–ö–ê -->
      <section id="todaySection" class="today-card" style="display: none;">
        <h2 class="today-title" id="todayTitle">‚Äî</h2>
        <p class="today-focus" id="todayFocus">–§–æ–∫—É—Å: ‚Äî</p>
        <button id="startWorkoutBtn" class="start-btn" aria-label="–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É">
          ‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
        </button>
      </section>

      <!-- –ü–†–û–ì–ù–û–ó –°–ò–õ–´ -->
      <section id="forecastSection" class="forecast-card" style="display: none;">
        <div class="forecast-header">
          <h3 class="forecast-title">üìà –ü—Ä–æ–≥–Ω–æ–∑ —Å–∏–ª—ã: –ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è</h3>
          <span class="trend-indicator trend-up" id="trendIndicator">‚Üë –†–æ—Å—Ç</span>
        </div>
        <p><strong>–¢–µ–∫—É—â–∏–π 1–ü–ú:</strong> <span id="current1RM">‚Äî</span> –∫–≥</p>
        <p><strong>–ß–µ—Ä–µ–∑ 4 –Ω–µ–¥–µ–ª–∏:</strong> <span id="predicted1RM">‚Äî</span> –∫–≥</p>
        <div class="forecast-bar">
          <div class="forecast-fill" id="forecastFill" style="width: 0%;"></div>
        </div>
        <p id="forecastAdvice" class="section-subtitle"></p>
      </section>

      <!-- –û–ë–ó–û–† –ü–†–û–ì–†–ê–ú–ú–´ -->
      <div class="program-overview" id="programOverview" style="display: none;">
        <div class="overview-item">
          <div>–ü—Ä–æ–≥—Ä–∞–º–º–∞</div>
          <div class="overview-value" id="overviewName">‚Äî</div>
        </div>
        <div class="overview-item">
          <div>–ù–µ–¥–µ–ª—è</div>
          <div class="overview-value" id="overviewWeek">1</div>
        </div>
        <div class="overview-item">
          <div>–î–µ–Ω—å</div>
          <div class="overview-value" id="overviewDay">1/3</div>
        </div>
      </div>

      <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ï–î–ï–õ–Ø–ú–ò -->
      <div id="weekControlsContainer"></div>

      <!-- –í–´–ë–û–† –ü–†–û–ì–†–ê–ú–ú–´ -->
      <details class="card program-selector" id="programSelector" style="display: none;">
        <summary>üéØ –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</summary>
        <div id="programOptions"></div>
      </details>

      <!-- –ö–ù–û–ü–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø -->
      <button id="regeneratePlan" class="btn-primary regenerate-btn" style="display: none; margin-top: 1.5rem;">
        üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
      </button>

      <!-- –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò -->
      <h2 class="section-title">üß† –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
      <div id="recommendationsList"></div>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

  <script type="module">
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { UserService } from '/services/userService.js';
    import { DataService } from '/services/dataService.js';

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await HeaderController.loadHeader();
        new ThemeManager();

        // === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===
        try {
          const { NotificationManager } = await import('/modules/notifications.js');
          const scheduler = new NotificationManager();
          const profile = UserService.getRawData();
          scheduler.scheduleAllTypical(profile);
          scheduler.scheduleSupplements(profile);
        } catch (e) {
          console.warn('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã:', e);
        }

        const workoutStatus = document.getElementById('workoutStatus');
        const todaySection = document.getElementById('todaySection');
        const programOverview = document.getElementById('programOverview');
        const weekControlsContainer = document.getElementById('weekControlsContainer');
        const forecastSection = document.getElementById('forecastSection');
        const recommendationsList = document.getElementById('recommendationsList');
        const regenerateBtn = document.getElementById('regeneratePlan');

        if (!UserService.isProfileComplete()) {
          workoutStatus.textContent = "‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.";
          workoutStatus.className = "error-text";
          return;
        }

        const profile = UserService.getRawData();
        const allPrograms = await DataService.getPrograms();
        const matchingPrograms = allPrograms.filter(p =>
          p.goal === profile.goal &&
          (p.level === 'all' || p.level === profile.level) &&
          p.workoutLocation === profile.workoutLocation
        );

        if (matchingPrograms.length > 0) {
          const optionsHtml = matchingPrograms.map(p => `
            <div class="recommendation-card">
              <h3>${p.name}</h3>
              <p>${p.description}</p>
              <small>${p.durationWeeks} –Ω–µ–¥–µ–ª—å ‚Ä¢ ${p.daysPerWeek} –¥–Ω./–Ω–µ–¥</small>
              <button class="btn-primary btn-small" data-program-id="${p.id}">
                –í—ã–±—Ä–∞—Ç—å
              </button>
            </div>
          `).join('');
          document.getElementById('programOptions').innerHTML = optionsHtml;
          document.getElementById('programSelector').style.display = 'block';
        }

        // === –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–ì–†–ê–ú–ú–´ ===
        let plan = null;
        try {
          const { WorkoutPlanner } = await import('/core/workoutPlanner.js');
          const planner = new WorkoutPlanner();
          await planner.init();

          plan = planner.getCurrent();
          if (!plan) {
            plan = await planner.generate();
          }

          const today = new Date().toISOString().split('T')[0];
          const trainingDays = profile.trainingDays || [1, 3, 5];
          const todayDayOfWeek = new Date().getDay();
          const isTrainingDay = trainingDays.includes(todayDayOfWeek);

          if (!isTrainingDay) {
            const recoveryTips = [
              "üí° –°–µ–≥–æ–¥–Ω—è –∏–¥–µ–∞–ª—å–Ω—ã–π –¥–µ–Ω—å –¥–ª—è —Ä–∞—Å—Ç—è–∂–∫–∏ –∏–ª–∏ –ª—ë–≥–∫–æ–π –ø—Ä–æ–≥—É–ª–∫–∏.",
              "üßò –ü–æ–ø—Ä–æ–±—É–π—Ç–µ 10 –º–∏–Ω—É—Ç –¥—ã—Ö–∞—Ç–µ–ª—å–Ω–æ–π –≥–∏–º–Ω–∞—Å—Ç–∏–∫–∏ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.",
              "üí§ –£–¥–µ–ª—è–π—Ç–µ —Å–Ω—É –Ω–µ –º–µ–Ω–µ–µ 7‚Äì8 —á–∞—Å–æ–≤ ‚Äî —ç—Ç–æ –∫–ª—é—á –∫ –ø—Ä–æ–≥—Ä–µ—Å—Å—É.",
              "ü•ó –°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –±–µ–ª–∫–æ–≤–æ–º –ø–∏—Ç–∞–Ω–∏–∏ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –º—ã—à—Ü."
            ];
            const randomTip = recoveryTips[Math.floor(Math.random() * recoveryTips.length)];
            document.getElementById('todayTitle').textContent = 'üßò –û—Ç–¥—ã—Ö';
            document.getElementById('todayFocus').textContent = randomTip;
            document.getElementById('startWorkoutBtn').style.display = 'none';
            todaySection.style.display = 'block';
          } else {
            if (!plan.schedule || !Array.isArray(plan.schedule)) {
              workoutStatus.textContent = "‚ö†Ô∏è –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞. –û–±–Ω–æ–≤–∏—Ç–µ –µ—ë.";
              workoutStatus.className = "warning-text";
              todaySection.style.display = 'none';
              return;
            }

            const todayEntry = plan.schedule.find(s => s.date === today);
            if (todayEntry?.session) {
              const session = todayEntry.session;
              document.getElementById('todayTitle').textContent = session.name;
              document.getElementById('todayFocus').textContent = `–§–æ–∫—É—Å: ${session.focus}`;
              document.getElementById('startWorkoutBtn').style.display = 'flex';
              todaySection.style.display = 'block';
            } else {
              workoutStatus.textContent = "‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É.";
              workoutStatus.className = "warning-text";
              todaySection.style.display = 'none';
            }
          }

          // === –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø ===
          if (plan?.warnings?.length > 0) {
            document.getElementById('programWarnings').innerHTML = 
              plan.warnings.map(w => `<p>${w}</p>`).join('');
            document.getElementById('programWarnings').style.display = 'block';
          }

          // === –û–ë–ó–û–† ===
          if (plan?.name) {
            document.getElementById('overviewName').textContent = plan.name;
            document.getElementById('overviewWeek').textContent = plan.week || 1;
            const todayIndex = plan.schedule.findIndex(s => s.date === today);
            document.getElementById('overviewDay').textContent = 
              todayIndex >= 0 ? `${todayIndex + 1}/${plan.schedule.length}` : '‚Äî';
            programOverview.style.display = 'flex';
          }

          // === –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ù–ï–î–ï–õ–¨ ===
          if (plan?.originalProgramId && plan.week && plan.durationWeeks) {
            const weekControls = document.createElement('div');
            weekControls.className = 'week-controls';
            const maxWeeks = plan.durationWeeks;
            const prevDisabled = plan.week <= 1 ? 'disabled' : '';
            const nextDisabled = plan.week >= maxWeeks ? 'disabled' : '';
            weekControls.innerHTML = `
              <button id="prevWeek" class="btn-outline" ${prevDisabled}>‚Üê –ù–µ–¥–µ–ª—è ${plan.week - 1}</button>
              <span style="margin: 0 10px; font-weight: 500;">–ù–µ–¥–µ–ª—è ${plan.week}</span>
              <button id="nextWeek" class="btn-outline" ${nextDisabled}>–ù–µ–¥–µ–ª—è ${plan.week + 1} ‚Üí</button>
            `;
            weekControlsContainer.appendChild(weekControls);
          }

          // === –ö–ù–û–ü–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø ===
          regenerateBtn.style.display = 'block';
          regenerateBtn.addEventListener('click', async () => {
            regenerateBtn.disabled = true;
            regenerateBtn.innerHTML = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
            try {
              const newPlan = await planner.regenerate();
              window.location.reload();
            } catch (err) {
              alert(`–û—à–∏–±–∫–∞: ${err.message}`);
              regenerateBtn.disabled = false;
              regenerateBtn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫';
            }
          });

        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã:', err);
          workoutStatus.textContent = `‚ùå ${err.message}`;
          workoutStatus.className = 'error-text';
        }

        // === –ü–†–û–ì–ù–û–ó –°–ò–õ–´ ===
        try {
          const { StrengthProgress } = await import('/core/strengthProgress.js');
          const engine = new StrengthProgress();
          const allWorkouts = engine.tracker.getAll();
          const allExerciseIds = new Set();
          allWorkouts.forEach(session => {
            if (session.exercises) {
              session.exercises.forEach(ex => {
                if (ex.id && typeof ex.weight === 'number' && ex.weight > 0) {
                  allExerciseIds.add(ex.id);
                }
              });
            }
          });

          let forecast = null;
          let exerciseName = '—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ';
          for (const exId of allExerciseIds) {
            const history = engine.getExerciseHistory(exId);
            if (history?.length >= 3) {
              const exercises = await DataService.getExercises();
              const ex = exercises.find(e => e.id === exId);
              exerciseName = ex?.name || exId;
              forecast = engine.predictFutureOneRM(history, 4);
              if (forecast) break;
            }
          }

          if (forecast) {
            document.querySelector('.forecast-title').textContent = `üìà –ü—Ä–æ–≥–Ω–æ–∑ —Å–∏–ª—ã: ${exerciseName}`;
            document.getElementById('current1RM').textContent = Math.round(forecast.current);
            document.getElementById('predicted1RM').textContent = Math.round(forecast.predicted);
            const max = Math.max(forecast.current, forecast.predicted) * 1.2;
            const width = (forecast.predicted / max) * 100;
            document.getElementById('forecastFill').style.width = `${width}%`;

            const trendEl = document.getElementById('trendIndicator');
            if (forecast.trend === '—Ä–æ—Å—Ç') {
              trendEl.textContent = '‚Üë –†–æ—Å—Ç';
              trendEl.className = 'trend-indicator trend-up';
            } else if (forecast.trend === '—Å–ø–∞–¥') {
              trendEl.textContent = '‚Üì –°–ø–∞–¥';
              trendEl.className = 'trend-indicator trend-down';
            } else {
              trendEl.textContent = '‚Üí –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å';
              trendEl.className = 'trend-indicator trend-stable';
            }

            const advice = forecast.predicted > forecast.current + 5 
              ? '–û—Ç–ª–∏—á–Ω—ã–π —Ç–µ–º–ø! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.' 
              : forecast.predicted < forecast.current 
                ? '–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –ø–∏—Ç–∞–Ω–∏–µ.' 
                : '–ü—Ä–æ–≥—Ä–µ—Å—Å —Å—Ç–∞–±–∏–ª–µ–Ω. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Ç–µ–º–ø!';
            document.getElementById('forecastAdvice').textContent = advice;
            forecastSection.style.display = 'block';
          }
        } catch (e) {
          console.warn('–ü—Ä–æ–≥–Ω–æ–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', e.message);
          forecastSection.style.display = 'none';
        }

        // === –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò ===
        try {
          const { AdaptiveEngine } = await import('/modules/adaptiveEngine.js');
          const engine = new AdaptiveEngine();
          const advice = await engine.getAdaptiveAdvice();
          const adviceEl = document.createElement('div');
          adviceEl.className = 'recommendation-card priority-low';
          adviceEl.innerHTML = `<p>üß† <strong>–°–æ–≤–µ—Ç —Ç—Ä–µ–Ω–µ—Ä–∞:</strong> ${advice}</p>`;
          document.getElementById('recommendationsList').prepend(adviceEl);
        } catch (e) {
          console.warn('–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Å–æ–≤–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', e);
        }

        try {
          const { AIAssistant } = await import('/core/aiAssistant.js');
          const ai = new AIAssistant();
          const advice = await ai.generateAdvice();
          const adviceEl = document.createElement('div');
          adviceEl.className = 'recommendation-card priority-low ai-advice-container';
          adviceEl.innerHTML = `
            <p>${advice.emoji || 'üß†'} <strong>${advice.title}:</strong> ${advice.message}</p>
            ${advice.action ? `<button class="btn-text ai-action-btn" data-url="${advice.action.url}">${advice.action.text}</button>` : ''}
            <div class="ai-actions" style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn-outline btn-sm" data-reaction="accepted">–ü–æ–Ω—è—Ç–Ω–æ</button>
              <button class="btn-outline btn-sm" data-reaction="ignored">–ù–∞–ø–æ–º–Ω–∏—Ç—å –ø–æ–∑–∂–µ</button>
              <button class="btn-outline btn-sm" data-reaction="not_helpful">–ù–µ –ø–æ–º–æ–≥–ª–æ</button>
            </div>
          `;
          adviceEl.dataset.adviceId = advice.id;
          document.getElementById('recommendationsList').prepend(adviceEl);

          adviceEl.querySelectorAll('.ai-actions button').forEach(btn => {
            btn.addEventListener('click', () => {
              const reaction = btn.dataset.reaction;
              ai.recordAdviceFeedback(advice.id, reaction);
              const status = {
                accepted: '–ü—Ä–∏–Ω—è—Ç–æ! üëç',
                ignored: '–•–æ—Ä–æ—à–æ, –Ω–∞–ø–æ–º–Ω—é –ø–æ–∑–∂–µ.',
                not_helpful: '–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤! –ü–æ—Å—Ç–∞—Ä–∞—é—Å—å –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–µ–µ.'
              };
              const p = adviceEl.querySelector('p');
              if (p) p.textContent = status[reaction];
              adviceEl.querySelector('.ai-actions').remove();
            });
          });

          const memory = ai._memory;
          const record = memory.adviceHistory.find(a => a.id === advice.id);
          if (record) {
            record.acknowledged = true;
            ai._saveMemory();
          }

          adviceEl.querySelector('.ai-action-btn')?.addEventListener('click', (e) => {
            window.location.href = e.target.dataset.url;
          });

        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ò–ò:', err);
          const fallback = document.createElement('div');
          fallback.className = 'recommendation-card priority-low';
          fallback.dataset.adviceId = 'fallback';
          fallback.innerHTML = '<p class="error-text">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Å–æ–≤–µ—Ç.</p>';
          document.getElementById('recommendationsList').prepend(fallback);
        }

      } catch (err) {
        console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', err);
        document.getElementById('workoutStatus').textContent = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.";
        document.getElementById('workoutStatus').className = "error-text";
      }
    });

    // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–õ–ò–ö–û–í ===
    document.addEventListener('click', async (e) => {
      if (e.target.id === 'startWorkoutBtn') {
        let plan = null;
        try {
          const raw = localStorage.getItem('morphe-current-plan');
          plan = raw ? JSON.parse(raw) : null;
        } catch (err) {
          console.warn('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–ª–∞–Ω–∞:', err);
          return;
        }
        if (!plan) return;

        const programId = plan.originalProgramId || plan.id;
        const week = plan.week || 1;
        const name = encodeURIComponent(plan.name || '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞');
        window.location.href = `/pages/workout-session.html?id=${programId}&name=${name}&week=${week}`;
      }

      if (e.target.matches('[data-program-id]')) {
        const programId = e.target.dataset.programId;
        const { WorkoutPlanner } = await import('/core/workoutPlanner.js');
        const planner = new WorkoutPlanner();
        await planner.init();
        await planner.usePredefinedProgram(programId);
        window.location.reload();
      }

      if (e.target.id === 'prevWeek' || e.target.id === 'nextWeek') {
        const isNext = e.target.id === 'nextWeek';
        const currentWeek = parseInt(document.getElementById('overviewWeek').textContent);
        const newWeek = isNext ? currentWeek + 1 : currentWeek - 1;
        
        if (newWeek >= 1) {
          let plan = null;
          try {
            const raw = localStorage.getItem('morphe-current-plan');
            plan = raw ? JSON.parse(raw) : null;
          } catch (err) {
            console.warn('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–ª–∞–Ω–∞:', err);
            return;
          }
          if (plan?.originalProgramId) {
            const { WorkoutPlanner } = await import('/core/workoutPlanner.js');
            const planner = new WorkoutPlanner();
            await planner.init();
            await planner.usePredefinedProgram(plan.originalProgramId, newWeek);
            window.location.reload();
          }
        }
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ—É—Ç–µ—Ä–∞
    document.addEventListener('DOMContentLoaded', () => {
      import('/core/HeaderController.js')
        .then(m => m.HeaderController.loadFooter())
        .catch(console.error);
    });
  </script>
</body>
</html>