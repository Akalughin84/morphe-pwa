<!-- /pages/notifications.html -->
<!-- v1.4.0 ‚Äî –õ–æ–∫–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ —Å–æ–≤–µ—Ç—ã –ò–ò -->

<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Äî Morphe</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">

  <!-- –ë–∞–∑–∞ -->
  <link rel="stylesheet" href="/styles/base/reset.css">
  <link rel="stylesheet" href="/styles/base/theme.css">
  <link rel="stylesheet" href="/styles/base/typography.css">
  <link rel="stylesheet" href="/styles/base/utilities.css">

  <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -->
  <link rel="stylesheet" href="/styles/components/buttons.css">
  <link rel="stylesheet" href="/styles/components/cards.css">
  <link rel="stylesheet" href="/styles/components/forms.css">
  <link rel="stylesheet" href="/styles/components/tabs.css">
  <link rel="stylesheet" href="/styles/components/mobile-menu.css">

  <!-- –ú–∞–∫–µ—Ç -->
  <link rel="stylesheet" href="/styles/layout/header.css">
  <link rel="stylesheet" href="/styles/layout/footer.css">
  <link rel="stylesheet" href="/styles/layout/scroll-top.css">

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ -->
  <link rel="stylesheet" href="/styles/pages/notifications.css">  
</head>
<body>


  <!-- –ó–∞–≥–ª—É—à–∫–∞ —à–∞–ø–∫–∏ -->
  <div id="header-placeholder"></div>

  <main id="main-content">
    <div class="container">
      <h1>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h1>
      <p>–°–æ–≤–µ—Ç—ã, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è.</p>

      <!-- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
      <div id="permissionSection" style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-surface-alt); border-radius: 8px; display: none;">
        <p>–†–∞–∑—Ä–µ—à–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö –∏ –ø–∏—Ç–∞–Ω–∏–∏.</p>
        <button id="allowNotifications" class="btn-primary btn-small">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
      </div>

      <!-- –¢–µ–∫—É—â–∏–π —Å–æ–≤–µ—Ç –ò–ò -->
      <section class="card" id="aiAdviceSection">
        <h2>üß† –í–∞–º –≥–æ–≤–æ—Ä–∏—Ç Morphe</h2>
        <div id="currentAdvice">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–≤–µ—Ç–∞...</div>
      </section>

      <!-- –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è -->
      <section class="card" id="scheduledSection" style="display: none;">
        <h2>üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</h2>
        <div id="scheduledList"></div>
        <button id="addReminderBtn" class="btn-outline btn-small">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</button>
      </section>

      <!-- –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è -->
      <section class="card" id="missedSection" style="display: none;">
        <h2>‚è≥ –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ</h2>
        <div id="missedList"></div>
      </section>

      <!-- –ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
      <section class="card" id="historySection" style="display: none;">
        <h2>üìå –ò—Å—Ç–æ—Ä–∏—è</h2>
        <div id="adviceHistory"></div>
      </section>
    </div>
  </main>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ –ø–æ–¥–≤–∞–ª–∞ -->
  <div id="footer-placeholder"></div>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('‚úÖ SW –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', reg.scope))
          .catch(err => console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ SW:', err));
      });
    }
  </script>

  <!-- –õ–æ–≥–∏–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
  <script type="module">
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { AIAssistant } from '/core/aiAssistant.js';
    import { NotificationManager } from '/modules/notifications.js';

    document.addEventListener('DOMContentLoaded', async () => {
      await HeaderController.loadHeader();
      try {
        // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI ===
        await HeaderController.loadHeader();
        new ThemeManager();

        // === –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π) ===
        const aiAdviceEl = document.getElementById('currentAdvice');
        const historySection = document.getElementById('historySection');
        const historyList = document.getElementById('adviceHistory');
        const scheduledSection = document.getElementById('scheduledSection');
        const scheduledList = document.getElementById('scheduledList');
        const missedSection = document.getElementById('missedSection');
        const missedList = document.getElementById('missedList');
        const permissionSection = document.getElementById('permissionSection');
        const allowBtn = document.getElementById('allowNotifications');
        const addReminderBtn = document.getElementById('addReminderBtn');

        if (!aiAdviceEl) throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç #currentAdvice");

        // === –°–æ–∑–¥–∞–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ===
        const notifs = new NotificationManager();

        // === –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ===
        if ('Notification' in window && Notification.permission !== 'granted') {
          if (permissionSection) permissionSection.style.display = 'block';
          if (allowBtn) {
            allowBtn.addEventListener('click', async () => {
              const granted = await NotificationManager.requestPermission();
              if (granted) {
                if (permissionSection) permissionSection.style.display = 'none';
                console.log('‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–æ');
              } else {
                alert('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ.');
              }
            });
          }
        }

        // === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–≤–µ—Ç–∞ –ò–ò ===
        try {
          const ai = new AIAssistant();
          const advice = await ai.generateAdvice();

          if (aiAdviceEl) {
            aiAdviceEl.innerHTML = `
              <div class="advice-header">
                <span class="advice-emoji">${advice.emoji || 'üí°'}</span>
                <strong>${advice.title}</strong>
              </div>
              <p>${advice.message}</p>
              ${advice.action 
                ? `<p><a href="${advice.action.url}" class="btn-outline btn-small">${advice.action.text}</a></p>` 
                : ''
              }
            `;
          }
        } catch (err) {
          if (aiAdviceEl) {
            aiAdviceEl.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–≤–µ—Ç.";
            aiAdviceEl.parentElement.classList.add('error-card');
          }
          console.error('‚ùå –û—à–∏–±–∫–∞ AI:', err);
        }

        // === –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π ===
        const scheduled = notifs.getScheduled().filter(r => !r.triggered);
        if (scheduled.length > 0 && scheduledSection && scheduledList) {
          scheduledSection.style.display = 'block';
          scheduledList.innerHTML = scheduled.map(r => `
            <div class="history-item">
              <strong>${new Date(r.triggerAt).toLocaleString('ru-RU')}</strong>
              <p><strong>${r.title}</strong>: ${r.message}</p>
            </div>
          `).join('');
        }

        // === –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö ===
        const now = new Date().toISOString();
        const missed = scheduled.filter(r => r.triggerAt <= now);
        if (missed.length > 0 && missedSection && missedList) {
          missedSection.style.display = 'block';
          missedList.innerHTML = missed.map(r => `
            <div class="history-item">
              <strong>‚è∞ –ü—Ä–æ–ø—É—â–µ–Ω–æ</strong>
              <p><strong>${r.title}</strong>: ${r.message}</p>
            </div>
          `).join('');
        }

        // === –ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ===
        const all = notifs.getAll();
        if (all.length > 0 && historySection && historyList) {
          historySection.style.display = 'block';
          historyList.innerHTML = all.slice(0, 10).map(a => `
            <div class="history-item ${a.read ? '' : 'unread'}">
              <small>${new Date(a.timestamp).toLocaleDateString('ru-RU')}</small>
              <strong>${a.title}</strong>
              <p>${a.message}</p>
            </div>
          `).join('');
        }

        // === –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è ===
        if (addReminderBtn) {
          addReminderBtn.addEventListener('click', () => {
            const title = prompt("–¢–µ–º–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è", "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞");
            if (!title) return;

            const message = prompt("–°–æ–æ–±—â–µ–Ω–∏–µ", "–ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–µ–≥–æ–¥–Ω—è –ø–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è!");
            if (!message) return;

            const timeStr = prompt("–í—Ä–µ–º—è (YYYY-MM-DD HH:mm)", 
              new Date(Date.now() + 60 * 60 * 1000).toISOString().slice(0, 16)
            );
            if (!timeStr) return;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏
            const triggerAt = new Date(timeStr).toISOString();
            if (isNaN(new Date(triggerAt))) {
              alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏.");
              return;
            }

            notifs.schedule({
              title,
              message,
              triggerAt,
              type: 'custom'
            });

            alert("‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!");
            location.reload();
          });
        }

        // === –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–∞–π–º–µ—Ä–æ–≤ ===
        notifs.resumeAll();
        console.log('‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: —Ç–∞–π–º–µ—Ä—ã –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω—ã');

      } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', err);
        const mainContent = document.getElementById('main-content');
        if (mainContent) {
          mainContent.innerHTML = '<div class="container"><p class="error-text">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.</p></div>';
        }
      }
    });
  </script>
</body>
</html>