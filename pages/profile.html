<!-- /pages/profile.html -->
<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü—Ä–æ—Ñ–∏–ª—å ‚Äî Morphe</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">

  <!-- –°—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/styles-form.css">
  <link rel="stylesheet" href="/styles-shared.css">

  <!-- Skip-link -->
  <style>
    .skip-link {
      position: absolute;
      top: -40px;
      left: 10px;
      background: #000;
      color: #fff;
      padding: 8px;
      text-decoration: none;
      z-index: 1000;
      transition: top 0.3s;
    }
    .skip-link:focus { top: 10px; }

    .success-text { color: #2ecc71; font-weight: 500; }
    .error-text { color: #e74c3c; font-weight: 500; }
    .info-text { color: #3498db; font-weight: 500; }
  </style>
</head>
<body>

  <!-- Skip-link -->
  <a href="#main-content" class="skip-link">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é</a>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ —à–∞–ø–∫–∏ -->
  <div id="header-placeholder"></div>

  <main id="main-content" tabindex="-1">
    <div class="container">
      <h1>üë§ –¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h1>
      <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –∏ Morphe –Ω–∞—á–Ω—ë—Ç –ø–æ–º–æ–≥–∞—Ç—å –≤–∞–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ.</p>

      <form id="profileForm" novalidate>
        <!-- –ò–º—è -->
        <div class="form-group">
          <label for="name">–ò–º—è</label>
          <input type="text" id="name" name="name" required placeholder="–ê–ª–µ–∫—Å–µ–π">
        </div>

        <!-- –ü–æ–ª -->
        <div class="form-group">
          <label>–ü–æ–ª</label>
          <div class="radio-group">
            <label><input type="radio" name="gender" value="male" required> –ú—É–∂—Å–∫–æ–π</label>
            <label><input type="radio" name="gender" value="female"> –ñ–µ–Ω—Å–∫–∏–π</label>
          </div>
        </div>

        <!-- –í–æ–∑—Ä–∞—Å—Ç -->
        <div class="form-group">
          <label for="age">–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç)</label>
          <input type="number" id="age" name="age" min="14" max="99" required placeholder="28">
        </div>

        <!-- –†–æ—Å—Ç -->
        <div class="form-group">
          <label for="height">–†–æ—Å—Ç (—Å–º)</label>
          <input type="number" id="height" name="height" min="140" max="230" required placeholder="178">
        </div>

        <!-- –í–µ—Å -->
        <div class="form-group">
          <label for="weight">–¢–µ–∫—É—â–∏–π –≤–µ—Å (–∫–≥)</label>
          <input type="number" id="weight" name="weight" step="0.1" min="40" max="200" required placeholder="75.5">
        </div>

        <!-- –£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
        <div class="form-group">
          <label for="activity">–£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</label>
          <select id="activity" name="activity" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
            <option value="1.2">–°–∏–¥—è—á–∏–π (–ø–æ—á—Ç–∏ –Ω–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫)</option>
            <option value="1.375">–õ—ë–≥–∫–∏–π (1‚Äì3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é)</option>
            <option value="1.55">–°—Ä–µ–¥–Ω–∏–π (3‚Äì5 —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é)</option>
            <option value="1.725">–í—ã—Å–æ–∫–∏–π (6‚Äì7 —Ä–∞–∑)</option>
            <option value="1.9">–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ + —Ä–∞–±–æ—Ç–∞)</option>
          </select>
        </div>

        <!-- –¶–µ–ª—å -->
        <div class="form-group">
          <label for="goal">–¶–µ–ª—å</label>
          <select id="goal" name="goal" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
            <option value="lose">–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å</option>
            <option value="maintain">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ñ–æ—Ä–º—É</option>
            <option value="gain">–ù–∞–±—Ä–∞—Ç—å –º–∞—Å—Å—É</option>
          </select>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ -->
        <button type="submit" class="btn-primary btn-large">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Üí</button>
      </form>

      <div id="formFeedback" aria-live="polite"></div>
    </div>
  </main>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ –ø–æ–¥–≤–∞–ª–∞ -->
  <div id="footer-placeholder"></div>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

  <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Å—Ç–µ–π –∏ –ª–æ–≥–∏–∫–∞ -->
  <script type="module">
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { MorpheProfile } from '/modules/profile.js';

    document.addEventListener('DOMContentLoaded', async () => {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
      await HeaderController.loadHeader();
      new ThemeManager();

      const form = document.getElementById('profileForm');
      const feedback = document.getElementById('formFeedback');

      // === –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É ===
      const profile = new MorpheProfile();
      if (profile.isComplete()) {
        profile.fillForm(form); // ‚úÖ –¢–µ–ø–µ—Ä—å –º–µ—Ç–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!
        feedback.innerHTML = '<p class="info-text">‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω. –í—ã –º–æ–∂–µ—Ç–µ –µ–≥–æ –æ–±–Ω–æ–≤–∏—Ç—å.</p>';
      }

      // === –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã ===
      form.addEventListener('submit', (e) => {
        e.preventDefault();

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –±—Ä–∞—É–∑–µ—Ä–æ–º
        if (!form.checkValidity()) {
          feedback.innerHTML = '<p class="error-text">‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.</p>';
          form.reportValidity();
          return;
        }

        const formData = new FormData(form);

        try {
          profile.save({
            name: formData.get('name'),
            gender: formData.get('gender'),
            age: parseInt(formData.get('age')),
            height: parseFloat(formData.get('height')),
            weight: parseFloat(formData.get('weight')),
            activityLevel: parseFloat(formData.get('activity')),
            goal: formData.get('goal'),
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          });

          feedback.innerHTML = '<p class="success-text">‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...</p>';
          console.log('üíæ –°–æ—Ö—Ä–∞–Ω—ë–Ω –ø—Ä–æ—Ñ–∏–ª—å:', profile.data);

          setTimeout(() => {
            window.location.href = '/index.html';
          }, 1000);

        } catch (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err);
          feedback.innerHTML = `<p class="error-text">‚ùå –û—à–∏–±–∫–∞: ${err.message}</p>`;
        }
      });
    });
  </script>
</body>
</html>