<!-- /pages/supplements.html -->
<!-- v3.0.1 ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –¥–æ–±–∞–≤–ª–µ–Ω await –¥–ª—è getDailySchedule -->

<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–í–∏—Ç–∞–º–∏–Ω—ã –∏ –¥–æ–±–∞–≤–∫–∏ ‚Äî Morphe</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">

  <!-- –°—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/styles-shared.css">

  <style>
    /* –í–∫–ª–∞–¥–∫–∏ */
    .tabs {
      display: flex;
      gap: 1px;
      margin: 24px 0;
      border-bottom: 1px solid var(--border);
    }
    .tab {
      padding: 12px 24px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      cursor: pointer;
      font-weight: 600;
      border-radius: 8px 8px 0 0;
    }
    .tab.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    /* –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–±–∞–≤–∫–∏ */
    .supplement-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .supplement-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 16px;
    }

    .supplement-header h3 {
      margin: 0;
      font-size: 1.2rem;
    }

    /* –ü–∏–ª–ª—ã */
    .pill {
      padding: 4px 12px;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .pill-good { background: #2ecc71; color: white; }
    .pill-ok { background: #f39c12; color: white; }
    .pill-bad { background: #e74c3c; color: white; }

    /* –°—Ö–µ–º–∞ –ø—Ä–∏—ë–º–∞ */
    .timing-section {
      background: var(--bg-surface-alt);
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
      border-left: 4px solid var(--accent);
    }

    /* –§–æ—Ä–º–∞ */
    .form-section {
      background: var(--bg-surface);
      border-radius: 16px;
      padding: 24px;
      margin: 24px 0;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }

    /* –ü–ª–∞–Ω –ø—Ä–∏—ë–º–∞ */
    .schedule-section {
      background: var(--bg-surface-alt);
      border-radius: 16px;
      padding: 24px;
      margin: 24px 0;
      border-left: 4px solid var(--accent);
    }

    .schedule-time {
      font-weight: 600;
      color: var(--accent);
      margin: 16px 0 8px 0;
    }

    /* –°—Ç–∞—Ç—É—Å—ã */
    .error-text { color: #e74c3c; font-weight: 600; }
    .success-text { color: #2ecc71; font-weight: 600; }
    .info-text { color: #3498db; font-weight: 600; }
  </style>
</head>
<body>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ —à–∞–ø–∫–∏ -->
  <div id="header-placeholder"></div>

  <main id="main-content" tabindex="-1">
    <div class="container">
      <h1>üíä –í–∏—Ç–∞–º–∏–Ω—ã –∏ –¥–æ–±–∞–≤–∫–∏</h1>
      <p>–ù–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å. –ë–µ–∑ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞, —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–∞.</p>

      <!-- –û–ø—Ä–æ—Å–Ω–∏–∫ —Å–∏–º–ø—Ç–æ–º–æ–≤ -->
      <section class="form-section">
        <h2>üîç –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ</h2>
        <p>–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –º—ã –ø–æ–¥–±–µ—Ä—ë–º –¥–æ–±–∞–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ—à–∞—Ç –∏–º–µ–Ω–Ω–æ –≤–∞—à–∏ –ø—Ä–æ–±–ª–µ–º—ã.</p>
        <form id="symptomForm">
          <div class="form-group">
            <label><input type="checkbox" name="fatigue"> –ß–∞—Å—Ç–æ —á—É–≤—Å—Ç–≤—É–µ—Ç–µ —É—Å—Ç–∞–ª–æ—Å—Ç—å, –¥–∞–∂–µ –ø–æ—Å–ª–µ —Å–Ω–∞?</label>
          </div>
          <div class="form-group">
            <label><input type="checkbox" name="jointPain"> –ë–æ–ª—è—Ç —Å—É—Å—Ç–∞–≤—ã –∏–ª–∏ —Å–≤—è–∑–∫–∏?</label>
          </div>
          <div class="form-group">
            <label><input type="checkbox" name="muscleCramps"> –ë—ã–≤–∞—é—Ç –º—ã—à–µ—á–Ω—ã–µ —Å—É–¥–æ—Ä–æ–≥–∏?</label>
          </div>
          <div class="form-group">
            <label><input type="checkbox" name="poorSleep"> –ü–ª–æ—Ö–æ —Å–ø–∏—Ç–µ, —á–∞—Å—Ç–æ –ø—Ä–æ—Å—ã–ø–∞–µ—Ç–µ—Å—å?</label>
          </div>
          <div class="form-group">
            <label><input type="checkbox" name="lowMood"> –ü–æ–≤—ã—à–µ–Ω–Ω–∞—è —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å –∏–ª–∏ –Ω–∏–∑–∫–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?</label>
          </div>
          <div class="form-group">
            <label><input type="checkbox" name="digestiveIssues"> –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ–º?</label>
          </div>
          <button type="submit" class="btn-primary">–ü–æ–¥–æ–±—Ä–∞—Ç—å –¥–æ–±–∞–≤–∫–∏</button>
        </form>
      </section>

      <!-- –ü–ª–∞–Ω –ø—Ä–∏—ë–º–∞ -->
      <section class="schedule-section" id="scheduleSection" style="display: none;">
        <h2>üìÖ –í–∞—à –ø–ª–∞–Ω –ø—Ä–∏—ë–º–∞ –Ω–∞ –¥–µ–Ω—å</h2>
        <div id="scheduleContent"></div>
      </section>

      <!-- –í–∫–ª–∞–¥–∫–∏ -->
      <div class="tab-container">
        <div class="tab-buttons" role="tablist">
          <button class="tab-btn active" role="tab" aria-selected="true">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</button>
          <button class="tab-btn" role="tab" aria-selected="false">–î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</button>
          <button class="tab-btn" role="tab" aria-selected="false">–î–ª—è —ç–Ω–µ—Ä–≥–∏–∏</button>
          <button class="tab-btn" role="tab" aria-selected="false">–ê–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å</button>
          <button class="tab-btn" role="tab" aria-selected="false">–î–ª—è —Å–Ω–∞</button>
        </div>
      </div>

      <!-- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
      <section class="card" id="recommendationsSection">
        <h2>üéØ –í–∞–º –ø–æ–¥–æ–π–¥—É—Ç</h2>
        <p id="recStatus">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π...</p>
        <div id="recommendationsList"></div>
        <p id="noRecMessage" style="display: none;">
          –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Äî <a href="/pages/profile.html">–∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</a>.
        </p>
      </section>
    </div>
  </main>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ –ø–æ–¥–≤–∞–ª–∞ -->
  <div id="footer-placeholder"></div>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

  <!-- –õ–æ–≥–∏–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
  <script type="module">
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { SupplementAdvisor } from '/modules/supplementAdvisor.js';
    import { UserService } from '/services/userService.js';

    document.addEventListener('DOMContentLoaded', async () => {
      await HeaderController.loadHeader();
      new ThemeManager();

      const recStatus = document.getElementById('recStatus');
      const recommendationsList = document.getElementById('recommendationsList');
      const noRecMessage = document.getElementById('noRecMessage');
      const scheduleSection = document.getElementById('scheduleSection');
      const scheduleContent = document.getElementById('scheduleContent');
      const symptomForm = document.getElementById('symptomForm');

      try {
        // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
        const advisor = new SupplementAdvisor();
        await advisor.loadSupplements();

        // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞ ===
        symptomForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const formData = new FormData(symptomForm);

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∏–º–ø—Ç–æ–º—ã –≤ localStorage
          const symptoms = {
            fatigue: formData.has('fatigue'),
            jointPain: formData.has('jointPain'),
            muscleCramps: formData.has('muscleCramps'),
            poorSleep: formData.has('poorSleep'),
            lowMood: formData.has('lowMood'),
            digestiveIssues: formData.has('digestiveIssues')
          };

          Object.keys(symptoms).forEach(key => {
            localStorage.setItem(`morphe-symptom-${key}`, symptoms[key]);
          });

          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
          location.reload();
        });

        // === –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ===
        let recommendations = [];

        try {
          recommendations = await advisor.getPersonalizedRecommendations();
        } catch (err) {
          console.warn('‚ö†Ô∏è –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', err.message);
          recommendations = advisor._getGeneralScienceBased();
          noRecMessage.style.display = 'block';
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        renderSupplements(recommendations, recommendationsList);

        // === –ü–ª–∞–Ω –ø—Ä–∏—ë–º–∞ ‚Äî ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω await ===
        if (recommendations.length > 0) {
          scheduleSection.style.display = 'block';
          const schedule = await advisor.getDailySchedule(); // ‚Üê await

          let scheduleHtml = '';
          if (schedule.morning.length > 0) {
            scheduleHtml += `<div class="schedule-time">üåÖ –£—Ç—Ä–æ</div>`;
            scheduleHtml += schedule.morning.map(s => `<p>‚Ä¢ ${s.name} ‚Äî ${s.dosage}</p>`).join('');
          }
          if (schedule.preWorkout.length > 0) {
            scheduleHtml += `<div class="schedule-time">üí™ –î–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>`;
            scheduleHtml += schedule.preWorkout.map(s => `<p>‚Ä¢ ${s.name} ‚Äî ${s.dosage}</p>`).join('');
          }
          if (schedule.postWorkout.length > 0) {
            scheduleHtml += `<div class="schedule-time">üöø –ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>`;
            scheduleHtml += schedule.postWorkout.map(s => `<p>‚Ä¢ ${s.name} ‚Äî ${s.dosage}</p>`).join('');
          }
          if (schedule.evening.length > 0) {
            scheduleHtml += `<div class="schedule-time">üåô –í–µ—á–µ—Ä</div>`;
            scheduleHtml += schedule.evening.map(s => `<p>‚Ä¢ ${s.name} ‚Äî ${s.dosage}</p>`).join('');
          }

          scheduleContent.innerHTML = scheduleHtml;
        }

        recStatus.style.display = 'none';

        // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫ ===
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
          tab.addEventListener('click', async () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            const category = tab.dataset.tab;
            let supplementsToShow = [];

            if (category === 'personalized') {
              supplementsToShow = recommendations;
            } else {
              supplementsToShow = advisor.getByCategory(category);
            }

            renderSupplements(supplementsToShow, recommendationsList);
          });
        });

      } catch (err) {
        recStatus.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
        recStatus.className = 'error-text';
        console.error(err);
      }
    });

    // === –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –¥–æ–±–∞–≤–æ–∫ ===
    function renderSupplements(supplements, container) {
      if (supplements.length === 0) {
        container.innerHTML = '<p>–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –¥–æ–±–∞–≤–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å–∏–º–ø—Ç–æ–º—ã –∏–ª–∏ —Ü–µ–ª—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ.</p>';
        return;
      }

      container.innerHTML = supplements.map(s => {
        if (!s) return '';

        const benefits = Array.isArray(s.benefits) ? s.benefits.join(', ') : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
        const description = s.description || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
        const dosage = s.dosage || '‚Äî';
        const timing = s.timing || '‚Äî';
        const form = s.form || '‚Äî';
        const sources = Array.isArray(s.sources) ? s.sources[0] : '';

        return `
          <div class="supplement-card">
            <div class="supplement-header">
              <h3>${s.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –¥–æ–±–∞–≤–∫–∞'}</h3>
              <span class="pill ${
                s.evidence?.toLowerCase() === 'strong' ? 'pill-good' : 
                s.evidence?.toLowerCase() === 'moderate' ? 'pill-ok' : 
                'pill-bad'
              }">
                ${s.evidence || 'N/A'}
              </span>
            </div>
            <p><strong>–ü–æ–ª—å–∑–∞:</strong> ${benefits}</p>
            <p><strong>–î–æ–∑–∏—Ä–æ–≤–∫–∞:</strong> ${dosage}</p>
            <p><strong>–ö–æ–≥–¥–∞ –ø—Ä–∏–Ω–∏–º–∞—Ç—å:</strong> ${timing}</p>
            <p><strong>–§–æ—Ä–º–∞:</strong> ${form}</p>
            <p><small>${description}</small></p>
            ${sources ? `<p><strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> <a href="${sources}" target="_blank">–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</a></p>` : ''}
          </div>
        `;
      }).join('');
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥–≤–∞–ª–∞ ===
    document.addEventListener('DOMContentLoaded', async () => {
      await import('/core/HeaderController.js')
        .then(m => m.HeaderController.loadFooter())
        .catch(err => console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–≤–∞–ª–∞:', err));
    });
  </script>
</body>
</html>