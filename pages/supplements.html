<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>–í–∏—Ç–∞–º–∏–Ω—ã –∏ –¥–æ–±–∞–≤–∫–∏ ‚Äî Morphe</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f97316">

  <!-- Module Preload (—É–ª—É—á—à–µ–Ω–æ) -->
  <link rel="modulepreload" href="/modules/supplementAdvisor.js">
  <link rel="modulepreload" href="/core/aiAssistant.js">
  <link rel="modulepreload" href="/services/userService.js">
  <link rel="modulepreload" href="/modules/supplementTracker.js">

  <!-- –ë–∞–∑–∞ -->
  <link rel="stylesheet" href="/styles/base/reset.css">
  <link rel="stylesheet" href="/styles/base/theme.css">
  <link rel="stylesheet" href="/styles/base/typography.css">
  <link rel="stylesheet" href="/styles/base/utilities.css">

  <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -->
  <link rel="stylesheet" href="/styles/components/buttons.css">
  <link rel="stylesheet" href="/styles/components/cards.css">
  <link rel="stylesheet" href="/styles/components/forms.css">
  <link rel="stylesheet" href="/styles/components/tabs.css">
  <link rel="stylesheet" href="/styles/components/mobile-menu.css">

  <!-- –ú–∞–∫–µ—Ç -->
  <link rel="stylesheet" href="/styles/layout/header.css">
  <link rel="stylesheet" href="/styles/layout/footer.css">
  <link rel="stylesheet" href="/styles/layout/scroll-top.css">

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ -->
  <link rel="stylesheet" href="/styles/pages/supplements.css">

</head>
<body>

  <div id="header-placeholder"></div>

  <main id="main-content" tabindex="-1">
    <div class="container">
      <h1><span aria-hidden="true">üíä</span> –í–∏—Ç–∞–º–∏–Ω—ã –∏ –¥–æ–±–∞–≤–∫–∏</h1>
      <p>–ù–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å. –ë–µ–∑ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞, —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–∞.</p>

      <!-- –°–æ–≤–µ—Ç –æ—Ç –ò–ò -->
      <section class="ai-supplement-advice" id="aiSupplementAdvice" aria-live="polite">
        –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–≤–µ—Ç–∞...
      </section>

      <!-- –ü–ª–∞–Ω –ø—Ä–∏—ë–º–∞ -->
      <section class="card" id="scheduleSection" style="display: none; border-left: 4px solid var(--accent);">
        <h2><span aria-hidden="true">üìÖ</span> –í–∞—à –ø–ª–∞–Ω –ø—Ä–∏—ë–º–∞ –Ω–∞ –¥–µ–Ω—å</h2>
        <div id="scheduleContent" aria-live="polite"></div>
      </section>

      <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
      <section class="card">
        <h2><span aria-hidden="true">üéØ</span> –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
        <p id="recStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        <div id="recommendationsList" aria-live="polite"></div>
        <p id="noRecMessage" style="display:none; color:var(--error);">
          <a href="/pages/profile.html">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</a>, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
        </p>
      </section>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <noscript>
    <div class="container" style="padding: 20px; color: var(--error);">
      <p>–î–ª—è —Ä–∞–±–æ—Ç—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∏ –ø–ª–∞–Ω–∞ –ø—Ä–∏—ë–º–∞ –≤–∫–ª—é—á–∏—Ç–µ JavaScript.</p>
    </div>
  </noscript>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(console.warn);
      });
    }
  </script>

  <script type="module">
    // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    function escapeHtml(str) {
      if (typeof str !== 'string') return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '<')
        .replace(/>/g, '>')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // === –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ===
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { SupplementAdvisor } from '/modules/supplementAdvisor.js';

    document.addEventListener('DOMContentLoaded', async () => {
      await HeaderController.loadHeader();
      await HeaderController.loadFooter();
      new ThemeManager();

      const aiAdviceEl = document.getElementById('aiSupplementAdvice');
      const recStatus = document.getElementById('recStatus');
      const recommendationsList = document.getElementById('recommendationsList');
      const noRecMessage = document.getElementById('noRecMessage');
      const scheduleSection = document.getElementById('scheduleSection');
      const scheduleContent = document.getElementById('scheduleContent');

      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ò–ò-—Å–æ–≤–µ—Ç–∞
      async function generateAISupplementAdvice() {
        try {
          const { AIAssistant } = await import('/core/aiAssistant.js');
          const { UserService } = await import('/services/userService.js');
          const ai = new AIAssistant();
          const advice = await ai.generateAdvice();
          const profile = UserService.getRawData() || {};

          if (advice.type === 'tip' && advice.title.includes('–î–æ–±–∞–≤–∫–∞')) {
            const safeTitle = escapeHtml(advice.title);
            const safeMessage = escapeHtml(advice.message);
            aiAdviceEl.innerHTML = `
              <strong>${safeTitle}</strong>
              <p>${safeMessage}</p>
              <div class="ai-actions" role="group" aria-label="–û—Ç–∑—ã–≤ –æ —Å–æ–≤–µ—Ç–µ">
                <button class="btn-sm btn-outline" data-reaction="accepted">–ü–æ–Ω—è—Ç–Ω–æ</button>
                <button class="btn-sm btn-outline" data-reaction="ignored">–ù–∞–ø–æ–º–Ω–∏—Ç—å –ø–æ–∑–∂–µ</button>
                <button class="btn-sm btn-outline" data-reaction="not_helpful">–ù–µ –ø–æ–º–æ–≥–ª–æ</button>
              </div>
            `;

            aiAdviceEl.querySelectorAll('.ai-actions button').forEach(btn => {
              btn.addEventListener('click', () => {
                ai.recordAdviceFeedback(advice.id, btn.dataset.reaction);
                aiAdviceEl.innerHTML = '<p class="info-text">–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤! –°–æ–≤–µ—Ç —É—á—Ç—ë–Ω.</p>';
              });
            });
          } else {
            let message = '–ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ –¥–æ–±–∞–≤–∫–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ ‚Äî —ç—Ç–æ –∫–ª—é—á –∫ —ç—Ñ—Ñ–µ–∫—Ç—É.';

            if (profile?.goal === 'gain') {
              message = '–ö—Ä–µ–∞—Ç–∏–Ω –∏ –±–µ–ª–æ–∫ ‚Äî –≤–∞—à–∏ —Å–æ—é–∑–Ω–∏–∫–∏ –≤ –Ω–∞–±–æ—Ä–µ –º–∞—Å—Å—ã.';
            } else if (profile?.goal === 'lose') {
              message = '–û–º–µ–≥–∞-3 –∏ –≤–∏—Ç–∞–º–∏–Ω D –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º –ø—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ –∫–∞–ª–æ—Ä–∏–π.';
            }

            const extra = [];
            if (profile?.smoking !== 'no') {
              extra.push('–ö—É—Ä–µ–Ω–∏–µ —Å–Ω–∏–∂–∞–µ—Ç —É—Å–≤–æ–µ–Ω–∏–µ –≤–∏—Ç–∞–º–∏–Ω–∞ C ‚Äî —É–≤–µ–ª–∏—á—å—Ç–µ –¥–æ–∑—É.');
            }
            if (profile?.alcohol !== 'none') {
              extra.push('–ê–ª–∫–æ–≥–æ–ª—å –∏—Å—Ç–æ—â–∞–µ—Ç –≤–∏—Ç–∞–º–∏–Ω—ã –≥—Ä—É–ø–ø—ã B ‚Äî –ø—Ä–∏–Ω–∏–º–∞–π—Ç–µ –∫–æ–º–ø–ª–µ–∫—Å.');
            }
            if (profile?.hemoglobin < 120) {
              extra.push('–ù–∏–∑–∫–∏–π –≥–µ–º–æ–≥–ª–æ–±–∏–Ω ‚Äî —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∂–µ–ª–µ–∑–æ —Å –≤–∏—Ç–∞–º–∏–Ω–æ–º C.');
            }
            if (profile?.vitaminD < 20) {
              extra.push('–ù–∏–∑–∫–∏–π –≤–∏—Ç–∞–º–∏–Ω D ‚Äî –ø—Ä–∏–Ω–∏–º–∞–π—Ç–µ 2000‚Äì4000 –ú–ï –µ–∂–µ–¥–Ω–µ–≤–Ω–æ.');
            }

            if (extra.length > 0) {
              message += '<br><br>' + extra.map(escapeHtml).join('<br>');
            }

            aiAdviceEl.innerHTML = `
              <strong>–°–æ–≤–µ—Ç –ø–æ –¥–æ–±–∞–≤–∫–∞–º</strong>
              <p>${escapeHtml(message)}</p>
            `;
          }
        } catch (e) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–≤–µ—Ç –ò–ò:', e);
          aiAdviceEl.innerHTML = '<p class="info-text">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Å–æ–≤–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</p>';
        }
      }

      // –†–µ–Ω–¥–µ—Ä —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Å –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–æ–º (—Å ARIA –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é)
      function renderRecommendations(supplements, container) {
        if (!Array.isArray(supplements) || supplements.length === 0) {
          container.innerHTML = '<p>–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –¥–æ–±–∞–≤–æ–∫.</p>';
          return;
        }

        const cardsHtml = supplements.map(s => {
          const id = escapeHtml(s.id);
          const name = escapeHtml(s.name);
          const benefits = Array.isArray(s.benefits) ? escapeHtml(s.benefits.join(', ')) : '‚Äî';
          const description = escapeHtml(s.description || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
          const dosage = escapeHtml(s.dosage || '‚Äî');
          const timing = escapeHtml(s.timingText || '‚Äî');
          const form = escapeHtml(s.form || '‚Äî');
          const sources = Array.isArray(s.sources) ? escapeHtml(s.sources[0]) : '';

          let pillClass = 'pill-bad';
          let evidenceText = 'N/A';
          if (s.evidenceLevel === 'A') {
            pillClass = 'pill-good';
            evidenceText = 'Strong';
          } else if (s.evidenceLevel === 'B') {
            pillClass = 'pill-ok';
            evidenceText = 'Moderate';
          }

          return `
            <div class="supplement-card" data-id="${id}" id="card-${id}">
              <div class="supplement-header" 
                   role="button" 
                   tabindex="0"
                   aria-expanded="false"
                   aria-controls="content-${id}">
                <div>
                  <h3>${name}</h3>
                  <p style="margin:4px 0 0; color:var(--text-secondary); font-size:0.9rem;">
                    ${dosage} ‚Ä¢ ${timing}
                  </p>
                </div>
                <div class="supplement-toggle">
                  <span class="pill ${pillClass}">${evidenceText}</span>
                  <span class="supplement-toggle-icon" aria-hidden="true">‚ñº</span>
                </div>
              </div>
              <div class="supplement-content" id="content-${id}" hidden>
                <div class="supplement-detail">
                  <strong>–ü–æ–ª—å–∑–∞:</strong> ${benefits}
                </div>
                <div class="supplement-detail">
                  <strong>–§–æ—Ä–º–∞:</strong> ${form}
                </div>
                <div class="supplement-detail">
                  <small>${description}</small>
                </div>
                ${sources ? `
                  <div class="supplement-source">
                    <strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> 
                    <a href="${sources}" target="_blank" rel="noopener">–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</a>
                  </div>
                ` : ''}
                <p class="text-muted" style="margin-top: 12px;">
                  <a href="#scheduleSection" 
                     onclick="document.getElementById('scheduleSection').scrollIntoView({behavior:'smooth'}); return false;"
                     aria-label="–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–ª–∞–Ω—É –ø—Ä–∏—ë–º–∞ –¥–ª—è ${name}">
                    ‚Üí –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ø–ª–∞–Ω–µ –ø—Ä–∏—ë–º–∞
                  </a>
                </p>
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = cardsHtml;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞
        container.querySelectorAll('.supplement-header').forEach(header => {
          const card = header.closest('.supplement-card');
          const content = card.querySelector('.supplement-content');

          const toggle = () => {
            const isExpanded = card.classList.toggle('expanded');
            header.setAttribute('aria-expanded', isExpanded);
            content.toggleAttribute('hidden', !isExpanded);
          };

          header.addEventListener('click', toggle);
          header.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              toggle();
            }
          });
        });
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∏ –ø–ª–∞–Ω–∞
      async function updateRecommendations() {
        recStatus.textContent = '–ü–æ–¥–±–æ—Ä –¥–æ–±–∞–≤–æ–∫...';
        recStatus.style.display = 'block';

        try {
          const { UserService } = await import('/services/userService.js');
          const fullProfile = UserService.getRawData() || {};

          const advisor = new SupplementAdvisor();
          let recommendations = await advisor.getPersonalizedRecommendations();

          const chronic = fullProfile.chronicConditions || [];
          if (chronic.includes('diabetes')) {
            recommendations = recommendations.filter(s => 
              !s.name.toLowerCase().includes('–≥–µ–π–Ω–µ—Ä') && 
              !s.description?.toLowerCase().includes('—Å–∞—Ö–∞—Ä')
            );
          }
          if (chronic.includes('heart') || chronic.includes('hypertension')) {
            recommendations = recommendations.filter(s => 
              !s.name.toLowerCase().includes('–∫–æ—Ñ–µ–∏–Ω') &&
              !s.description?.toLowerCase().includes('—Å—Ç–∏–º—É–ª—è—Ç–æ—Ä')
            );
          }

          renderRecommendations(recommendations, recommendationsList);

          if (recommendations.length > 0) {
            scheduleSection.style.display = 'block';
            const schedule = await advisor.getDailySchedule();

            const today = new Date().toISOString().split('T')[0];
            const { SupplementTracker } = await import('/modules/supplementTracker.js');
            const tracker = new SupplementTracker();
            const todayEntries = tracker.getEntriesByDate(today);
            const todayAccepted = new Set(todayEntries.map(e => e.supplementId));

            const renderSupplementItem = (sup) => {
              const id = escapeHtml(sup.id);
              const name = escapeHtml(sup.name);
              const dosage = escapeHtml(sup.dosage || '‚Äî');
              const isTaken = todayAccepted.has(sup.id);
              return `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0;">
                  <span>${name} ‚Äî ${dosage}</span>
                  <button type="button" class="btn-outline btn-small accept-today-btn" 
                          data-id="${id}" 
                          data-taken="${isTaken}"
                          aria-pressed="${isTaken}">
                    ${isTaken ? '‚úÖ –ü—Ä–∏–Ω—è—Ç–æ' : '–ü—Ä–∏–Ω—è—Ç—å'}
                  </button>
                </div>
              `;
            };

            let html = '';
            if (schedule.morning?.length) {
              html += `<div class="schedule-time">üåÖ –£—Ç—Ä–æ</div>` + schedule.morning.map(renderSupplementItem).join('');
            }
            if (schedule.preWorkout?.length) {
              html += `<div class="schedule-time">üí™ –î–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>` + schedule.preWorkout.map(renderSupplementItem).join('');
            }
            if (schedule.postWorkout?.length) {
              html += `<div class="schedule-time">üöø –ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>` + schedule.postWorkout.map(renderSupplementItem).join('');
            }
            if (schedule.evening?.length) {
              html += `<div class="schedule-time">üåô –í–µ—á–µ—Ä</div>` + schedule.evening.map(renderSupplementItem).join('');
            }

            scheduleContent.innerHTML = html || '<p>–ù–µ—Ç –¥–æ–±–∞–≤–æ–∫ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.</p>';

            scheduleContent.querySelectorAll('.accept-today-btn').forEach(btn => {
              btn.addEventListener('click', async () => {
                const id = btn.dataset.id;
                const isNowTaken = !JSON.parse(btn.dataset.taken);
                
                const tracker = new SupplementTracker();
                if (isNowTaken) {
                  tracker.add(id);
                  try {
                    const { AIAssistant } = await import('/core/aiAssistant.js');
                    const ai = new AIAssistant();
                    ai.recordUserAction('supplement_taken', { supplementId: id });
                  } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –≤ –ò–ò:', e);
                  }
                }
                
                btn.textContent = isNowTaken ? '‚úÖ –ü—Ä–∏–Ω—è—Ç–æ' : '–ü—Ä–∏–Ω—è—Ç—å';
                btn.dataset.taken = isNowTaken;
                btn.setAttribute('aria-pressed', isNowTaken);
                btn.classList.toggle('btn-primary', isNowTaken);
                btn.classList.toggle('btn-outline', !isNowTaken);
              });
            });

          } else {
            scheduleSection.style.display = 'none';
          }

          recStatus.style.display = 'none';
          noRecMessage.style.display = 'none';

        } catch (err) {
          recStatus.textContent = `‚ùå –û—à–∏–±–∫–∞: ${escapeHtml(err.message)}`;
          recStatus.className = 'error-text';
          noRecMessage.style.display = 'block';
          scheduleSection.style.display = 'none';
          console.error(err);
        }
      }

      generateAISupplementAdvice();
      updateRecommendations();
    });
  </script>  
</body>
</html>