<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>–í–∏—Ç–∞–º–∏–Ω—ã –∏ –¥–æ–±–∞–≤–∫–∏ ‚Äî Morphe</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f97316">

  <!-- Module Preload -->
  <link rel="modulepreload" href="/modules/supplementAdvisor.js">

  <!-- –°—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/styles-shared.css">
  <link rel="stylesheet" href="/styles-header.css">
</head>
<body>

  <div id="header-placeholder"></div>

  <main id="main-content" tabindex="-1">
    <div class="container">
      <h1>üíä –í–∏—Ç–∞–º–∏–Ω—ã –∏ –¥–æ–±–∞–≤–∫–∏</h1>
      <p>–ù–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å. –ë–µ–∑ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞, —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–∞.</p>

      <!-- –ü–ª–∞–Ω –ø—Ä–∏—ë–º–∞ -->
      <section class="card" id="scheduleSection" style="display: none; border-left: 4px solid var(--accent);">
        <h2>üìÖ –í–∞—à –ø–ª–∞–Ω –ø—Ä–∏—ë–º–∞ –Ω–∞ –¥–µ–Ω—å</h2>
        <div id="scheduleContent"></div>
      </section>

      <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
      <section class="card">
        <h2>üéØ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
        <p id="recStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        <div id="recommendationsList"></div>
        <p id="noRecMessage" style="display:none; color:var(--error);">
          <a href="/pages/profile.html">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</a>, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
        </p>
      </section>
    </div>
  </main>
  <div id="footer-placeholder"></div>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

  <script type="module">
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { SupplementAdvisor } from '/modules/supplementAdvisor.js';

    document.addEventListener('DOMContentLoaded', async () => {
      await HeaderController.loadHeader();
      await HeaderController.loadFooter();
      new ThemeManager();

      const recStatus = document.getElementById('recStatus');
      const recommendationsList = document.getElementById('recommendationsList');
      const noRecMessage = document.getElementById('noRecMessage');
      const scheduleSection = document.getElementById('scheduleSection');
      const scheduleContent = document.getElementById('scheduleContent');

      let currentRecommendations = [];

      // –ü—Ä–∏–Ω—è—Ç—ã–µ –¥–æ–±–∞–≤–∫–∏
      function getAcceptedSupplements() {
        const saved = localStorage.getItem('morphe-accepted-supplements');
        return saved ? new Set(JSON.parse(saved)) : new Set();
      }

      function setAcceptedSupplement(supplementId, accepted) {
        const acceptedSet = getAcceptedSupplements();
        if (accepted) {
          acceptedSet.add(supplementId);
        } else {
          acceptedSet.delete(supplementId);
        }
        localStorage.setItem('morphe-accepted-supplements', JSON.stringify([...acceptedSet]));
      }

      // –†–µ–Ω–¥–µ—Ä –¥–æ–±–∞–≤–æ–∫
      function renderSupplements(supplements, container) {
        if (!Array.isArray(supplements) || supplements.length === 0) {
          container.innerHTML = '<p>–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –¥–æ–±–∞–≤–æ–∫.</p>';
          return;
        }

        const acceptedSet = getAcceptedSupplements();
        container.innerHTML = supplements.map(s => {
          const benefits = Array.isArray(s.benefits) ? s.benefits.join(', ') : '‚Äî';
          const description = s.description || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
          const dosage = s.dosage || '‚Äî';
          const timing = s.timingText || '‚Äî';
          const form = s.form || '‚Äî';
          const sources = Array.isArray(s.sources) ? s.sources[0] : '';

          let pillClass = 'pill-bad';
          let evidenceText = 'N/A';
          if (s.evidenceLevel === 'A') {
            pillClass = 'pill-good';
            evidenceText = 'Strong';
          } else if (s.evidenceLevel === 'B') {
            pillClass = 'pill-ok';
            evidenceText = 'Moderate';
          } else if (s.evidenceLevel === 'C') {
            pillClass = 'pill-bad';
            evidenceText = 'Limited';
          }

          const isAccepted = acceptedSet.has(s.id);
          const acceptBtnText = isAccepted ? '‚úÖ –ü—Ä–∏–Ω—è—Ç–æ' : '–ü—Ä–∏–Ω—è—Ç—å';

          return `
            <div class="card supplement-card">
              <div class="supplement-header">
                <h3>${s.name}</h3>
                <span class="pill ${pillClass}">${evidenceText}</span>
              </div>
              <p><strong>–ü–æ–ª—å–∑–∞:</strong> ${benefits}</p>
              <p><strong>–î–æ–∑–∏—Ä–æ–≤–∫–∞:</strong> ${dosage}</p>
              <p><strong>–ö–æ–≥–¥–∞ –ø—Ä–∏–Ω–∏–º–∞—Ç—å:</strong> ${timing}</p>
              <p><strong>–§–æ—Ä–º–∞:</strong> ${form}</p>
              <p><small>${description}</small></p>
              ${sources ? `<p><strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> <a href="${sources}" target="_blank" rel="noopener">–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</a></p>` : ''}
              <button type="button" class="btn-outline btn-small accept-btn" data-id="${s.id}">
                ${acceptBtnText}
              </button>
            </div>
          `;
        }).join('');

        container.querySelectorAll('.accept-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            const isNowAccepted = !getAcceptedSupplements().has(id);
            setAcceptedSupplement(id, isNowAccepted);
            btn.textContent = isNowAccepted ? '‚úÖ –ü—Ä–∏–Ω—è—Ç–æ' : '–ü—Ä–∏–Ω—è—Ç—å';
            btn.classList.toggle('btn-primary', isNowAccepted);
            btn.classList.toggle('btn-outline', !isNowAccepted);
          });
        });
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∏ –ø–ª–∞–Ω–∞
      async function updateRecommendations() {
        recStatus.textContent = '–ü–æ–¥–±–æ—Ä –¥–æ–±–∞–≤–æ–∫...';
        recStatus.style.display = 'block';

        try {
          const advisor = new SupplementAdvisor();
          const recommendations = await advisor.getPersonalizedRecommendations();
          currentRecommendations = recommendations;
          renderSupplements(recommendations, recommendationsList);

          if (recommendations.length > 0) {
            scheduleSection.style.display = 'block';
            const schedule = await advisor.getDailySchedule();
            let html = '';
            if (schedule.morning?.length) {
              html += `<div class="schedule-time">üåÖ –£—Ç—Ä–æ</div>` + schedule.morning.map(s => `<p>‚Ä¢ ${s.name} ‚Äî ${s.dosage}</p>`).join('');
            }
            if (schedule.preWorkout?.length) {
              html += `<div class="schedule-time">üí™ –î–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>` + schedule.preWorkout.map(s => `<p>‚Ä¢ ${s.name} ‚Äî ${s.dosage}</p>`).join('');
            }
            if (schedule.postWorkout?.length) {
              html += `<div class="schedule-time">üöø –ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>` + schedule.postWorkout.map(s => `<p>‚Ä¢ ${s.name} ‚Äî ${s.dosage}</p>`).join('');
            }
            if (schedule.evening?.length) {
              html += `<div class="schedule-time">üåô –í–µ—á–µ—Ä</div>` + schedule.evening.map(s => `<p>‚Ä¢ ${s.name} ‚Äî ${s.dosage}</p>`).join('');
            }
            scheduleContent.innerHTML = html || '<p>–ù–µ—Ç –¥–æ–±–∞–≤–æ–∫ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.</p>';
          } else {
            scheduleSection.style.display = 'none';
          }

          recStatus.style.display = 'none';
          noRecMessage.style.display = 'none';

        } catch (err) {
          recStatus.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
          recStatus.className = 'error-text';
          noRecMessage.style.display = 'block';
          scheduleSection.style.display = 'none';
          console.error(err);
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      updateRecommendations();
    });
  </script>

  <style>
    .supplement-card {
      margin-bottom: 24px;
      position: relative;
    }
    .supplement-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 16px;
    }
    .supplement-header h3 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--text-primary);
    }
    .schedule-time {
      font-weight: 600;
      color: var(--accent);
      margin: 16px 0 8px 0;
      font-size: 1.1rem;
    }
    .text-center {
      text-align: center;
    }
    @media (max-width: 768px) {
      .supplement-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .supplement-header .pill {
        margin-top: 8px;
      }
    }
  </style>
</body>
</html>