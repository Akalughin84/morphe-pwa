<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>–ü–∏—Ç–∞–Ω–∏–µ ‚Äî Morphe</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f97316">

  <!-- –ë–∞–∑–∞ -->
  <link rel="stylesheet" href="/styles/base/reset.css">
  <link rel="stylesheet" href="/styles/base/theme.css">
  <link rel="stylesheet" href="/styles/base/typography.css">
  <link rel="stylesheet" href="/styles/base/utilities.css">

  <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -->
  <link rel="stylesheet" href="/styles/components/buttons.css">
  <link rel="stylesheet" href="/styles/components/cards.css">
  <link rel="stylesheet" href="/styles/components/forms.css">
  <link rel="stylesheet" href="/styles/components/tabs.css">
  <link rel="stylesheet" href="/styles/components/mobile-menu.css">

  <!-- –ú–∞–∫–µ—Ç -->
  <link rel="stylesheet" href="/styles/layout/header.css">
  <link rel="stylesheet" href="/styles/layout/footer.css">
  <link rel="stylesheet" href="/styles/layout/scroll-top.css">

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ -->
  <link rel="stylesheet" href="/styles/pages/nutrition.css">

  
</head>
<body>

  <div id="header-placeholder"></div>

  <main id="main-content" tabindex="-1">
    <div class="container">
      <h1>ü•ó –ü–∏—Ç–∞–Ω–∏–µ</h1>
      <p id="nutritionStatus" class="info-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>

      <div id="nutritionContent" style="display: none;" aria-live="polite">

        <!-- üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –≤–µ—Å–∞ -->
        <section class="card forecast-card" id="weightForecastSection" style="display: none; margin-top: 0;">
          <h2>üìà –ü—Ä–æ–≥–Ω–æ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Å–∞</h2>
          <p id="weightForecastText">‚Äî</p>
          <p><small>–†–∞—Å—Å—á–∏—Ç–∞–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–≥–æ —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –∫–∞–ª–æ—Ä–∏–π.</small></p>
        </section>

        <!-- üìä –ù–æ—Ä–º—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è -->
        <section class="card">
          <h2>üìä –í–∞—à–∏ –Ω–æ—Ä–º—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <h3>üî• –ö–∞–ª–æ—Ä–∏–∏</h3>
              <div class="progress-bar">
                <div id="caloriesBar" class="bar-fill" style="width: 0%"></div>
              </div>
              <p><strong><span id="caloriesEaten">0</span></strong> / <span id="caloriesTarget">‚Äî</span> –∫–∫–∞–ª</p>
            </div>
            <div class="stat-card">
              <h3>üçó –ë–µ–ª–∫–∏</h3>
              <div class="progress-bar">
                <div id="proteinBar" class="bar-fill" style="width: 0%"></div>
              </div>
              <p><strong><span id="proteinEaten">0</span></strong> / <span id="proteinTarget">‚Äî</span> –≥</p>
            </div>
            <div class="stat-card">
              <h3>ü•ë –ñ–∏—Ä—ã</h3>
              <div class="progress-bar">
                <div id="fatsBar" class="bar-fill" style="width: 0%"></div>
              </div>
              <p><strong><span id="fatsEaten">0</span></strong> / <span id="fatsTarget">‚Äî</span> –≥</p>
            </div>
            <div class="stat-card">
              <h3>üçö –£–≥–ª–µ–≤–æ–¥—ã</h3>
              <div class="progress-bar">
                <div id="carbsBar" class="bar-fill" style="width: 0%"></div>
              </div>
              <p><strong><span id="carbsEaten">0</span></strong> / <span id="carbsTarget">‚Äî</span> –≥</p>
            </div>
          </div>
        </section>

        <!-- üí° –°–æ–≤–µ—Ç –¥–Ω—è -->
        <section class="card">
          <h2>üí° –°–æ–≤–µ—Ç –¥–Ω—è</h2>
          <p id="dailyAdvice">‚Äî</p>
        </section>

        <!-- ü•ó –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ–Ω—é -->
        <section class="card">
          <h2>ü•ó –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ–Ω—é</h2>
          <p id="menuStatus" class="info-text">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ–Ω—é...</p>
          <div id="dailyMenu" style="display: none;">
            <div class="meal-plan">
              <div class="meal">
                <h3>üåÖ –ó–∞–≤—Ç—Ä–∞–∫</h3>
                <ul id="breakfastItems" class="meal-items-list"></ul>
              </div>
              <div class="meal">
                <h3>üåû –û–±–µ–¥</h3>
                <ul id="lunchItems" class="meal-items-list"></ul>
              </div>
              <div class="meal">
                <h3>üåô –£–∂–∏–Ω</h3>
                <ul id="dinnerItems" class="meal-items-list"></ul>
                <button id="dinnerAltBtn" class="btn-secondary btn-small" style="margin-top: 12px; display: none;">
                  –î—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç —É–∂–∏–Ω–∞
                </button>
              </div>
            </div>
            <div class="total-calories" style="margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border);">
              <strong>–ò—Ç–æ–≥–æ: <span id="totalCalories">‚Äî</span> –∫–∫–∞–ª</strong>
              <br>
              <small>–¶–µ–ª—å: <span id="targetCalories">‚Äî</span> –∫–∫–∞–ª</small>
            </div>
          </div>
        </section>

        <!-- ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ -->
        <section class="card">
          <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h2>
          <div class="form-group">
            <label for="mealSelect">–ü—Ä–∏—ë–º –ø–∏—â–∏</label>
            <select id="mealSelect" class="form-control">
              <option value="breakfast">üåÖ –ó–∞–≤—Ç—Ä–∞–∫</option>
              <option value="lunch">üåû –û–±–µ–¥</option>
              <option value="dinner">üåô –£–∂–∏–Ω</option>
              <option value="snack">üç™ –ü–µ—Ä–µ–∫—É—Å</option>
            </select>
          </div>
          <div class="form-group">
            <label for="foodSearch">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</label>
            <input type="text" id="foodSearch" class="form-control" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å...">
            <div id="foodSuggestions" class="food-suggestions"></div>
          </div>
          <div id="selectedFoodDetails" style="display: none;">
            <div class="form-group">
              <label for="foodGrams">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–≥—Ä–∞–º–º—ã)</label>
              <input type="number" id="foodGrams" class="form-control" placeholder="100" min="1" step="1">
            </div>
            <div class="food-details">
              <div>
                <p><strong>–ö–∞–ª–æ—Ä–∏–∏:</strong> <span id="foodCalories">‚Äî</span> –∫–∫–∞–ª/100–≥</p>
                <p><strong>–ë–µ–ª–∫–∏:</strong> <span id="foodProtein">‚Äî</span> –≥</p>
              </div>
              <div>
                <p><strong>–ñ–∏—Ä—ã:</strong> <span id="foodFats">‚Äî</span> –≥</p>
                <p><strong>–£–≥–ª–µ–≤–æ–¥—ã:</strong> <span id="foodCarbs">‚Äî</span> –≥</p>
              </div>
            </div>
            <button id="addFoodBtn" class="btn-primary btn-small" style="margin-top: 16px;">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫</button>
          </div>
        </section>

        <!-- üìã –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–Ω–µ–≤–Ω–∏–∫ -->
        <section class="card">
          <h2>üìã –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–Ω–µ–≤–Ω–∏–∫</h2>
          <div id="todayMealsLog">
            <div id="breakfastLog" class="meal-log">
              <h3>üåÖ –ó–∞–≤—Ç—Ä–∞–∫</h3>
              <div id="breakfastEntries"></div>
            </div>
            <div id="lunchLog" class="meal-log">
              <h3>üåû –û–±–µ–¥</h3>
              <div id="lunchEntries"></div>
            </div>
            <div id="dinnerLog" class="meal-log">
              <h3>üåô –£–∂–∏–Ω</h3>
              <div id="dinnerEntries"></div>
            </div>
            <div id="snackLog" class="meal-log">
              <h3>üç™ –ü–µ—Ä–µ–∫—É—Å</h3>
              <div id="snackEntries"></div>
            </div>
            <div id="supplementLog" class="meal-log">
              <h3>üíä –î–æ–±–∞–≤–∫–∏</h3>
              <div id="supplementEntries"></div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

  <script type="module">
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { UserService } from '/services/userService.js';
    import { AIAssistant } from '/modules/aiAssistant.js';
    import { AnalyticsEngine } from '/core/analytics.js';

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await HeaderController.loadHeader();
        await HeaderController.loadFooter();
        new ThemeManager();

        const statusEl = document.getElementById('nutritionStatus');
        const contentEl = document.getElementById('nutritionContent');
        const forecastSection = document.getElementById('weightForecastSection');

        if (!UserService.isProfileComplete()) {
          statusEl.textContent = "‚ùå –ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –Ω–æ—Ä–º—ã, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å.";
          statusEl.className = "error-text";
          return;
        }

        // ‚úÖ –í–ê–ñ–ù–û: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤–∞—à–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const profileData = UserService.getProfile()?.data;
        const { NutritionEngine } = await import('/core/nutritionEngine.js');
        const nutritionEngine = new NutritionEngine({ data: profileData, isComplete: true });

        const plan = {
          target: nutritionEngine.calculateTargetCalories(),
          macros: nutritionEngine.calculateMacros()
        };

        document.getElementById('caloriesTarget').textContent = plan.target || '‚Äî';
        document.getElementById('proteinTarget').textContent = plan.macros?.protein || '‚Äî';
        document.getElementById('fatsTarget').textContent = plan.macros?.fats || '‚Äî';
        document.getElementById('carbsTarget').textContent = plan.macros?.carbs || '‚Äî';

        let advice = nutritionEngine.getAdvice();

        try {
          const ai = new AIAssistant();
          const aiAdvice = await ai.generateAdvice();
          advice += `\n\n${aiAdvice.emoji || ''} ${aiAdvice.title}: ${aiAdvice.message}`;
        } catch (e) {
          console.warn('AI —Å–æ–≤–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', e);
        }

        document.getElementById('dailyAdvice').innerHTML = advice
          .split('\n\n')
          .map(p => `<p>${p}</p>`)
          .join('');

        const { NutritionTracker } = await import('/modules/nutritionTracker.js');
        const { SupplementTracker } = await import('/modules/supplementTracker.js');
        const tracker = new NutritionTracker();
        const supplementTracker = new SupplementTracker();

        const updateProgress = async () => {
          const daily = tracker.getTotalMacrosToday();
          
          let supplementCalories = 0;
          const supplementEntries = supplementTracker.getEntriesByDate();
          
          if (supplementEntries.length > 0) {
            const supplements = await (await fetch('/data/supplements.json')).json();
            const supplementMap = Object.fromEntries(supplements.map(s => [s.id, s]));
            
            supplementEntries.forEach(entry => {
              const sup = supplementMap[entry.supplementId];
              if (sup && sup.calories) {
                supplementCalories += sup.calories;
              }
            });
          }

          const totalCalories = daily.calories + supplementCalories;
          document.getElementById('caloriesEaten').textContent = Math.round(totalCalories);
          document.getElementById('proteinEaten').textContent = Math.round(daily.protein);
          document.getElementById('fatsEaten').textContent = Math.round(daily.fats);
          document.getElementById('carbsEaten').textContent = Math.round(daily.carbs);

          const updateBar = (value, max, barId) => {
            if (!max || max <= 0) return;
            const percent = Math.min(100, (value / max) * 100);
            const bar = document.getElementById(barId);
            bar.style.width = `${percent}%`;
            bar.className = 'bar-fill';
            if (percent >= 100) bar.classList.add('over-limit');
            else if (percent >= 80) bar.classList.add('near-limit');
          };

          updateBar(totalCalories, plan.target, 'caloriesBar');
          updateBar(daily.protein, plan.macros?.protein, 'proteinBar');
          updateBar(daily.fats, plan.macros?.fats, 'fatsBar');
          updateBar(daily.carbs, plan.macros?.carbs, 'carbsBar');
        };

        const renderTodayLog = async () => {
          const meals = ['breakfast', 'lunch', 'dinner', 'snack'];
          meals.forEach(meal => {
            const entries = tracker.getTodayByMeal(meal);
            const container = document.getElementById(`${meal}Entries`);
            
            if (entries.length === 0) {
              container.innerHTML = '<p class="small-text">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
              return;
            }

            container.innerHTML = entries.map(entry => `
              <div class="meal-entry">
                <div>
                  <strong>${entry.name}</strong> (${entry.grams}–≥) ‚Ä¢ ${Math.round(entry.calories * entry.grams / 100)} –∫–∫–∞–ª
                </div>
                <button type="button" class="remove-btn" data-timestamp="${entry.timestamp}">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            `).join('');

            container.querySelectorAll('.remove-btn').forEach(btn => {
              btn.addEventListener('click', () => {
                tracker.remove(parseInt(btn.dataset.timestamp));
                renderTodayLog();
                updateProgress();
              });
            });
          });

          const supplementEntries = supplementTracker.getEntriesByDate();
          const supplementContainer = document.getElementById('supplementEntries');

          if (supplementEntries.length === 0) {
            supplementContainer.innerHTML = '<p class="small-text">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
          } else {
            const supplements = await (await fetch('/data/supplements.json')).json();
            const supplementMap = Object.fromEntries(supplements.map(s => [s.id, s]));

            supplementContainer.innerHTML = supplementEntries.map(entry => `
              <div class="meal-entry">
                <div><strong>${supplementMap[entry.supplementId]?.name || '–î–æ–±–∞–≤–∫–∞'}</strong></div>
                <button type="button" class="remove-btn" data-id="${entry.id}">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            `).join('');

            supplementContainer.querySelectorAll('.remove-btn').forEach(btn => {
              btn.addEventListener('click', () => {
                supplementTracker.remove(btn.dataset.id);
                renderTodayLog();
                updateProgress();
              });
            });
          }
        };

        let foods = [];
        try {
          const response = await fetch('/data/foods.json');
          foods = await response.json();
        } catch (err) {
          console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', err);
          foods = [{ id: 'custom', name: '–ö–∞—Å—Ç–æ–º–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç', calories: 0, protein: 0, fats: 0, carbs: 0 }];
        }

        const foodSearch = document.getElementById('foodSearch');
        const foodSuggestions = document.getElementById('foodSuggestions');
        const selectedFoodDetails = document.getElementById('selectedFoodDetails');
        let selectedFood = null;

        foodSearch.addEventListener('input', () => {
          const term = foodSearch.value.toLowerCase();
          if (term.length < 2) {
            foodSuggestions.style.display = 'none';
            return;
          }

          const matches = foods.filter(f => f.name.toLowerCase().includes(term));
          foodSuggestions.innerHTML = matches.map(f => `
            <div class="food-item" data-id="${f.id}" data-name="${f.name}" data-cal="${f.calories}" data-pro="${f.protein}" data-fat="${f.fats}" data-carb="${f.carbs}">
              ${f.name} ‚Äî ${f.calories} –∫–∫–∞–ª
            </div>
          `).join('');

          foodSuggestions.style.display = matches.length > 0 ? 'block' : 'none';

          foodSuggestions.querySelectorAll('.food-item').forEach(item => {
            item.addEventListener('click', () => {
              selectedFood = {
                id: item.dataset.id,
                name: item.dataset.name,
                calories: parseFloat(item.dataset.cal),
                protein: parseFloat(item.dataset.pro),
                fats: parseFloat(item.dataset.fat),
                carbs: parseFloat(item.dataset.carb)
              };

              document.getElementById('foodCalories').textContent = selectedFood.calories;
              document.getElementById('foodProtein').textContent = selectedFood.protein;
              document.getElementById('foodFats').textContent = selectedFood.fats;
              document.getElementById('foodCarbs').textContent = selectedFood.carbs;

              foodSearch.value = selectedFood.name;
              foodSuggestions.style.display = 'none';
              selectedFoodDetails.style.display = 'block';
              document.getElementById('foodGrams').focus();
            });
          });
        });

        document.getElementById('addFoodBtn').addEventListener('click', () => {
          if (!selectedFood) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç –∏–∑ —Å–ø–∏—Å–∫–∞');
            return;
          }

          const grams = parseFloat(document.getElementById('foodGrams').value);
          if (!grams || grams <= 0) {
            alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä–∞–º–º');
            return;
          }

          const mealType = document.getElementById('mealSelect').value;
          tracker.add(selectedFood, grams, mealType);

          foodSearch.value = '';
          selectedFoodDetails.style.display = 'none';
          selectedFood = null;
          document.getElementById('foodGrams').value = '';

          renderTodayLog();
          updateProgress();

          const status = document.createElement('div');
          status.className = 'success-text';
          status.textContent = '‚úÖ –ü—Ä–æ–¥—É–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω!';
          status.style.margin = '16px 0';
          document.querySelector('.card:last-child').appendChild(status);
          setTimeout(() => status.remove(), 3000);
        });

        // ‚úÖ –ì–ï–ù–ï–†–ê–¶–ò–Ø –ú–ï–ù–Æ ‚Äî —Å –º–∏–∫—Ä–æ-—Å–æ–≤–µ—Ç–∞–º–∏ –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞–º–∏
        const menuStatus = document.getElementById('menuStatus');
        const dailyMenu = document.getElementById('dailyMenu');

        // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π tip
        const renderMealItems = (items, containerId) => {
          const container = document.getElementById(containerId);
          if (!container) return;
          container.innerHTML = items.map(i => {
            const calories = Math.round(i.calories * i.grams / 100);
            const tipHtml = i.tip ? `<span class="meal-item-tip">üí° ${i.tip}</span>` : '';
            return `
              <li>
                <div class="meal-item-name">${i.name}</div>
                <div class="meal-item-portion">${i.grams} –≥ ‚Ä¢ ${calories} –∫–∫–∞–ª</div>
                ${tipHtml}
              </li>
            `;
          }).join('');
        };

        try {
          const { MenuGenerator } = await import('/core/menuGenerator.js');
          const generator = new MenuGenerator();
          const menu = await generator.generateMenu();

          if (menu && menu.breakfast && menu.lunch && menu.dinner) {
            renderMealItems(menu.breakfast.items, 'breakfastItems');
            renderMealItems(menu.lunch.items, 'lunchItems');
            renderMealItems(menu.dinner.items, 'dinnerItems');

            document.getElementById('totalCalories').textContent = menu.totalCalories || 0;
            document.getElementById('targetCalories').textContent = menu.targetCalories || plan.target;

            // –ö–Ω–æ–ø–∫–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤ ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
            const altBtn = document.getElementById('dinnerAltBtn');
            if (menu.dinnerAlternatives && menu.dinnerAlternatives.length > 1) {
              let currentIdx = 0;
              altBtn.style.display = 'inline-block';
              altBtn.onclick = () => {
                currentIdx = (currentIdx + 1) % menu.dinnerAlternatives.length;
                const newDinner = menu.dinnerAlternatives[currentIdx];
                renderMealItems(newDinner.items, 'dinnerItems');
                const newTotal = Math.round(
                  menu.breakfast.totalCalories +
                  menu.lunch.totalCalories +
                  newDinner.totalCalories
                );
                document.getElementById('totalCalories').textContent = newTotal;
              };
            }

            menuStatus.style.display = 'none';
            dailyMenu.style.display = 'block';
          }
        } catch (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–µ–Ω—é:', err);
          menuStatus.textContent = `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–µ–Ω—é: ${err.message}`;
          menuStatus.className = 'error-text';
        }

        // ‚úÖ –ü—Ä–æ–≥–Ω–æ–∑ –≤–µ—Å–∞
        try {
          const analytics = new AnalyticsEngine(profileData);
          const progressInsight = await analytics._getProgressInsight();
          document.getElementById('weightForecastText').textContent = progressInsight.text || '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞.';
          forecastSection.style.display = 'block';
        } catch (err) {
          console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –≤–µ—Å–∞:', err);
          document.getElementById('weightForecastText').textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑.';
          forecastSection.style.display = 'block';
        }

        updateProgress();
        renderTodayLog();
        statusEl.style.display = 'none';
        contentEl.style.display = 'block';

      } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–∏—Ç–∞–Ω–∏—è:', err);
        const statusEl = document.getElementById('nutritionStatus');
        if (statusEl) {
          statusEl.textContent = `‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${err.message}`;
          statusEl.className = 'error-text';
        }
      }
    });
  </script>
</body>
</html>