<!-- /pages/nutrition.html -->
<!-- v3.0.0 ‚Äî –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ -->

<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü–∏—Ç–∞–Ω–∏–µ ‚Äî Morphe</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.json">

  <!-- –°—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/styles-shared.css">

  <style>
    .skip-link {
      position: absolute;
      top: -40px;
      left: 10px;
      background: #000;
      color: #fff;
      padding: 8px;
      text-decoration: none;
      z-index: 1000;
      transition: top 0.3s;
      border: 2px solid transparent;
    }
    .skip-link:focus {
      top: 10px;
      outline: 2px solid #fff;
    }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #eee;
      border-radius: 4px;
      margin: 8px 0 12px;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.5s ease;
    }
    .bar-fill.near-limit { background: #f39c12; }
    .bar-fill.over-limit { background: #e74c3c; }

    /* –°–µ—Ç–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 16px 0;
    }

    /* –ë–ª–æ–∫–∏ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ */
    .meal-plan {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .meal h3 {
      border-bottom: 2px solid var(--accent);
      padding-bottom: 8px;
      margin-bottom: 12px;
    }

    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
    .error-text { color: #e74c3c; font-weight: 500; }
    .success-text { color: #2ecc71; font-weight: 500; }
    .info-text { color: #3498db; font-weight: 500; }

    /* –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ */
    .food-search-container {
      margin: 24px 0;
      padding: 24px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
    }

    .food-search {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 16px;
    }

    .food-suggestions {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
      background: white;
    }

    .food-item {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    .food-item:hover {
      background: var(--bg-surface-alt);
    }

    .food-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin: 16px 0;
    }

    .meal-log {
      margin-top: 24px;
    }

    .meal-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--bg-surface-alt);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .remove-btn {
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    /* –ü—Ä–æ–≥–Ω–æ–∑ –≤–µ—Å–∞ */
    .forecast-card {
      border-left: 4px solid #3498db;
      background: var(--bg-surface-alt);
    }
    .trend-up { color: #2ecc71; }
    .trend-down { color: #e74c3c; }
  </style>
</head>
<body>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ —à–∞–ø–∫–∏ -->
  <div id="header-placeholder"></div>

  <main id="main-content" tabindex="-1">
    <div class="container">
      <h1>üçΩ –ü–∏—Ç–∞–Ω–∏–µ</h1>
      <p id="nutritionStatus">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>

      <div id="nutritionContent" style="display: none;">

        <!-- –ù–æ—Ä–º—ã -->
        <section class="card">
          <h2>üìä –í–∞—à–∏ –Ω–æ—Ä–º—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <h3>üî• –ö–∞–ª–æ—Ä–∏–∏</h3>
              <div class="progress-bar">
                <div id="caloriesBar" class="bar-fill" style="width: 0%"></div>
              </div>
              <p><strong><span id="caloriesEaten">0</span></strong> / <span id="caloriesTarget">‚Äî</span> –∫–∫–∞–ª</p>
            </div>
            <div class="stat-card">
              <h3>üçó –ë–µ–ª–∫–∏</h3>
              <div class="progress-bar">
                <div id="proteinBar" class="bar-fill" style="width: 0%"></div>
              </div>
              <p><strong><span id="proteinEaten">0</span></strong> / <span id="proteinTarget">‚Äî</span> –≥</p>
            </div>
            <div class="stat-card">
              <h3>ü•ë –ñ–∏—Ä—ã</h3>
              <div class="progress-bar">
                <div id="fatsBar" class="bar-fill" style="width: 0%"></div>
              </div>
              <p><strong><span id="fatsEaten">0</span></strong> / <span id="fatsTarget">‚Äî</span> –≥</p>
            </div>
            <div class="stat-card">
              <h3>üçö –£–≥–ª–µ–≤–æ–¥—ã</h3>
              <div class="progress-bar">
                <div id="carbsBar" class="bar-fill" style="width: 0%"></div>
              </div>
              <p><strong><span id="carbsEaten">0</span></strong> / <span id="carbsTarget">‚Äî</span> –≥</p>
            </div>
          </div>
        </section>

        <!-- –°–æ–≤–µ—Ç -->
        <section class="card">
          <h2>üí° –°–æ–≤–µ—Ç –¥–Ω—è</h2>
          <p id="dailyAdvice">‚Äî</p>
        </section>

        <!-- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ -->
        <section class="food-search-container">
          <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h2>
          <select id="mealSelect" class="food-search">
            <option value="breakfast">üåÖ –ó–∞–≤—Ç—Ä–∞–∫</option>
            <option value="lunch">üåû –û–±–µ–¥</option>
            <option value="dinner">üåô –£–∂–∏–Ω</option>
            <option value="snack">üç™ –ü–µ—Ä–µ–∫—É—Å</option>
          </select>
          <input type="text" id="foodSearch" class="food-search" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞...">
          <div id="foodSuggestions" class="food-suggestions"></div>
          <div id="selectedFoodDetails" style="display: none;">
            <h4>–°–∫–æ–ª—å–∫–æ –≥—Ä–∞–º–º?</h4>
            <input type="number" id="foodGrams" placeholder="100" min="1" step="1" class="food-search">
            <div class="food-details">
              <div>
                <p><strong>–ö–∞–ª–æ—Ä–∏–∏:</strong> <span id="foodCalories">‚Äî</span> –∫–∫–∞–ª/100–≥</p>
                <p><strong>–ë–µ–ª–∫–∏:</strong> <span id="foodProtein">‚Äî</span> –≥</p>
              </div>
              <div>
                <p><strong>–ñ–∏—Ä—ã:</strong> <span id="foodFats">‚Äî</span> –≥</p>
                <p><strong>–£–≥–ª–µ–≤–æ–¥—ã:</strong> <span id="foodCarbs">‚Äî</span> –≥</p>
              </div>
            </div>
            <button id="addFoodBtn" class="btn-primary btn-small" style="margin-top: 16px;">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫</button>
          </div>
        </section>

        <!-- ‚úÖ –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è -->
        <section class="card">
          <h2>üìã –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–Ω–µ–≤–Ω–∏–∫</h2>
          <div id="todayMealsLog">
            <div id="breakfastLog" class="meal-log">
              <h3>üåÖ –ó–∞–≤—Ç—Ä–∞–∫</h3>
              <div id="breakfastEntries"></div>
            </div>
            <div id="lunchLog" class="meal-log">
              <h3>üåû –û–±–µ–¥</h3>
              <div id="lunchEntries"></div>
            </div>
            <div id="dinnerLog" class="meal-log">
              <h3>üåô –£–∂–∏–Ω</h3>
              <div id="dinnerEntries"></div>
            </div>
            <div id="snackLog" class="meal-log">
              <h3>üç™ –ü–µ—Ä–µ–∫—É—Å</h3>
              <div id="snackEntries"></div>
            </div>
          </div>
        </section>

        <!-- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–µ–Ω—é -->
        <section class="card">
          <h2>üçΩ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ–Ω—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
          <p id="menuStatus">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ–Ω—é...</p>
          <div id="dailyMenu" style="display: none;">
            <div class="meal-plan">
              <div class="meal">
                <h3>üåÖ –ó–∞–≤—Ç—Ä–∞–∫</h3>
                <ul id="breakfastItems"></ul>
              </div>
              <div class="meal">
                <h3>üåû –û–±–µ–¥</h3>
                <ul id="lunchItems"></ul>
              </div>
              <div class="meal">
                <h3>üåô –£–∂–∏–Ω</h3>
                <ul id="dinnerItems"></ul>
              </div>
            </div>
            <div class="total-calories" style="margin-top: 16px; padding-top: 16px; border-top: 1px dashed #ccc;">
              <strong>–ò—Ç–æ–≥–æ: <span id="totalCalories">‚Äî</span> –∫–∫–∞–ª</strong>
              <br>
              <small>–¶–µ–ª—å: <span id="targetCalories">‚Äî</span> –∫–∫–∞–ª</small>
            </div>
          </div>
        </section>

        <!-- ‚úÖ –ü—Ä–æ–≥–Ω–æ–∑ –≤–µ—Å–∞ -->
        <section class="card forecast-card" id="weightForecastSection" style="display: none; margin-top: 24px;">
          <h2>üìà –ü—Ä–æ–≥–Ω–æ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Å–∞</h2>
          <p id="weightForecastText">‚Äî</p>
          <p><small>–†–∞—Å—Å—á–∏—Ç–∞–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–≥–æ —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –∫–∞–ª–æ—Ä–∏–π.</small></p>
        </section>

      </div>
    </div>
  </main>

  <!-- –ó–∞–≥–ª—É—à–∫–∞ –ø–æ–¥–≤–∞–ª–∞ -->
  <div id="footer-placeholder"></div>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ -->
  <script type="module">
    import { HeaderController } from '/core/HeaderController.js';
    import { ThemeManager } from '/core/themeManager.js';
    import { UserService } from '/services/userService.js';

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await HeaderController.loadHeader();
        new ThemeManager();

        const statusEl = document.getElementById('nutritionStatus');
        const contentEl = document.getElementById('nutritionContent');
        const forecastSection = document.getElementById('weightForecastSection');

        // === –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è ===
        if (!UserService.isProfileComplete()) {
          statusEl.textContent = "‚ùå –ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –Ω–æ—Ä–º—ã, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å.";
          statusEl.className = "error-text";
          return;
        }

        const plan = await UserService.getNutritionPlan();
        if (!plan) {
          statusEl.textContent = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è.";
          statusEl.className = "error-text";
          return;
        }

        // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–∫–µ—Ä–∞ ===
        const { NutritionTracker } = await import('../modules/nutritionTracker.js');
        const tracker = new NutritionTracker();

        // === –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ===
        let foods = [];
        try {
          const response = await fetch('/data/foods.json');
          foods = await response.json();
        } catch (err) {
          console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', err);
          foods = [
            { id: 'custom', name: '–ö–∞—Å—Ç–æ–º–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç', calories: 0, protein: 0, fats: 0, carbs: 0 }
          ];
        }

        // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ===
        const updateProgress = () => {
          const daily = tracker.getTotalMacrosToday();
          document.getElementById('caloriesEaten').textContent = Math.round(daily.calories);
          document.getElementById('proteinEaten').textContent = Math.round(daily.protein);
          document.getElementById('fatsEaten').textContent = Math.round(daily.fats);
          document.getElementById('carbsEaten').textContent = Math.round(daily.carbs);

          const updateBar = (value, max, barId) => {
            if (!max || max <= 0) return;
            const percent = Math.min(100, (value / max) * 100);
            const bar = document.getElementById(barId);
            bar.style.width = `${percent}%`;
            bar.className = 'bar-fill';
            if (percent >= 100) bar.classList.add('over-limit');
            else if (percent >= 80) bar.classList.add('near-limit');
          };

          updateBar(daily.calories, plan.target, 'caloriesBar');
          updateBar(daily.protein, plan.macros.protein, 'proteinBar');
          updateBar(daily.fats, plan.macros.fats, 'fatsBar');
          updateBar(daily.carbs, plan.macros.carbs, 'carbsBar');

          // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç
          let advice = plan.advice;
          if (daily.protein < plan.macros.protein * 0.7) {
            advice = "üçó –í–∞–º –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –±–µ–ª–∫–∞! –î–æ–±–∞–≤—å—Ç–µ —è–π—Ü–∞, —Ç–≤–æ—Ä–æ–≥ –∏–ª–∏ –∫—É—Ä–∏–Ω—É—é –≥—Ä—É–¥–∫—É.";
          } else if (daily.calories > plan.target * 1.1) {
            advice = "‚ö†Ô∏è –í—ã –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –∫–∞–ª–æ—Ä–∞–∂. –°–Ω–∏–∑—å—Ç–µ –ø–æ—Ä—Ü–∏–∏ —É–≥–ª–µ–≤–æ–¥–æ–≤.";
          } else if (daily.calories < plan.target * 0.8) {
            advice = "‚ö°Ô∏è –£ –≤–∞—Å –µ—Å—Ç—å –∑–∞–ø–∞—Å –∫–∞–ª–æ—Ä–∏–π ‚Äî –Ω–µ –≥–æ–ª–æ–¥–∞–π—Ç–µ!";
          }
          document.getElementById('dailyAdvice').textContent = advice;
        };

        // === –†–µ–Ω–¥–µ—Ä –ª–æ–≥–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è ===
        const renderTodayLog = () => {
          const meals = ['breakfast', 'lunch', 'dinner', 'snack'];
          meals.forEach(meal => {
            const entries = tracker.getTodayByMeal(meal);
            const container = document.getElementById(`${meal}Entries`);
            
            if (entries.length === 0) {
              container.innerHTML = '<p class="small-text">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
              return;
            }

            container.innerHTML = entries.map(entry => `
              <div class="meal-entry">
                <div>
                  <strong>${entry.name}</strong> (${entry.grams}–≥) ‚Ä¢ ${Math.round(entry.calories * entry.grams / 100)} –∫–∫–∞–ª
                </div>
                <button class="remove-btn" data-timestamp="${entry.timestamp}">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            `).join('');

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
            container.querySelectorAll('.remove-btn').forEach(btn => {
              btn.addEventListener('click', () => {
                tracker.remove(parseInt(btn.dataset.timestamp));
                renderTodayLog();
                updateProgress();
              });
            });
          });
        };

        // === –ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ===
        const foodSearch = document.getElementById('foodSearch');
        const foodSuggestions = document.getElementById('foodSuggestions');
        const selectedFoodDetails = document.getElementById('selectedFoodDetails');
        let selectedFood = null;

        foodSearch.addEventListener('input', () => {
          const term = foodSearch.value.toLowerCase();
          if (term.length < 2) {
            foodSuggestions.style.display = 'none';
            return;
          }

          const matches = foods.filter(f => f.name.toLowerCase().includes(term));
          foodSuggestions.innerHTML = matches.map(f => `
            <div class="food-item" data-id="${f.id}" data-name="${f.name}" data-cal="${f.calories}" data-pro="${f.protein}" data-fat="${f.fats}" data-carb="${f.carbs}">
              ${f.name} ‚Äî ${f.calories} –∫–∫–∞–ª
            </div>
          `).join('');

          foodSuggestions.style.display = matches.length > 0 ? 'block' : 'none';

          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞
          foodSuggestions.querySelectorAll('.food-item').forEach(item => {
            item.addEventListener('click', () => {
              selectedFood = {
                id: item.dataset.id,
                name: item.dataset.name,
                calories: parseFloat(item.dataset.cal),
                protein: parseFloat(item.dataset.pro),
                fats: parseFloat(item.dataset.fat),
                carbs: parseFloat(item.dataset.carb)
              };

              document.getElementById('foodCalories').textContent = selectedFood.calories;
              document.getElementById('foodProtein').textContent = selectedFood.protein;
              document.getElementById('foodFats').textContent = selectedFood.fats;
              document.getElementById('foodCarbs').textContent = selectedFood.carbs;

              foodSearch.value = selectedFood.name;
              foodSuggestions.style.display = 'none';
              selectedFoodDetails.style.display = 'block';
              document.getElementById('foodGrams').focus();
            });
          });
        });

        // === –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ ===
        document.getElementById('addFoodBtn').addEventListener('click', () => {
          if (!selectedFood) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç –∏–∑ —Å–ø–∏—Å–∫–∞');
            return;
          }

          const grams = parseFloat(document.getElementById('foodGrams').value);
          if (!grams || grams <= 0) {
            alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä–∞–º–º');
            return;
          }

          const mealType = document.getElementById('mealSelect').value;

          tracker.add(selectedFood, grams, mealType);

          // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
          foodSearch.value = '';
          selectedFoodDetails.style.display = 'none';
          selectedFood = null;
          document.getElementById('foodGrams').value = '';

          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
          renderTodayLog();
          updateProgress();

          // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          const status = document.createElement('div');
          status.className = 'success-text';
          status.textContent = '‚úÖ –ü—Ä–æ–¥—É–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω!';
          status.style.margin = '16px 0';
          document.querySelector('.food-search-container').appendChild(status);
          setTimeout(() => status.remove(), 3000);
        });

        // === –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–µ–Ω—é ===
        const menuStatus = document.getElementById('menuStatus');
        const dailyMenu = document.getElementById('dailyMenu');

        try {
          const { MenuGenerator } = await import('../core/menuGenerator.js');
          const generator = new MenuGenerator();
          const menu = await generator.generateMenu();

          if (menu && menu.breakfast && menu.lunch && menu.dinner) {
            const renderMealItems = (items, containerId) => {
              const container = document.getElementById(containerId);
              if (!container) return;
              container.innerHTML = items.map(i =>
                `<li>${i.name}: ${i.grams} –≥ (${Math.round(i.calories * i.grams / 100)} –∫–∫–∞–ª)</li>`
              ).join('');
            };

            renderMealItems(menu.breakfast.items, 'breakfastItems');
            renderMealItems(menu.lunch.items, 'lunchItems');
            renderMealItems(menu.dinner.items, 'dinnerItems');

            document.getElementById('totalCalories').textContent = menu.totalCalories || 0;
            document.getElementById('targetCalories').textContent = menu.targetCalories || plan.target;

            menuStatus.style.display = 'none';
            dailyMenu.style.display = 'block';
          }
        } catch (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–µ–Ω—é:', err);
          menuStatus.textContent = `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–µ–Ω—é: ${err.message}`;
          menuStatus.className = 'error-text';
        }

        // === –ü—Ä–æ–≥–Ω–æ–∑ –≤–µ—Å–∞ ===
        try {
          const daily = tracker.getTotalMacrosToday();
          const dailyBalance = daily.calories - plan.target;
          const totalDeficit = dailyBalance * 14;
          const weightChangeKg = totalDeficit / 7700;

          const forecastText = document.getElementById('weightForecastText');

          if (Math.abs(weightChangeKg) < 0.1) {
            forecastText.innerHTML = `‚Üí –ü—Ä–∏ —Ç–µ–∫—É—â–µ–º –ø–∏—Ç–∞–Ω–∏–∏ –≤–∞—à –≤–µ—Å –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω—ã–º.`;
          } else if (weightChangeKg < 0) {
            forecastText.innerHTML = `üìâ <strong class="trend-down">–ü—Ä–æ–≥–Ω–æ–∑: –ø–æ—Ç–µ—Ä—è ${Math.abs(weightChangeKg).toFixed(1)} –∫–≥ –∑–∞ 2 –Ω–µ–¥–µ–ª–∏</strong><br>–í—ã –≤ –¥–µ—Ñ–∏—Ü–∏—Ç–µ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!`;
          } else {
            forecastText.innerHTML = `üìà <strong class="trend-up">–ü—Ä–æ–≥–Ω–æ–∑: –Ω–∞–±–æ—Ä ${weightChangeKg.toFixed(1)} –∫–≥ –∑–∞ 2 –Ω–µ–¥–µ–ª–∏</strong><br>–í—ã –≤ –ø—Ä–æ—Ñ–∏—Ü–∏—Ç–µ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —Ü–µ–ª—å ‚Äî –Ω–∞–±–æ—Ä –º–∞—Å—Å—ã.`;
          }

          forecastSection.style.display = 'block';
        } catch (err) {
          console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –≤–µ—Å–∞:', err);
        }

        // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
        updateProgress();
        renderTodayLog();
        statusEl.style.display = 'none';
        contentEl.style.display = 'block';

      } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–∏—Ç–∞–Ω–∏—è:', err);
        const statusEl = document.getElementById('nutritionStatus');
        if (statusEl) {
          statusEl.textContent = `‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${err.message}`;
          statusEl.className = 'error-text';
        }
      }
    });
  </script>
</body>
</html>