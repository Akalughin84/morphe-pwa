<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Morphe ‚Äî –ü–∏—Ç–∞–Ω–∏–µ</title>
  <link rel="stylesheet" href="../styles.css" />
  <link rel="stylesheet" href="../styles-form.css" />
  <link rel="icon" href="../favicon.ico" />
  <meta name="description" content="–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø–∏—Ç–∞–Ω–∏–µ —Å Morphe ‚Äî AI-—Å–æ–≤–µ—Ç–Ω–∏–∫, –≥—Ä–∞—Ñ–∏–∫–∏, —à–∞–±–ª–æ–Ω—ã –±–ª—é–¥ –∏ —É–¥–æ–±–Ω—ã–π –ª–æ–≥." />

  <!-- Open Graph -->
  <meta property="og:title" content="Morphe ‚Äî –ü–∏—Ç–∞–Ω–∏–µ" />
  <meta property="og:description" content="–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø–∏—Ç–∞–Ω–∏–µ —Å Morphe ‚Äî AI-—Å–æ–≤–µ—Ç–Ω–∏–∫, –≥—Ä–∞—Ñ–∏–∫–∏, —à–∞–±–ª–æ–Ω—ã –±–ª—é–¥ –∏ —É–¥–æ–±–Ω—ã–π –ª–æ–≥." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://–≤–∞—à—Å–∞–π—Ç.—Ä—É/pages/nutrition.html" />
  <meta property="og:image" content="https://–≤–∞—à—Å–∞–π—Ç.—Ä—É/logo-og.png" />

  <!-- Chart.js (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω URL) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header class="page-header">
    <div class="container">
      <a href="../index.html" class="logo-link">
        <div class="logo">Morphe</div>
      </a>

      <button id="menuToggle" class="menu-toggle" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é" aria-expanded="false">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <nav id="mainNav" class="page-nav">
        <a href="../pages/profile.html" class="nav-link">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
        <a href="../pages/workouts.html" class="nav-link">üí™ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</a>
        <a href="../pages/progress.html" class="nav-link">üìà –ü—Ä–æ–≥—Ä–µ—Å—Å</a>
        <a href="../pages/supplements.html" class="nav-link">üíä –í–∏—Ç–∞–º–∏–Ω—ã</a>
        <a href="../pages/premium.html" class="nav-link">üíé Pro</a>
      </nav>
    </div>
  </header>

  <main class="nutrition-page">
    <div class="container">
      <h1>üçΩ –¢–≤–æ—ë –ø–∏—Ç–∞–Ω–∏–µ</h1>

      <!-- –¶–µ–ª–∏ –ø–æ –ë–ñ–£ -->
      <div class="macros-box">
        <h3>üéØ –¶–µ–ª—å: <span id="targetCalories">...</span> –∫–∫–∞–ª</h3>
        <div class="calories-progress" style="margin: 1rem 0; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden;">
          <div id="caloriesProgressFill" style="height: 100%; width: 0%; background: #FF6F00; transition: width 0.5s ease;"></div>
        </div>
        <p><strong>–ë–µ–ª–∫–∏:</strong> <span id="targetProtein">...</span> –≥</p>
        <p><strong>–ñ–∏—Ä—ã:</strong> <span id="targetFat">...</span> –≥</p>
        <p><strong>–£–≥–ª–µ–≤–æ–¥—ã:</strong> <span id="targetCarbs">...</span> –≥</p>
      </div>

      <!-- AI-–°–æ–≤–µ—Ç–Ω–∏–∫ -->
      <div class="ai-advice-panel">
        <h3>ü§ñ Morphe AI: –ê–Ω–∞–ª–∏–∑ –ø–∏—Ç–∞–Ω–∏—è</h3>
        <div id="aiAdvice" aria-live="polite">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–≤–æ–π —Ä–∞—Ü–∏–æ–Ω...</div>
      </div>

      <!-- –ü–æ–∏—Å–∫ –∏ –≤–≤–æ–¥ -->
      <div class="form-container">
        <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—ë–º –ø–∏—â–∏</h3>
        
        <div class="form-group">
          <label for="foodSearch">–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–∞</label>
          <input type="text" id="foodSearch" placeholder="–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤..." autocomplete="off">
          <select id="foodSelect" size="6" aria-label="–°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤"></select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="amountInput">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–≥)</label>
            <input type="number" id="amountInput" placeholder="100" min="1" step="1">
          </div>
          <div class="form-actions">
            <button id="btnAddFood" class="btn-secondary">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button id="btnLoadTemplate" class="btn-accent">üìã –®–∞–±–ª–æ–Ω</button>
          </div>
        </div>
      </div>

      <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
      <div id="currentMeal" style="margin: 2rem 0; padding: 1rem; background: #f0f0f0; border-radius: 12px;">
        <p>–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</p>
      </div>

      <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
      <div class="quick-actions">
        <button id="btnCopyYesterday" class="btn-small">üîÅ –í—á–µ—Ä–∞</button>
        <button id="btnShoppingList" class="btn-small">üõí –ü–æ–∫—É–ø–∫–∏</button>
        <button id="btnProteinChart" class="btn-small">üìä –ì—Ä–∞—Ñ–∏–∫</button>
        <button id="btnClearMeal" class="btn-small" style="background: #f44336; color: white;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>

      <!-- –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –ø—Ä–∏—ë–º—ã -->
      <div id="mealLog">
        <p>–°–µ–≥–æ–¥–Ω—è –µ—â—ë –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫ –±–µ–ª–∫–∞ -->
      <div class="chart-box" id="proteinChartBox" style="display:none; margin-top: 40px;">
        <h2>üìä –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –±–µ–ª–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é</h2>
        <canvas id="proteinChart" height="100" aria-label="–ì—Ä–∞—Ñ–∏–∫ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –±–µ–ª–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é"></canvas>
        <div id="proteinChartTable" style="margin-top: 1rem; font-size: 0.9rem; display: none;" aria-hidden="true">
          <!-- –¢–∞–±–ª–∏—Ü–∞ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ JS –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ -->
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { MorpheProfile } from '../modules/profile.js';
    import { NutritionEngine } from '../core/nutritionEngine.js';
    import { NutritionAdvisor } from '../core/nutritionAdvisor.js';
    import { MenuGenerator } from '../core/menuGenerator.js';

    let proteinChart = null;
    let currentMealItems = [];
    let debounceTimeout;

    try {
      const profile = new MorpheProfile();
      const engine = new NutritionEngine(profile.data);
      const aiAdviceEl = document.getElementById('aiAdvice');

      if (!profile.isComplete()) {
        document.body.innerHTML = `
          <div class="container" style="padding: 4rem 2rem; text-align: center;">
            <h2>üîí –î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</h2>
            <p>–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø–∏—Ç–∞–Ω–∏–µ, —Å–Ω–∞—á–∞–ª–∞ <a href="../pages/profile.html">–∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</a>.</p>
          </div>`;
        throw new Error("–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω");
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
      document.getElementById('foodSearch').placeholder = "–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤...";
      await engine.loadFoods();
      engine.loadLog();
      document.getElementById('foodSearch').placeholder = "–û–≤—Å—è–Ω–∫–∞, –∫—É—Ä–∏—Ü–∞, —Ç–≤–æ—Ä–æ–≥...";

      initUI();
      renderTargets();
      renderCurrentMeal();
      renderMealLog();
      showAIAdvice();

      // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ ===
      function initUI() {
        const select = document.getElementById('foodSelect');
        const search = document.getElementById('foodSearch');

        updateFoodList();

        search.addEventListener('input', () => {
          clearTimeout(debounceTimeout);
          debounceTimeout = setTimeout(() => {
            filterFoodList(search.value);
          }, 300);
        });

        // Enter –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
        search.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            addFoodItem();
          }
        });

        document.getElementById('amountInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            addFoodItem();
          }
        });

        // –ö–Ω–æ–ø–∫–∏ —á–µ—Ä–µ–∑ addEventListener
        document.getElementById('btnAddFood').addEventListener('click', addFoodItem);
        document.getElementById('btnLoadTemplate').addEventListener('click', loadMealTemplate);
        document.getElementById('btnCopyYesterday').addEventListener('click', copyYesterday);
        document.getElementById('btnShoppingList').addEventListener('click', showShoppingList);
        document.getElementById('btnProteinChart').addEventListener('click', showProteinChart);
        document.getElementById('btnClearMeal').addEventListener('click', clearCurrentMeal);

        // === –ì–ï–ù–ï–†–ê–¶–ò–Ø –ú–ï–ù–Æ ===
        const menuGenerator = new MenuGenerator(
          profile.data, 
          engine.foods, 
          { nutritionLog: engine.dailyLog }
        );

        generateDailyMenu();

        function generateDailyMenu() {
          try {
            const menu = menuGenerator.generate();

            const container = document.createElement('div');
            container.className = 'ai-advice-panel';
            container.innerHTML = `
              <h3>üçΩ –¢–≤–æ—ë –º–µ–Ω—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
              <p><strong>–ó–∞–≤—Ç—Ä–∞–∫:</strong> ${formatMeal(menu.breakfast)}</p>
              <p><strong>–û–±–µ–¥:</strong> ${formatMeal(menu.lunch)}</p>
              <p><strong>–£–∂–∏–Ω:</strong> ${formatMeal(menu.dinner)}</p>
              <p><small>üí° –≠—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ —Ç–≤–æ–∏—Ö —Ü–µ–ª—è—Ö –∏ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∫–∞–ª–æ—Ä–∏—è—Ö.</small></p>
            `;

            aiAdviceEl.parentNode.insertBefore(container, aiAdviceEl);
          } catch (e) {
            console.error("Failed to generate menu:", e);
          }
        }

        function formatMeal(meal) {
          return meal.items.map(item => {
            const food = engine.getFood(item.foodId);
            return food ? `${Math.round(item.amount)} –≥ ${food.name}` : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç';
          }).join(', ');
        }
      }

      function filterFoodList(query) {
        const select = document.getElementById('foodSelect');
        select.innerHTML = '';
        const lowerQuery = query.toLowerCase().trim();

        if (!lowerQuery) {
          updateFoodList();
          return;
        }

        const filtered = engine.foods.filter(food =>
          food.name.toLowerCase().includes(lowerQuery) ||
          food.id.toLowerCase().includes(lowerQuery)
        );

        if (filtered.length === 0) {
          const option = document.createElement('option');
          option.textContent = '‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
          option.disabled = true;
          select.appendChild(option);
        } else {
          filtered.forEach(food => {
            const option = document.createElement('option');
            option.value = food.id;
            option.textContent = `${food.name} (${food.calories} –∫–∫–∞–ª/100–≥)`;
            select.appendChild(option);
          });
        }
      }

      function updateFoodList() {
        const select = document.getElementById('foodSelect');
        select.innerHTML = '';
        
        engine.foods.forEach(food => {
          const option = document.createElement('option');
          option.value = food.id;
          option.textContent = `${food.name} (${food.calories} –∫–∫–∞–ª/100–≥)`;
          select.appendChild(option);
        });
      }

      function addFoodItem() {
        const foodId = document.getElementById('foodSelect').value;
        const amount = parseFloat(document.getElementById('amountInput').value);

        if (!foodId || isNaN(amount) || amount <= 0) {
          alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç –∏ —É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–±–æ–ª—å—à–µ 0)");
          return;
        }

        const food = engine.getFood(foodId);
        if (!food) {
          alert("–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ");
          return;
        }

        currentMealItems.push({ foodId, amount });
        document.getElementById('amountInput').value = '';
        renderCurrentMeal();
      }

      function loadMealTemplate() {
        const mealId = prompt(
          "–í–≤–µ–¥–∏—Ç–µ ID —à–∞–±–ª–æ–Ω–∞:\n" +
          "oat_banana ‚Äî –û–≤—Å—è–Ω–∫–∞ —Å –±–∞–Ω–∞–Ω–æ–º\n" +
          "chicken_rice ‚Äî –ö—É—Ä–∏—Ü–∞ —Å –≥—Ä–µ—á–∫–æ–π"
        );

        if (!mealId) return;

        const meal = engine.getMeal(mealId);
        if (!meal) {
          alert("–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω");
          return;
        }

        meal.items.forEach(item => {
          currentMealItems.push({ foodId: item.foodId, amount: item.amount });
        });

        renderCurrentMeal();
        alert(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –±–ª—é–¥–æ: ${meal.name}`);
      }

      function copyYesterday() {
        const today = new Date().toISOString().split('T')[0];
        const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
        
        const meals = engine.dailyLog.filter(m => m.date === yesterday);
        if (meals.length === 0) {
          alert("–í—á–µ—Ä–∞ –Ω–µ –±—ã–ª–æ –∑–∞–ø–∏—Å–µ–π.");
          return;
        }

        if (confirm("–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—á–µ—Ä–∞—à–Ω–∏–π —Ä–∞—Ü–∏–æ–Ω?")) {
          meals.forEach(meal => {
            engine.addMeal(meal.items);
          });
          renderMealLog();
          alert("‚úÖ –í—á–µ—Ä–∞—à–Ω–∏–π —Ä–∞—Ü–∏–æ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
        }
      }

      function showShoppingList() {
        const list = engine.generateShoppingList();
        if (list.length === 0) {
          alert("üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –ø—É—Å—Ç");
        } else {
          alert("üõí –í–∞–º —Å—Ç–æ–∏—Ç –∫—É–ø–∏—Ç—å:\n\n" + list.join("\n"));
        }
      }

      function clearCurrentMeal() {
        if (currentMealItems.length === 0) return;
        if (confirm("–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–∏—ë–º –ø–∏—â–∏?")) {
          currentMealItems = [];
          renderCurrentMeal();
        }
      }

      function saveMeal() {
        if (currentMealItems.length === 0) return;

        const entry = engine.addMeal(currentMealItems);
        currentMealItems = [];
        renderCurrentMeal();
        renderMealLog();
        updateProgress();
        playBeep();
        alert(`‚úÖ –ü—Ä–∏—ë–º –ø–∏—â–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω: ${Math.round(entry.totals.calories)} –∫–∫–∞–ª`);
      }

      function renderTargets() {
        const tdee = engine.calculateTDEE();
        const macros = engine.calculateMacros(tdee);

        document.getElementById('targetCalories').textContent = Math.round(macros.calories);
        document.getElementById('targetProtein').textContent = Math.round(macros.protein);
        document.getElementById('targetFat').textContent = Math.round(macros.fat);
        document.getElementById('targetCarbs').textContent = Math.round(macros.carbs);
      }

      function renderCurrentMeal() {
        const container = document.getElementById('currentMeal');
        if (currentMealItems.length === 0) {
          container.innerHTML = "<p>–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</p>";
          return;
        }

        const totals = { c: 0, p: 0, f: 0, cr: 0 };
        const list = currentMealItems.map(item => {
          const food = engine.getFood(item.foodId);
          if (!food) return ''; // –∑–∞—â–∏—Ç–∞
          const mult = item.amount / 100;
          totals.c += food.calories * mult;
          totals.p += food.protein * mult;
          totals.f += food.fat * mult;
          totals.cr += food.carbs * mult;
          return `<li>${food.name}: ${item.amount} –≥</li>`;
        }).filter(Boolean).join('');

        container.innerHTML = `
          <ul>${list}</ul>
          <p><strong>–ò—Ç–æ–≥–æ:</strong> ${totals.c.toFixed(0)} –∫–∫–∞–ª, 
          –ë: ${totals.p.toFixed(1)} –≥, 
          –ñ: ${totals.f.toFixed(1)} –≥, 
          –£: ${totals.cr.toFixed(1)} –≥</p>
          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button id="btnSaveMeal" class="btn-primary">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏—ë–º –ø–∏—â–∏</button>
            <button id="btnClearMealInline" class="btn-small" style="background: #f44336; color: white;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
        `;

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
        document.getElementById('btnSaveMeal')?.addEventListener('click', saveMeal);
        document.getElementById('btnClearMealInline')?.addEventListener('click', clearCurrentMeal);
      }

      function renderMealLog() {
        const container = document.getElementById('mealLog');
        const today = new Date().toLocaleDateString('sv'); // YYYY-MM-DD
        const todayMeals = engine.dailyLog.filter(m => m.date === today);

        if (todayMeals.length === 0) {
          container.innerHTML = '<p>–°–µ–≥–æ–¥–Ω—è –µ—â—ë –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
          updateProgressUI(0, 0);
          return;
        }

        const dailyTotal = engine.getDailyTotal();
        const targetCalories = parseInt(document.getElementById('targetCalories').textContent);

        container.innerHTML = `
          <h3>üìã –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏</h3>
          ${todayMeals.map(meal => `
            <div class="meal-card">
              <small>${formatTime(meal.time)}</small>
              <ul>${meal.items.map(i => {
                const f = engine.getFood(i.foodId);
                if (!f) return `<li>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç (${i.foodId}) ‚Äî ${i.amount} –≥</li>`;
                return `<li>${f.name} ‚Äî ${i.amount} –≥</li>`;
              }).join('')}</ul>
              <p><em>üî• ${meal.totals.calories.toFixed(0)} –∫–∫–∞–ª</em></p>
            </div>
          `).join('')}
          
          <div class="macros-box" style="margin-top: 2rem;">
            <h3>üìä –ò—Ç–æ–≥–æ –∑–∞ –¥–µ–Ω—å: ${dailyTotal.calories.toFixed(0)} –∏–∑ ${targetCalories} –∫–∫–∞–ª</h3>
            <div class="calories-progress" style="margin: 1rem 0; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden;">
              <div id="caloriesProgressFillLog" style="height: 100%; background: #4CAF50; transition: width 0.5s ease;"></div>
            </div>
            <p>–ë–µ–ª–∫–∏: ${dailyTotal.protein.toFixed(1)} –≥</p>
            <p>–ñ–∏—Ä—ã: ${dailyTotal.fat.toFixed(1)} –≥</p>
            <p>–£–≥–ª–µ–≤–æ–¥—ã: ${dailyTotal.carbs.toFixed(1)} –≥</p>
          </div>
        `;

        updateProgressUI(dailyTotal.calories, targetCalories);
      }

      function updateProgressUI(current, target) {
        const pct = target > 0 ? Math.min(100, (current / target) * 100) : 0;
        const fill1 = document.getElementById('caloriesProgressFill');
        const fill2 = document.getElementById('caloriesProgressFillLog');
        if (fill1) fill1.style.width = `${pct}%`;
        if (fill2) fill2.style.width = `${pct}%`;
      }

      function formatTime(isoTime) {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –≤—Ä–µ–º–µ–Ω–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:mm:ss
        const [hours, minutes] = isoTime.split(':');
        const date = new Date();
        date.setHours(hours, minutes, 0);
        return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      }

      // === –ì–†–ê–§–ò–ö –ë–ï–õ–ö–ê ===
      function showProteinChart() {
        const box = document.getElementById('proteinChartBox');
        if (box.style.display === 'block') {
          box.style.display = 'none';
          return;
        }

        const history = engine.getWeeklyProteinHistory();
        if (!history || history.length === 0) {
          alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –Ω–µ–¥–µ–ª—é.");
          return;
        }

        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç {x: –¥–∞—Ç–∞, y: –∑–Ω–∞—á–µ–Ω–∏–µ}
        const chartData = history.map((val, i) => {
          const date = new Date();
          date.setDate(date.getDate() - (6 - i));
          return {
            x: date.toISOString().split('T')[0],
            y: typeof val === 'number' ? val : val.y
          };
        });

        const ctx = document.getElementById('proteinChart').getContext('2d');
        if (proteinChart) proteinChart.destroy();

        proteinChart = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [{
              label: '–ë–µ–ª–∫–∏ (–≥)',
               chartData,
              borderColor: '#FF6F00',
              backgroundColor: 'rgba(255,111,0,0.1)',
              fill: true,
              tension: 0.4,
              pointRadius: 5
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              legend: { display: false },
              tooltip: {
                callbacks: {
                  title: (context) => {
                    const date = new Date(context[0].parsed.x);
                    return date.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });
                  },
                  label: (context) => `–ë–µ–ª–∫–∏: ${context.parsed.y} –≥`
                }
              }
            },
            scales: {
              x: { 
                type: 'time',
                time: { 
                  unit: 'day', 
                  tooltipFormat: 'dd MMM yyyy',
                  displayFormats: { day: 'dd MMM' }
                },
                title: { display: true, text: '–î–∞—Ç–∞' },
                adapters: {
                  date: {
                    locale: 'ru-RU'
                  }
                }
              },
              y: { 
                title: { display: true, text: '–ì—Ä–∞–º–º—ã' }, 
                beginAtZero: true,
                suggestedMin: 0
              }
            }
          }
        });

        // –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É
        const tableContainer = document.getElementById('proteinChartTable');
        tableContainer.style.display = 'block';
        tableContainer.innerHTML = `
          <h4>–î–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞ (–¥–ª—è —ç–∫—Ä–∞–Ω–Ω—ã—Ö —á–∏—Ç–∞–ª–æ–∫):</h4>
          <table aria-hidden="false">
            <thead>
              <tr><th>–î–∞—Ç–∞</th><th>–ë–µ–ª–∫–∏ (–≥)</th></tr>
            </thead>
            <tbody>
              ${chartData.map(item => {
                const date = new Date(item.x);
                return `<tr><td>${date.toLocaleDateString('ru-RU')}</td><td>${item.y} –≥</td></tr>`;
              }).join('')}
            </tbody>
          </table>
        `;

        box.style.display = 'block';
      }

      // === AI-—Å–æ–≤–µ—Ç—ã ===
      function showAIAdvice() {
        const advisor = new NutritionAdvisor(profile.data, {
          nutritionLog: engine.dailyLog,
          workouts: [],
          weightTrend: 'stable',
          hydration: { avg: 2.5 },
          eatsFishRegularly: false
        });

        const tips = advisor.getAdvice();
        if (!tips || tips.length === 0) {
          aiAdviceEl.innerHTML = "–ù–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.";
          return;
        }

        const randomTip = tips[Math.floor(Math.random() * tips.length)];

        aiAdviceEl.innerHTML = `
          <div class="advice-item advice-${randomTip.type || 'info'}">
            ${randomTip.text}
          </div>
        `;
      }

      // === –ì–∞–º–±—É—Ä–≥–µ—Ä-–º–µ–Ω—é ===
      const menuToggle = document.getElementById('menuToggle');
      const mainNav = document.getElementById('mainNav');

      if (menuToggle && mainNav) {
        menuToggle.addEventListener('click', () => {
          const isActive = mainNav.classList.toggle('active');
          menuToggle.classList.toggle('active', isActive);
          menuToggle.setAttribute('aria-expanded', isActive);
        });

        document.querySelectorAll('.page-nav a').forEach(link => {
          link.addEventListener('click', () => {
            menuToggle.classList.remove('active');
            mainNav.classList.remove('active');
            menuToggle.setAttribute('aria-expanded', 'false');
          });
        });

        document.addEventListener('click', (e) => {
          if (!mainNav.contains(e.target) && !menuToggle.contains(e.target)) {
            menuToggle.classList.remove('active');
            mainNav.classList.remove('active');
            menuToggle.setAttribute('aria-expanded', 'false');
          }
        });
      }

      // === –£—Ç–∏–ª–∏—Ç—ã ===
      function playBeep() {
        try {
          const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioCtx.createOscillator();
          const gainNode = audioCtx.createGain();
          oscillator.connect(gainNode);
          gainNode.connect(audioCtx.destination);
          oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
          gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
          oscillator.start(audioCtx.currentTime);
          oscillator.stop(audioCtx.currentTime + 0.5);
        } catch (e) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫:", e);
        }
      }

    } catch (error) {
      console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:", error);
      document.body.innerHTML = `
        <div class="container" style="padding: 4rem 2rem; text-align: center; color: #d32f2f;">
          <h2>‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h2>
          <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥—É–ª—å –ø–∏—Ç–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –∑–∞–π—Ç–∏ –ø–æ–∑–∂–µ.</p>
          <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem;">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      `;
    }
  </script>
</body>
</html>